<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAATHII CSS MIS (v2.0)</title>

    <!-- PWA Manifest (Inline - GAS doesn't serve static files) -->
    <script>
        const manifestData = { "name": "SAATHII CSS MIS", "short_name": "CSS MIS", "description": "SAATHII CSS Management Information System", "start_url": "/", "display": "standalone", "background_color": "#FDFDFD", "theme_color": "#ad1457", "orientation": "any", "icons": [{ "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%23ad1457'/%3E%3Cstop offset='100%25' stop-color='%23081a58'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='192' height='192' fill='url(%23g)'/%3E%3Cpath fill='white' d='M48 96h96v12H48zm24-24h48v12H72zm12 48h24v12H84z'/%3E%3C/svg%3E", "sizes": "192x192", "type": "image/svg+xml", "purpose": "any maskable" }, { "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%23ad1457'/%3E%3Cstop offset='100%25' stop-color='%23081a58'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' fill='url(%23g)'/%3E%3Cpath fill='white' d='M128 256h256v32H128zm64-64h128v32H192zm32 128h64v32h-64z'/%3E%3C/svg%3E", "sizes": "512x512", "type": "image/svg+xml", "purpose": "any maskable" }] };
        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>
    <meta name="theme-color" content="#ad1457">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CSS MIS">

    <!-- React Stack -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#ad1457',   /* Pink/Red */
                        secondary: '#081a58', /* Navy Blue */
                        accent: '#00ffff',    /* Cyan */
                        danger: '#d61c4e',    /* Red */
                        success: '#28a745',   /* Green */
                        surface: '#ffffff',
                        background: '#FDFDFD',
                        border: '#cbd5e1'
                    }
                }
            }
        }
    </script>

    <!-- Custom Styles -->
    <style data-optimized="true">*{margin: 0;padding: 0;box-sizing: border-box}:root{--color-primary: #1CD4D3;--color-primary-dark: #17b3b2;--color-secondary: #293462;--color-secondary-dark: #1e2749;--color-accent: #ad1457;--color-accent-dark: #8b1045;--gray-50: #f9fafb;--gray-100: #f3f4f6;--gray-200: #e5e7eb;--gray-300: #d1d5db;--gray-400: #9ca3af;--gray-500: #6b7280;--gray-600: #4b5563;--gray-700: #374151;--gray-800: #1f2937;--gray-900: #111827;--color-success: #10b981;--color-warning: #f59e0b;--color-error: #ef4444;--color-info: #3b82f6;--spacing-1: 0.25rem;--spacing-2: 0.5rem;--spacing-3: 0.75rem;--spacing-4: 1rem;--spacing-5: 1.25rem;--spacing-6: 1.5rem;--spacing-8: 2rem;--spacing-10: 2.5rem;--spacing-12: 3rem;--font-body: 'Inter',system-ui,-apple-system,sans-serif;--font-heading: 'Inter',system-ui,-apple-system,sans-serif;--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);--shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);--shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);--shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);--shadow-glass: 0 8px 32px 0 rgba(31,38,135,0.37);--glass-bg: rgba(255,255,255,0.7);--glass-border: rgba(255,255,255,0.4);--glass-blur: blur(12px);--radius-sm: 0.25rem;--radius-md: 0.375rem;--radius-lg: 0.5rem;--radius-xl: 0.75rem;--radius-2xl: 1rem;--radius-full: 9999px;--transition-fast: 150ms ease;--transition-base: 200ms ease;--transition-slow: 300ms ease}body{font-family: var(--font-body);background-color: #f1f5f9;color: var(--gray-900);line-height: 1.5;-webkit-font-smoothing: antialiased;-moz-osx-font-smoothing: grayscale}.container{width: 100%;max-width: 1280px;margin: 0 auto;padding: 0 var(--spacing-4)}.flex{display: flex}.inline-flex{display: inline-flex}.grid{display: grid}.hidden{display: none}.block{display: block}.inline-block{display: inline-block}.flex-row{flex-direction: row}.flex-col{flex-direction: column}.flex-wrap{flex-wrap: wrap}.flex-nowrap{flex-wrap: nowrap}.justify-start{justify-content: flex-start}.justify-center{justify-content: center}.justify-end{justify-content: flex-end}.justify-between{justify-content: space-between}.justify-around{justify-content: space-around}.items-start{align-items: flex-start}.items-center{align-items: center}.items-end{align-items: flex-end}.items-stretch{align-items: stretch}.gap-1{gap: var(--spacing-1)}.gap-2{gap: var(--spacing-2)}.gap-3{gap: var(--spacing-3)}.gap-4{gap: var(--spacing-4)}.gap-5{gap: var(--spacing-5)}.gap-6{gap: var(--spacing-6)}.gap-8{gap: var(--spacing-8)}.flex-1{flex: 1 1 0%}.flex-auto{flex: 1 1 auto}.flex-none{flex: none}.shrink-0{flex-shrink: 0}.m-0{margin: 0}.m-1{margin: var(--spacing-1)}.m-2{margin: var(--spacing-2)}.m-3{margin: var(--spacing-3)}.m-4{margin: var(--spacing-4)}.m-auto{margin: auto}.mx-auto{margin-left: auto;margin-right: auto}.my-2{margin-top: var(--spacing-2);margin-bottom: var(--spacing-2)}.my-4{margin-top: var(--spacing-4);margin-bottom: var(--spacing-4)}.mt-1{margin-top: var(--spacing-1)}.mt-2{margin-top: var(--spacing-2)}.mt-4{margin-top: var(--spacing-4)}.mb-2{margin-bottom: var(--spacing-2)}.mb-4{margin-bottom: var(--spacing-4)}.mb-6{margin-bottom: var(--spacing-6)}.ml-2{margin-left: var(--spacing-2)}.mr-2{margin-right: var(--spacing-2)}.p-0{padding: 0}.p-2{padding: var(--spacing-2)}.p-3{padding: var(--spacing-3)}.p-4{padding: var(--spacing-4)}.p-6{padding: var(--spacing-6)}.p-8{padding: var(--spacing-8)}.px-2{padding-left: var(--spacing-2);padding-right: var(--spacing-2)}.px-3{padding-left: var(--spacing-3);padding-right: var(--spacing-3)}.px-4{padding-left: var(--spacing-4);padding-right: var(--spacing-4)}.px-6{padding-left: var(--spacing-6);padding-right: var(--spacing-6)}.py-1{padding-top: var(--spacing-1);padding-bottom: var(--spacing-1)}.py-2{padding-top: var(--spacing-2);padding-bottom: var(--spacing-2)}.py-3{padding-top: var(--spacing-3);padding-bottom: var(--spacing-3)}.py-4{padding-top: var(--spacing-4);padding-bottom: var(--spacing-4)}.text-xs{font-size: 0.75rem;line-height: 1rem}.text-sm{font-size: 0.875rem;line-height: 1.25rem}.text-base{font-size: 1rem;line-height: 1.5rem}.text-lg{font-size: 1.125rem;line-height: 1.75rem}.text-xl{font-size: 1.25rem;line-height: 1.75rem}.text-2xl{font-size: 1.5rem;line-height: 2rem}.text-3xl{font-size: 1.875rem;line-height: 2.25rem}.text-4xl{font-size: 2.25rem;line-height: 2.5rem}.font-normal{font-weight: 400}.font-medium{font-weight: 500}.font-semibold{font-weight: 600}.font-bold{font-weight: 700}.text-left{text-align: left}.text-center{text-align: center}.text-right{text-align: right}.text-white{color: #ffffff}.text-gray-400{color: var(--gray-400)}.text-gray-500{color: var(--gray-500)}.text-gray-600{color: var(--gray-600)}.text-gray-700{color: var(--gray-700)}.text-gray-800{color: var(--gray-800)}.text-gray-900{color: var(--gray-900)}.text-primary{color: var(--color-primary)}.text-secondary{color: var(--color-secondary)}.text-red-600{color: #dc2626}.text-green-600{color: #16a34a}.text-blue-600{color: #2563eb}.uppercase{text-transform: uppercase}.lowercase{text-transform: lowercase}.capitalize{text-transform: capitalize}.truncate{overflow: hidden;text-overflow: ellipsis;white-space: nowrap}.bg-white{background-color: #ffffff}.bg-gray-50{background-color: var(--gray-50)}.bg-gray-100{background-color: var(--gray-100)}.bg-gray-200{background-color: var(--gray-200)}.bg-primary{background-color: var(--color-primary)}.bg-secondary{background-color: var(--color-secondary)}.bg-accent{background-color: var(--color-accent)}.bg-blue-50{background-color: #eff6ff}.bg-blue-100{background-color: #dbeafe}.bg-blue-500{background-color: #3b82f6}.bg-green-50{background-color: #f0fdf4}.bg-red-50{background-color: #fef2f2}.bg-red-500{background-color: #ef4444}.border{border: 1px solid var(--gray-200)}.border-0{border: 0}.border-2{border-width: 2px}.border-t{border-top: 1px solid var(--gray-200)}.border-b{border-bottom: 1px solid var(--gray-200)}.border-l{border-left: 1px solid var(--gray-200)}.border-r{border-right: 1px solid var(--gray-200)}.border-gray-200{border-color: var(--gray-200)}.border-gray-300{border-color: var(--gray-300)}.border-primary{border-color: var(--color-primary)}.rounded-none{border-radius: 0}.rounded-sm{border-radius: var(--radius-sm)}.rounded{border-radius: var(--radius-md)}.rounded-md{border-radius: var(--radius-md)}.rounded-lg{border-radius: var(--radius-lg)}.rounded-xl{border-radius: var(--radius-xl)}.rounded-full{border-radius: var(--radius-full)}.w-3{width: 0.75rem}.w-4{width: 1rem}.w-5{width: 1.25rem}.w-6{width: 1.5rem}.w-8{width: 2rem}.w-10{width: 2.5rem}.w-12{width: 3rem}.w-16{width: 4rem}.w-20{width: 5rem}.w-24{width: 6rem}.w-32{width: 8rem}.w-48{width: 12rem}.w-64{width: 16rem}.w-full{width: 100%}.w-screen{width: 100vw}.w-auto{width: auto}.min-w-0{min-width: 0}.max-w-xs{max-width: 20rem}.max-w-sm{max-width: 24rem}.max-w-md{max-width: 28rem}.max-w-lg{max-width: 32rem}.max-w-xl{max-width: 36rem}.max-w-2xl{max-width: 42rem}.max-w-full{max-width: 100%}.h-3{height: 0.75rem}.h-4{height: 1rem}.h-5{height: 1.25rem}.h-6{height: 1.5rem}.h-8{height: 2rem}.h-10{height: 2.5rem}.h-12{height: 3rem}.h-16{height: 4rem}.h-10{height: 2.5rem}.h-12{height: 3rem}.h-full{height: 100%}.h-screen{height: 100vh}.min-h-screen{min-height: 100vh}.max-h-96{max-height: 24rem}.max-h-screen{max-height: 100vh}.relative{position: relative}.absolute{position: absolute}.fixed{position: fixed}.sticky{position: sticky}.top-0{top: 0}.right-0{right: 0}.bottom-0{bottom: 0}.left-0{left: 0}.inset-0{top: 0;right: 0;bottom: 0;left: 0}.z-0{z-index: 0}.z-10{z-index: 10}.z-20{z-index: 20}.z-30{z-index: 30}.z-40{z-index: 40}.z-50{z-index: 50}.shadow-none{box-shadow: none}.shadow-sm{box-shadow: var(--shadow-sm)}.shadow{box-shadow: var(--shadow-md)}.shadow-md{box-shadow: var(--shadow-md)}.shadow-lg{box-shadow: var(--shadow-lg)}.shadow-xl{box-shadow: var(--shadow-xl)}.opacity-0{opacity: 0}.opacity-50{opacity: 0.5}.opacity-75{opacity: 0.75}.opacity-100{opacity: 1}.transition{transition-property: all;transition-duration: var(--transition-base)}.transition-colors{transition-property: background-color,border-color,color,fill,stroke;transition-duration: var(--transition-base)}.transition-opacity{transition-property: opacity;transition-duration: var(--transition-base)}.transition-transform{transition-property: transform;transition-duration: var(--transition-base)}.duration-150{transition-duration: 150ms}.duration-200{transition-duration: 200ms}.duration-300{transition-duration: 300ms}.overflow-hidden{overflow: hidden}.overflow-auto{overflow: auto}.overflow-scroll{overflow: scroll}.overflow-x-auto{overflow-x: auto}.overflow-y-auto{overflow-y: auto}.cursor-pointer{cursor: pointer}.cursor-not-allowed{cursor: not-allowed}.cursor-default{cursor: default}.select-none{user-select: none}.pointer-events-none{pointer-events: none}.btn{display: inline-flex;align-items: center;justify-content: center;padding: var(--spacing-2) var(--spacing-4);font-size: 0.875rem;font-weight: 500;border-radius: var(--radius-md);transition: all var(--transition-base);cursor: pointer;border: none;outline: none}.btn-primary{background-color: var(--color-primary);color: white}.btn-primary:hover{background-color: var(--color-primary-dark)}.btn-secondary{background-color: var(--color-secondary);color: white}.btn-secondary:hover{background-color: var(--color-secondary-dark)}.btn-outline{background-color: transparent;border: 1px solid var(--gray-300);color: var(--gray-700)}.btn-outline:hover{background-color: var(--gray-50)}.btn-sm{padding: var(--spacing-1) var(--spacing-3);font-size: 0.75rem}.btn-lg{padding: var(--spacing-3) var(--spacing-6);font-size: 1rem}.input{display: block;width: 100%;padding: var(--spacing-2) var(--spacing-3);font-size: 0.875rem;border: 1px solid var(--gray-300);border-radius: var(--radius-md);background-color: white;transition: border-color var(--transition-base)}.input:focus{outline: none;border-color: var(--color-primary);box-shadow: 0 0 0 3px rgba(28,212,211,0.1)}.input:disabled{background-color: var(--gray-100);cursor: not-allowed}.label{display: block;margin-bottom: var(--spacing-2);font-size: 0.875rem;font-weight: 500;color: var(--gray-700)}.card{background-color: white;border-radius: var(--radius-lg);box-shadow: var(--shadow-md);padding: var(--spacing-6)}.table{width: 100%;border-collapse: collapse}.table th{padding: var(--spacing-3) var(--spacing-4);text-align: left;font-weight: 600;color: var(--gray-700);background-color: var(--gray-50);border-bottom: 2px solid var(--gray-200)}.table td{padding: var(--spacing-3) var(--spacing-4);border-bottom: 1px solid var(--gray-100)}.table tbody tr:hover{background-color: var(--gray-50)}.hover\:bg-gray-100:hover{background-color: var(--gray-100)}.hover\:bg-blue-50:hover{background-color: #eff6ff}.hover\:text-primary:hover{color: var(--color-primary)}.hover\:shadow-lg:hover{box-shadow: var(--shadow-lg)}@media (min-width: 640px){.sm\:flex{display: flex}.sm\:hidden{display: none}.sm\:w-64{width: 16rem}}@media (min-width: 768px){.md\:flex{display: flex}.md\:hidden{display: none}.md\:w-72{width: 18rem}.md\:grid-cols-2{grid-template-columns: repeat(2,minmax(0,1fr))}}@media (min-width: 1024px){.lg\:flex{display: flex}.lg\:w-80{width: 20rem}.lg\:grid-cols-3{grid-template-columns: repeat(3,minmax(0,1fr))}}.sr-only{position: absolute;width: 1px;height: 1px;padding: 0;margin: -1px;overflow: hidden;clip: rect(0,0,0,0);white-space: nowrap;border-width: 0}.clearfix::after{content: "";display: table;clear: both}::-webkit-scrollbar{width: 6px;height: 6px}::-webkit-scrollbar-track{background-color: var(--gray-100)}::-webkit-scrollbar-thumb{background-color: var(--gray-400);border-radius: var(--radius-full)}::-webkit-scrollbar-thumb:hover{background-color: var(--gray-500)}@keyframes spin{to{transform: rotate(360deg)}}@keyframes ping{75%,100%{transform: scale(2);opacity: 0}}@keyframes pulse{0%,100%{opacity: 1}50%{opacity: 0.5}}@keyframes bounce{0%,100%{transform: translateY(-25%);animation-timing-function: cubic-bezier(0.8,0,1,1)}50%{transform: translateY(0);animation-timing-function: cubic-bezier(0,0,0.2,1)}}.animate-spin{animation: spin 1s linear infinite}.animate-ping{animation: ping 1s cubic-bezier(0,0,0.2,1) infinite}.animate-pulse{animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite}.animate-bounce{animation: bounce 1s infinite}@keyframes slideInRight{from{transform: translateX(100%);opacity: 0}to{transform: translateX(0);opacity: 1}}@keyframes fadeOut{from{opacity: 1}to{opacity: 0}}@keyframes shake{0%,100%{transform: translateX(0)}10%,30%,50%,70%,90%{transform: translateX(-2px);border-color: var(--color-error)}20%,40%,60%,80%{transform: translateX(2px)}}.animate-slide-in-right{animation: slideInRight 0.3s ease-out forwards}.animate-fade-out{animation: fadeOut 0.3s ease-in forwards}.animate-shake{animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both}.glass{background: var(--glass-bg);backdrop-filter: var(--glass-blur);-webkit-backdrop-filter: var(--glass-blur);border: 1px solid var(--glass-border);box-shadow: var(--shadow-glass)}</style>

    <style data-optimized="true">body{font-family: 'Inter',system-ui,-apple-system,sans-serif;background-color: #f1f5f9}@media (max-width: 768px){html{font-size: 14px}.text-xs{font-size: 0.75rem !important}.text-sm{font-size: 0.85rem !important}.text-base{font-size: 0.95rem !important}}::-webkit-scrollbar{width: 6px;height: 6px}::-webkit-scrollbar-track{background: transparent}::-webkit-scrollbar-thumb{background: #cbd5e1;border-radius: 3px}::-webkit-scrollbar-thumb:hover{background: #94a3b8}.loader{border-top-color: #293462;animation: spinner 1s linear infinite}@keyframes spinner{0%{transform: rotate(0deg)}100%{transform: rotate(360deg)}}.skeleton{background: linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size: 200% 100%;animation: skeleton-loading 1.5s infinite}@keyframes skeleton-loading{0%{background-position: 200% 0}100%{background-position: -200% 0}}.header-clamp{display: -webkit-box;-webkit-line-clamp: 2;line-clamp: 2;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;max-height: 2.5em;line-height: 1.2;word-break: break-word}table{font-size: 0.675rem !important}table thead th{padding: 0.5rem 1rem !important;font-size: 0.675rem !important;vertical-align: middle !important}table tbody td{padding: 0.275rem 1rem !important;font-size: 0.80rem !important;line-height: 1}.sidebar-transition{transition: width 0.3s ease-in-out}@keyframes slide-down{from{transform: translateY(-100%);opacity: 0}to{transform: translateY(0);opacity: 1}}.animate-slide-down{animation: slide-down 0.3s ease-out forwards}</style>

    <!-- Performance Optimizations -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" as="script">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" as="script">
    
    <!-- Compression and caching hints -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  

    <script>
    if (typeof google === 'undefined') {
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwfTq-pshf0H_uLe3-3Coykx1qhF57x0hBqaScCEAswofznE-907VMc-d988_aO86svRA/exec";
        
        // --- Batched RPC Implementation ---
        let rpcQueue = [];
        let rpcTimer = null;

        function flushRPCQueue() {
            if (rpcQueue.length === 0) return;
            
            const currentQueue = [...rpcQueue];
            rpcQueue = [];
            
            fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({
                    rpc: true,
                    function: 'batchRPC',
                    args: [currentQueue.map(q => ({ function: q.function, args: q.args }))]
                })
            })
            .then(res => res.json())
            .then(data => {
                console.log('[GAS Proxy] Response:', data);
                if (data.success && data.results) {
                    data.results.forEach((res, i) => {
                        const original = currentQueue[i];
                        if (res.success) {
                            if (typeof original.success === 'function') original.success(res.data);
                        } else {
                            if (typeof original.failure === 'function') original.failure(new Error(res.error));
                        }
                    });
                } else {
                    throw new Error(data.error || 'Batch RPC Failed');
                }
            })
            .catch(err => {
                currentQueue.forEach(q => {
                    if (typeof q.failure === 'function') q.failure(err);
                });
            });
        }

        function queueRPC(fnName, args, success, failure) {
            rpcQueue.push({ function: fnName, args, success, failure });
            if (rpcTimer) clearTimeout(rpcTimer);
            rpcTimer = setTimeout(flushRPCQueue, 50); // 50ms window for batching
        }

        window.google = {
            script: {
                run: {
                    withSuccessHandler: function(success) {
                        return {
                            withFailureHandler: function(failure) {
                                return new Proxy({}, {
                                    get: function(target, prop) {
                                        return function(...args) {
                                            queueRPC(prop, args, success, failure);
                                        }
                                    }
                                });
                            }
                        }
                    }
                }
            }
        };
    }
    </script>
        
</head>

<body>
    <div id="root"></div>

    <!-- Inject Dashboard Component -->
    <style data-optimized="true">.dash-container{padding: 2rem;max-width: 1200px;margin: 0 auto}.dash-header{margin-bottom: 2rem}.dash-header h2{font-size: 1.75rem;font-weight: 700;color: #293462}.dash-grid{display: grid;grid-template-columns: repeat(auto-fill,minmax(224px,1fr));gap: 1.2rem}.dash-card{background: #ffffff;border-radius: 10px;padding: 0.6rem;box-shadow: 0 1px 2px rgba(0,0,0,0.05);border: 1px solid #e2e8f0;transition: transform 0.2s,box-shadow 0.2s,border-color 0.2s;display: flex;flex-direction: column;justify-content: space-between}.dash-card:hover{transform: translateY(-4px);box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);border-color: #1CD4D3}.dash-card-title{font-size: 0.6rem;font-weight: 600;color: #ffffff;text-transform: uppercase;letter-spacing: 0.05em;margin-bottom: 0.4rem}.dash-card-value{font-size: 1.2rem;font-weight: 800;color: #ffffff}.dash-card-footer{margin-top: 0.8rem;padding-top: 0.8rem;border-top: 1px solid #f1f5f9;text-align: right}.dash-btn{font-size: 0.7rem;color: #1CD4D3;font-weight: 500;cursor: pointer}.dash-btn:hover{text-decoration: underline}.skeleton{background: #e2e8f0;border-radius: 4px;animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite}@keyframes pulse{0%,100%{opacity: 1}50%{opacity: .5}}</style>

<script>
  const MetricsPopup = ({
    data,
    onClose
  }) => {
    if (!data) return null;
    const states = Object.entries(data.stateCounts || {}).sort((a, b) => b[1] - a[1]);
    return React.createElement("div", {
      className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in",
      onClick: onClose
    }, React.createElement("div", {
      className: "bg-white rounded-lg shadow-xl w-full max-w-sm m-4 overflow-hidden",
      onClick: e => e.stopPropagation()
    }, React.createElement("div", {
      className: "bg-primary text-white p-4 flex justify-between items-center"
    }, React.createElement("h3", {
      className: "font-bold"
    }, data.title, " - State Wise"), React.createElement("button", {
      onClick: onClose,
      className: "hover:text-red-200"
    }, React.createElement(Icon, {
      name: "x"
    }))), React.createElement("div", {
      className: "p-4 max-h-[60vh] overflow-y-auto"
    }, React.createElement("table", {
      className: "w-full text-sm"
    }, React.createElement("thead", {
      className: "bg-gray-50 text-gray-500 font-bold border-b"
    }, React.createElement("tr", null, React.createElement("th", {
      className: "text-left py-2 px-3"
    }, "State"), React.createElement("th", {
      className: "text-right py-2 px-3"
    }, "Count"))), React.createElement("tbody", null, states.length === 0 ? React.createElement("tr", null, React.createElement("td", {
      colSpan: "2",
      className: "text-center py-4 text-gray-400"
    }, "No data available")) : states.map(([st, cnt]) => React.createElement("tr", {
      key: st,
      className: "border-b last:border-0 hover:bg-gray-50"
    }, React.createElement("td", {
      className: "py-2 px-3 text-gray-700"
    }, st), React.createElement("td", {
      className: "py-2 px-3 text-right font-mono font-medium text-primary"
    }, cnt.toLocaleString())))), React.createElement("tfoot", {
      className: "font-bold border-t bg-gray-50"
    }, React.createElement("tr", null, React.createElement("td", {
      className: "py-2 px-3"
    }, "Total"), React.createElement("td", {
      className: "py-2 px-3 text-right"
    }, data.count.toLocaleString())))))));
  };
  const CARD_COLORS = ['#ad1457', '#081a58'];

  const DashboardComponent = ({
    user,
    navigateToTab,
    initialData
  }) => {
    const [metrics, setMetrics] = React.useState(initialData?.dashboard || []);
    const [loading, setLoading] = React.useState(!initialData?.dashboard);
    const [error, setError] = React.useState(null);
    const [activePopup, setActivePopup] = React.useState(null);
    const [typologyData, setTypologyData] = React.useState(initialData?.typology || []);
    const [typologyLoading, setTypologyLoading] = React.useState(false);

    React.useEffect(() => {
      if (initialData?.dashboard) {
        setLoading(false);
        return;
      }
      let isMounted = true;
      google.script.run.withSuccessHandler(res => {
        if (isMounted) {
          if (res.success) setMetrics(res.metrics); else setError(res.error);
          setLoading(false);
        }
      }).withFailureHandler(err => {
        if (isMounted) {
          setError(err.message);
          setLoading(false);
        }
      }).getDashboardSummary(user);
      return () => {
        isMounted = false;
      };
    }, [user, initialData]);

    React.useEffect(() => {
      if (initialData?.typology) return;
      setTypologyLoading(true);
      google.script.run.withSuccessHandler(res => {
        if (res.success) setTypologyData(res.data || []);
        setTypologyLoading(false);
      }).withFailureHandler(() => {
        setTypologyLoading(false);
      }).getTypologyBreakdown(user);
    }, [user, initialData]);
    if (loading) {
      return React.createElement("div", {
        className: "dash-container animate-pulse"
      }, React.createElement("div", {
        className: "dash-header"
      }, React.createElement("div", {
        className: "h-8 w-48 bg-gray-200 rounded"
      })), React.createElement("div", {
        className: "dash-grid"
      }, [1, 2, 3, 4].map(i => React.createElement(window.SkeletonCard, { key: i }))));
    }
    if (error) {
      return React.createElement("div", {
        className: "dash-container"
      }, React.createElement("div", {
        className: "bg-red-50 border border-red-200 text-red-700 p-4 rounded"
      }, React.createElement("strong", null, "Error:"), " ", error));
    }
    return React.createElement("div", {
      className: "dash-container"
    }, React.createElement("div", {
      className: "dash-header"
    }, React.createElement("h2", null, "Program Overview"), React.createElement("p", {
      className: "text-gray-500"
    }, "Welcome back, ", user.name)), React.createElement("div", {
      className: "dash-grid mb-8"
    }, metrics.map((item, index) => {
      const bgColor = CARD_COLORS[index % CARD_COLORS.length];
      return React.createElement("div", {
        key: index,
        className: `dash-card border-l-4`,
        style: {
          background: index % 2 === 0
            ? 'linear-gradient(135deg, #ad1457 0%, #d81b60 100%)'
            : 'linear-gradient(135deg, #081a58 0%, #1565c0 100%)',
          borderColor: 'rgba(255,255,255,0.1)'
        }
      }, React.createElement("div", null, React.createElement("div", {
        className: `dash-card-title text-white font-extrabold opacity-100`
      }, item.title), React.createElement("div", {
        className: "flex justify-between items-end"
      }, React.createElement("div", {
        className: "dash-card-value"
      }, item.error ? React.createElement("span", {
        className: "text-sm text-red-400"
      }, "Error") : item.count.toLocaleString()), !item.error && React.createElement("button", {
        onClick: () => setActivePopup(item),
        className: "text-xs font-bold text-primary bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded mb-2 transition"
      }, "\uD83D\uDCCD View by State"))), React.createElement("div", {
        className: "dash-card-footer flex justify-between items-center"
      }, React.createElement("span", {
        className: "text-xs text-white/70"
      }, "Last Sync: Live"), navigateToTab && React.createElement("span", {
        className: "dash-btn flex items-center gap-1 cursor-pointer hover:text-white font-bold text-white",
        onClick: (e) => {
          e.stopPropagation();
          const idx = user.accessRights.findIndex(r => r.datasheet.toLowerCase() === item.sheet.toLowerCase());
          if (idx !== -1) navigateToTab(idx);
          else console.error('Tab not found for sheet:', item.sheet);
        }
      }, "View Data ", React.createElement(Icon, {
        name: "arrowRight",
        className: "w-3 h-3"
      }))));
    }), metrics.length === 0 && React.createElement("div", {
      className: "col-span-full text-center text-gray-500 py-10 bg-white rounded border border-dashed"
    }, "No datasheets available.")), metrics.length > 0 && React.createElement("div", {
      className: "bg-white rounded-lg shadow p-4 border border-gray-200 inline-block min-w-[400px]"
    }, React.createElement("h3", {
      className: "font-bold text-sm text-primary mb-2"
    }, "Typology-wise CC"), typologyLoading ? React.createElement("div", {
      className: "text-center py-8"
    }, React.createElement("div", {
      className: "inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"
    }), React.createElement("p", {
      className: "text-gray-400 mt-2 text-sm"
    }, "Loading typology data...")) : typologyData.length === 0 ? React.createElement("div", {
      className: "text-center text-gray-400 py-8 italic bg-gray-50 rounded border border-dashed text-sm"
    }, "No typology data available") : React.createElement("div", {
      className: "overflow-x-auto"
    }, React.createElement("table", {
      className: "w-full text-xs"
    }, React.createElement("thead", {
      className: "bg-gradient-to-r from-primary to-secondary text-white"
    }, React.createElement("tr", null, React.createElement("th", {
      className: "text-left py-1.5 px-3 font-bold uppercase tracking-wider"
    }, "Typology"), React.createElement("th", {
      className: "text-right py-1.5 px-3 font-bold uppercase tracking-wider"
    }, "Count"), React.createElement("th", {
      className: "text-right py-1.5 px-3 font-bold uppercase tracking-wider"
    }, "Percentage"))), React.createElement("tbody", {
      className: "divide-y divide-gray-200"
    }, typologyData.map((item, idx) => {
      const total = typologyData.reduce((sum, d) => sum + d.count, 0);
      const percentage = total > 0 ? (item.count / total * 100).toFixed(1) : 0;
      return React.createElement("tr", {
        key: idx,
        className: "hover:bg-accent/20 even:bg-slate-50/70"
      }, React.createElement("td", {
        className: "py-1.5 px-3 text-gray-700 font-medium"
      }, item.typology), React.createElement("td", {
        className: "py-1.5 px-3 text-right font-mono text-primary font-bold"
      }, item.count.toLocaleString()), React.createElement("td", {
        className: "py-1.5 px-3 text-right text-gray-600"
      }, percentage, "%"));
    })), React.createElement("tfoot", {
      className: "bg-gray-50 font-bold border-t-2 border-primary"
    }, React.createElement("tr", null, React.createElement("td", {
      className: "py-1.5 px-3"
    }, "Total"), React.createElement("td", {
      className: "py-1.5 px-3 text-right"
    }, typologyData.reduce((sum, d) => sum + d.count, 0).toLocaleString()), React.createElement("td", {
      className: "py-1.5 px-3 text-right"
    }, "100%")))))), activePopup && React.createElement(MetricsPopup, {
      data: activePopup,
      onClose: () => setActivePopup(null)
    }));
  };
  window.DashboardComponent = DashboardComponent;
</script>
    <script>
  const UsersAdmin = () => {
    const {
      addAlert
    } = React.useContext(AlertContext);
    const [users, setUsers] = React.useState([]);
    const [loading, setLoading] = React.useState(false);
    const [mode, setMode] = React.useState('list');
    const [editingUser, setEditingUser] = React.useState(null);
    const fetchUsers = async () => {
      setLoading(true);
      try {
        const res = await server.getAllUsers_Admin();
        if (res.success) setUsers(res.users); else addAlert(res.error, 'error');
      } catch (e) {
        addAlert(e.message, 'error');
      } finally {
        setLoading(false);
      }
    };
    React.useEffect(() => {
      fetchUsers();
    }, []);
    const handleSave = async userData => {
      setLoading(true);
      try {
        const res = await server.saveUser_Admin(userData);
        if (res.success) {
          addAlert(res.message, 'success');
          setMode('list');
          fetchUsers();
        } else {
          addAlert(res.error, 'error');
        }
      } catch (e) {
        addAlert(e.message, 'error');
      } finally {
        setLoading(false);
      }
    };
    const handleDelete = async username => {
      if (!confirm(`Delete user ${username}?`)) return;
      setLoading(true);
      try {
        const res = await server.deleteUser_Admin(username);
        if (res.success) {
          addAlert(res.message, 'success');
          fetchUsers();
        } else addAlert(res.error, 'error');
      } catch (e) {
        addAlert(e.message, 'error');
      } finally {
        setLoading(false);
      }
    };
    const UserForm = ({
      user,
      onSave,
      onCancel
    }) => {
      const [formData, setFormData] = React.useState(user || {
        username: '',
        password: '',
        name: '',
        designation: '',
        usertype: 'user',
        state: '',
        sr: '',
        access: []
      });
      const [availableSchemas, setAvailableSchemas] = React.useState([]);
      React.useEffect(() => {
        const loadSchemas = async () => {
          try {
            const res = await server.getAllSchemas();
            const unique = [];
            const seen = new Set();
            res.forEach(r => {
              if (r.schema && !seen.has(r.schema)) {
                seen.add(r.schema);
                unique.push(r);
              }
            });
            setAvailableSchemas(unique);
          } catch (e) {
            console.error("Schema fetch error", e);
          }
        };
        loadSchemas();
      }, []);
      const addAccessRow = () => {
        setFormData(p => ({
          ...p,
          access: [...(p.access || []), {
            datasheet: '',
            datasheettitle: '',
            schematitle: '',
            schema: '',
            edit: 'no',
            delete: 'no'
          }]
        }));
      };
      const removeAccessRow = index => {
        setFormData(p => ({
          ...p,
          access: p.access.filter((_, i) => i !== index)
        }));
      };
      const updateAccessRow = (index, field, value) => {
        const newAccess = [...(formData.access || [])];
        newAccess[index] = {
          ...newAccess[index],
          [field]: value
        };
        setFormData({
          ...formData,
          access: newAccess
        });
      };
      const handleSchemaSelect = (index, schemaName) => {
        if (!schemaName) return;
        const found = availableSchemas.find(s => s.schema === schemaName);
        if (found) {
          const newAccess = [...(formData.access || [])];
          newAccess[index] = {
            ...newAccess[index],
            schema: found.schema,
            datasheet: found.datasheet,
            datasheettitle: found.title || found.datasheet,
            schematitle: found.schemaTitle || found.schema,
            edit: 'no',
            delete: 'no'
          };
          setFormData({
            ...formData,
            access: newAccess
          });
        }
      };
      return React.createElement("div", {
        className: "fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-2 backdrop-blur-sm"
      }, React.createElement("div", {
        className: "bg-white rounded shadow-xl w-full max-w-5xl max-h-[90vh] flex flex-col animate-fade-in text-sm"
      }, React.createElement("div", {
        className: "p-3 border-b bg-primary text-white flex justify-between items-center text-sm font-bold shadow-sm"
      }, React.createElement("h3", null, user ? 'Edit User' : 'Add User'), React.createElement("button", {
        onClick: onCancel,
        className: "hover:text-red-300"
      }, React.createElement(Icon, {
        name: "close",
        className: "w-4 h-4"
      }))), React.createElement("div", {
        className: "flex-1 overflow-y-auto p-4 space-y-4"
      }, React.createElement("div", {
        className: "grid grid-cols-1 md:grid-cols-4 gap-3 bg-gray-50 p-4 rounded border"
      }, React.createElement("div", null, React.createElement("label", {
        className: "block text-xs font-bold text-gray-500 mb-1"
      }, "Username/Email"), " ", React.createElement("input", {
        className: "w-full p-1.5 border rounded text-xs bg-white",
        value: formData.username,
        onChange: e => setFormData({
          ...formData,
          username: e.target.value
        }),
        disabled: !!user
      })), React.createElement("div", null, React.createElement("label", {
        className: "block text-xs font-bold text-gray-500 mb-1"
      }, "Password"), " ", React.createElement("input", {
        className: "w-full p-1.5 border rounded text-xs bg-white",
        value: formData.password,
        onChange: e => setFormData({
          ...formData,
          password: e.target.value
        })
      })), React.createElement("div", {
        className: "md:col-span-2"
      }, React.createElement("label", {
        className: "block text-xs font-bold text-gray-500 mb-1"
      }, "Full Name"), " ", React.createElement("input", {
        className: "w-full p-1.5 border rounded text-xs bg-white",
        value: formData.name,
        onChange: e => setFormData({
          ...formData,
          name: e.target.value
        })
      })), React.createElement("div", null, React.createElement("label", {
        className: "block text-xs font-bold text-gray-500 mb-1"
      }, "Designation"), " ", React.createElement("input", {
        className: "w-full p-1.5 border rounded text-xs bg-white",
        value: formData.designation,
        onChange: e => setFormData({
          ...formData,
          designation: e.target.value
        })
      })), React.createElement("div", null, React.createElement("label", {
        className: "block text-xs font-bold text-gray-500 mb-1"
      }, "Role"), React.createElement("select", {
        className: "w-full p-1.5 border rounded text-xs bg-white",
        value: formData.usertype,
        onChange: e => setFormData({
          ...formData,
          usertype: e.target.value
        })
      }, React.createElement("option", {
        value: "user"
      }, "User"), React.createElement("option", {
        value: "sradmin"
      }, "SR Admin"), React.createElement("option", {
        value: "superadmin"
      }, "Super Admin"))), React.createElement("div", null, React.createElement("label", {
        className: "block text-xs font-bold text-gray-500 mb-1"
      }, "SR Code"), " ", React.createElement("input", {
        className: "w-full p-1.5 border rounded text-xs bg-white",
        value: formData.sr,
        onChange: e => setFormData({
          ...formData,
          sr: e.target.value
        })
      })), React.createElement("div", {
        className: "md:col-span-4"
      }, React.createElement("label", {
        className: "block text-xs font-bold text-gray-500 mb-1"
      }, "States"), " ", React.createElement("input", {
        className: "w-full p-1.5 border rounded text-xs bg-white",
        value: formData.state,
        onChange: e => setFormData({
          ...formData,
          state: e.target.value
        }),
        placeholder: "e.g. MH, MP"
      }))), React.createElement("div", {
        className: "border-t pt-2"
      }, React.createElement("div", {
        className: "flex justify-between items-center mb-2"
      }, React.createElement("h4", {
        className: "font-bold text-gray-800 text-xs uppercase"
      }, "Access Rights"), React.createElement("button", {
        onClick: addAccessRow,
        className: "text-secondary text-xs font-bold flex items-center hover:underline bg-secondary/10 px-2 py-1 rounded"
      }, React.createElement(Icon, {
        name: "plus",
        className: "w-3 h-3 mr-1"
      }), " Add")), React.createElement("div", {
        className: "overflow-x-auto border rounded bg-white"
      }, React.createElement("table", {
        className: "min-w-full divide-y divide-gray-200 text-xs"
      }, React.createElement("thead", {
        className: "bg-gray-100"
      }, React.createElement("tr", null, React.createElement("th", {
        className: "px-2 py-1.5 text-left font-semibold text-gray-600"
      }, "Form (Quick Select)"), React.createElement("th", {
        className: "px-2 py-1.5 text-left font-semibold text-gray-600"
      }, "Title (Datasheet)"), React.createElement("th", {
        className: "px-2 py-1.5 text-left font-semibold text-gray-600"
      }, "Sheet (Table)"), React.createElement("th", {
        className: "px-2 py-1.5 text-left font-semibold text-gray-600"
      }, "Title (Schema)"), React.createElement("th", {
        className: "px-2 py-1.5 text-left font-semibold text-gray-600"
      }, "Schema ID"), React.createElement("th", {
        className: "px-2 py-1.5 text-center w-12 font-semibold text-gray-600"
      }, "Edit"), React.createElement("th", {
        className: "px-2 py-1.5 text-center w-12 font-semibold text-gray-600"
      }, "Del"), React.createElement("th", {
        className: "w-8"
      }))), React.createElement("tbody", {
        className: "divide-y divide-gray-200"
      }, (!formData.access || formData.access.length === 0) && React.createElement("tr", null, React.createElement("td", {
        colSpan: "7",
        className: "p-6 text-center text-gray-400 italic"
      }, "No access rights assigned. Click \"Add\" to grant access.")), (formData.access || []).map((acc, idx) => React.createElement("tr", {
        key: idx,
        className: "hover:bg-gray-50"
      }, React.createElement("td", {
        className: "p-1 w-40"
      }, React.createElement("select", {
        className: "w-full p-1 border rounded text-xs bg-yellow-50/50 focus:bg-white transition",
        onChange: e => handleSchemaSelect(idx, e.target.value),
        value: availableSchemas.find(s => s.schema === acc.schema) ? acc.schema : ''
      }, React.createElement("option", {
        value: ""
      }, "-- Custom --"), availableSchemas.map(s => React.createElement("option", {
        key: s.schema,
        value: s.schema
      }, s.schema)))), React.createElement("td", {
        className: "p-1"
      }, React.createElement("input", {
        className: "w-full p-1 border rounded text-xs font-bold text-gray-700",
        value: acc.datasheettitle,
        onChange: e => updateAccessRow(idx, 'datasheettitle', e.target.value),
        placeholder: "Display Title"
      })), React.createElement("td", {
        className: "p-1"
      }, React.createElement("input", {
        className: "w-full p-1 border rounded text-xs font-mono text-gray-500",
        value: acc.datasheet,
        onChange: e => updateAccessRow(idx, 'datasheet', e.target.value),
        placeholder: "Sheet Name"
      })), React.createElement("td", {
        className: "p-1"
      }, React.createElement("input", {
        className: "w-full p-1 border rounded text-xs text-gray-700",
        value: acc.schematitle,
        onChange: e => updateAccessRow(idx, 'schematitle', e.target.value),
        placeholder: "Form Title"
      })), React.createElement("td", {
        className: "p-1"
      }, React.createElement("input", {
        className: "w-full p-1 border rounded text-xs font-mono text-gray-500",
        value: acc.schema,
        onChange: e => updateAccessRow(idx, 'schema', e.target.value),
        placeholder: "Schema ID"
      })), React.createElement("td", {
        className: "p-1 text-center"
      }, React.createElement("select", {
        className: "p-1 border rounded text-xs w-full",
        value: acc.edit,
        onChange: e => updateAccessRow(idx, 'edit', e.target.value)
      }, React.createElement("option", {
        value: "no"
      }, "No"), React.createElement("option", {
        value: "allow"
      }, "Yes"))), React.createElement("td", {
        className: "p-1 text-center"
      }, React.createElement("select", {
        className: "p-1 border rounded text-xs w-full",
        value: acc.delete,
        onChange: e => updateAccessRow(idx, 'delete', e.target.value)
      }, React.createElement("option", {
        value: "no"
      }, "No"), React.createElement("option", {
        value: "allow"
      }, "Yes"))), React.createElement("td", {
        className: "p-1 text-center"
      }, React.createElement("button", {
        onClick: () => removeAccessRow(idx),
        className: "text-gray-300 hover:text-danger p-1"
      }, React.createElement(Icon, {
        name: "trash",
        className: "w-3.5 h-3.5"
      })))))))))), React.createElement("div", {
        className: "p-3 border-t bg-gray-50 flex justify-end gap-2 text-xs font-medium rounded-b"
      }, React.createElement("button", {
        onClick: onCancel,
        className: "px-3 py-1.5 border rounded text-gray-600 hover:bg-white hover:shadow-sm"
      }, "Cancel"), React.createElement("button", {
        onClick: () => onSave(formData),
        className: "px-3 py-1.5 bg-primary text-white rounded hover:bg-opacity-90 shadow-sm"
      }, "Save User"))));
    };
    const handleSync = async () => {
      setLoading(true);
      addAlert("Syncing to BigQuery...", "info");
      try {
        const res = await server.syncDataWeb();
        if (res.success) addAlert(res.message, 'success'); else addAlert(res.error, 'error');
      } catch (e) {
        addAlert(e.message, 'error');
      } finally {
        setLoading(false);
      }
    };
    return React.createElement("div", {
      className: "p-4 h-full flex flex-col"
    }, React.createElement("div", {
      className: "flex justify-between items-center mb-4 flex-shrink-0"
    }, React.createElement("h2", {
      className: "text-lg font-bold text-gray-800 flex items-center gap-2"
    }, React.createElement(Icon, {
      name: "users",
      className: "text-primary"
    }), " User Management"), React.createElement("div", {
      className: "flex gap-2"
    }, React.createElement("button", {
      onClick: handleSync,
      className: "flex items-center gap-1 bg-white text-gray-600 border px-3 py-1.5 rounded text-xs font-bold shadow-sm hover:bg-gray-50 transition",
      title: "Sync All Tables to BigQuery"
    }, React.createElement(Icon, {
      name: "refresh",
      className: "w-3 h-3"
    }), " Sync BQ"), React.createElement("button", {
      onClick: () => {
        setEditingUser(null);
        setMode('edit');
      },
      className: "flex items-center gap-1 bg-secondary text-white px-3 py-1.5 rounded text-xs font-bold shadow hover:opacity-90 transition"
    }, React.createElement(Icon, {
      name: "plus",
      className: "w-3 h-3"
    }), " Add"))), React.createElement("div", {
      className: "flex-1 bg-white rounded shadow border overflow-hidden flex flex-col"
    }, React.createElement("div", {
      className: "overflow-y-auto flex-1"
    }, React.createElement("table", {
      className: "min-w-full divide-y divide-gray-200"
    }, React.createElement("thead", {
      className: "bg-gradient-to-r from-primary to-secondary text-white sticky top-0 z-10 shadow-sm"
    }, React.createElement("tr", null, React.createElement("th", {
      className: "px-4 py-2 text-left text-xs font-bold text-white uppercase tracking-wider"
    }, "User"), React.createElement("th", {
      className: "px-4 py-2 text-left text-xs font-bold text-white uppercase tracking-wider"
    }, "Login"), React.createElement("th", {
      className: "px-4 py-2 text-left text-xs font-bold text-white uppercase tracking-wider"
    }, "Role"), React.createElement("th", {
      className: "px-4 py-2 text-left text-xs font-bold text-white uppercase tracking-wider"
    }, "Access"), React.createElement("th", {
      className: "px-4 py-2 text-right text-xs font-bold text-white uppercase tracking-wider"
    }, "Actions"))), React.createElement("tbody", {
      className: "bg-white divide-y divide-gray-100 text-sm"
    }, users.map(u => React.createElement("tr", {
      key: u.username,
      className: "hover:bg-accent/20 transition-colors"
    }, React.createElement("td", {
      className: "px-4 py-2.5 whitespace-nowrap"
    }, React.createElement("div", {
      className: "font-medium text-gray-900"
    }, u.name), React.createElement("div", {
      className: "text-[10px] text-gray-400"
    }, u.designation)), React.createElement("td", {
      className: "px-4 py-2.5 whitespace-nowrap text-gray-600 text-xs"
    }, u.username), React.createElement("td", {
      className: "px-4 py-2.5 whitespace-nowrap"
    }, React.createElement("span", {
      className: `px-2 py-0.5 inline-flex text-[10px] font-bold uppercase rounded-full tracking-wide ${u.usertype === 'superadmin' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}`
    }, u.usertype)), React.createElement("td", {
      className: "px-4 py-2.5 whitespace-nowrap text-xs text-gray-500"
    }, u.access ? u.access.length : 0, " sheets"), React.createElement("td", {
      className: "px-4 py-2.5 whitespace-nowrap text-right text-xs font-medium"
    }, React.createElement("button", {
      onClick: () => {
        setEditingUser(u);
        setMode('edit');
      },
      className: "text-secondary hover:text-blue-900 mr-3 font-semibold"
    }, "Edit"), React.createElement("button", {
      onClick: () => handleDelete(u.username),
      className: "text-red-400 hover:text-red-700"
    }, "Delete")))), users.length === 0 && !loading && React.createElement("tr", null, React.createElement("td", {
      colSpan: "5",
      className: "p-8 text-center text-gray-400 text-xs"
    }, "No users found.")))))), mode === 'edit' && React.createElement(UserForm, {
      user: editingUser,
      onSave: handleSave,
      onCancel: () => setMode('list')
    }));
  };
  window.AdminUsers = UsersAdmin;
</script>
    <script>
  const DropdownsAdmin = () => {
    const {
      addAlert
    } = React.useContext(AlertContext);
    const [dropdowns, setDropdowns] = React.useState({});
    const [activeCategory, setActiveCategory] = React.useState('');
    const [newValue, setNewValue] = React.useState('');
    const [loading, setLoading] = React.useState(false);
    const [showCatModal, setShowCatModal] = React.useState(false);
    const [catModalMode, setCatModalMode] = React.useState('add');
    const [catNameInput, setCatNameInput] = React.useState('');
    const fetchDropdowns = async () => {
      setLoading(true);
      try {
        const res = await server.getAllDropdowns_Admin();
        if (res.success) {
          setDropdowns(res.dropdowns);
          const keys = Object.keys(res.dropdowns);
          if (keys.length > 0) {
            if (!activeCategory || !keys.includes(activeCategory)) setActiveCategory(keys[0]);
          } else setActiveCategory('');
        } else addAlert(res.error, 'error');
      } catch (e) {
        addAlert(e.message, 'error');
      } finally {
        setLoading(false);
      }
    };
    React.useEffect(() => {
      fetchDropdowns();
    }, []);
    const handleAddOption = async e => {
      e.preventDefault();
      if (!newValue.trim()) return;
      setLoading(true);
      try {
        const res = await server.saveDropdownOption_Admin(activeCategory, newValue.trim(), 'add');
        if (res.success) {
          addAlert("Option added", "success");
          setNewValue('');
          fetchDropdowns();
        } else addAlert(res.error, 'error');
      } catch (e) {
        addAlert(e.message, 'error');
      } finally {
        setLoading(false);
      }
    };
    const handleDeleteOption = async val => {
      if (!confirm(`Delete option "${val}"?`)) return;
      setLoading(true);
      try {
        const res = await server.saveDropdownOption_Admin(activeCategory, val, 'delete');
        if (res.success) {
          addAlert("Option deleted", "success");
          fetchDropdowns();
        } else addAlert(res.error, 'error');
      } catch (e) {
        addAlert(e.message, 'error');
      } finally {
        setLoading(false);
      }
    };
    const handleCategorySubmit = async () => {
      if (!catNameInput.trim()) return;
      setLoading(true);
      try {
        let res;
        if (catModalMode === 'add') res = await server.manageDropdownCategory_Admin('add', catNameInput.trim()); else if (catModalMode === 'rename') res = await server.manageDropdownCategory_Admin('rename', activeCategory, catNameInput.trim());
        if (res && res.success) {
          addAlert(res.message, "success");
          setShowCatModal(false);
          setActiveCategory(catNameInput.trim());
          fetchDropdowns();
        } else addAlert(res.error, 'error');
      } catch (e) {
        addAlert(e.message, 'error');
      } finally {
        setLoading(false);
      }
    };
    const handleDeleteCategory = async () => {
      if (!confirm(`Delete category "${activeCategory}" and ALL its options?`)) return;
      setLoading(true);
      try {
        const res = await server.manageDropdownCategory_Admin('delete', activeCategory);
        if (res.success) {
          addAlert("Category deleted", "success");
          setActiveCategory('');
          fetchDropdowns();
        } else addAlert(res.error, 'error');
      } catch (e) {
        addAlert(e.message, 'error');
      } finally {
        setLoading(false);
      }
    };
    const categories = Object.keys(dropdowns);
    const handleSync = async () => {
      setLoading(true);
      addAlert("Syncing to BigQuery...", "info");
      try {
        const res = await server.syncDataWeb();
        if (res.success) addAlert(res.message, 'success'); else addAlert(res.error, 'error');
      } catch (e) {
        addAlert(e.message, 'error');
      } finally {
        setLoading(false);
      }
    };
    return React.createElement("div", {
      className: "p-4 h-full flex flex-col"
    }, React.createElement("div", {
      className: "flex justify-between items-center mb-4 flex-shrink-0"
    }, React.createElement("h2", {
      className: "text-lg font-bold text-gray-800 flex items-center gap-2"
    }, React.createElement(Icon, {
      name: "settings",
      className: "text-primary"
    }), " Dropdowns"), React.createElement("div", {
      className: "flex gap-2"
    }, React.createElement("button", {
      onClick: handleSync,
      className: "flex items-center gap-1 bg-white text-gray-600 border px-3 py-1.5 rounded text-xs font-bold shadow-sm hover:bg-gray-50 transition",
      title: "Sync All Tables to BigQuery"
    }, React.createElement(Icon, {
      name: "refresh",
      className: "w-3 h-3"
    }), " Sync BQ"), React.createElement("button", {
      onClick: () => {
        setCatModalMode('add');
        setCatNameInput('');
        setShowCatModal(true);
      },
      className: "bg-primary text-white px-3 py-1.5 rounded text-xs font-bold shadow hover:opacity-90 flex items-center gap-1 transition"
    }, React.createElement(Icon, {
      name: "plus",
      className: "w-3 h-3"
    }), " New Category"))), React.createElement("div", {
      className: "flex-1 bg-white rounded shadow border border-gray-200 flex flex-col md:flex-row overflow-hidden"
    }, React.createElement("div", {
      className: "w-full md:w-56 bg-gray-50 border-r border-gray-100 flex-shrink-0 flex flex-col"
    }, React.createElement("div", {
      className: "p-3 font-bold text-[10px] uppercase text-gray-400 tracking-wider border-b border-gray-100"
    }, "Categories"), React.createElement("div", {
      className: "flex-1 overflow-y-auto"
    }, categories.map(cat => React.createElement("button", {
      key: cat,
      onClick: () => setActiveCategory(cat),
      className: `w-full px-4 py-2.5 text-left text-xs hover:bg-white border-l-4 transition flex justify-between items-center group ${activeCategory === cat ? 'bg-white border-primary text-primary font-bold shadow-sm z-10' : 'border-transparent text-gray-600'}`
    }, React.createElement("span", {
      className: "truncate pr-2"
    }, cat), React.createElement("span", {
      className: `text-[9px] px-1.5 py-0.5 rounded-full font-normal ${activeCategory === cat ? 'bg-primary text-white' : 'bg-gray-200 text-gray-500'}`
    }, dropdowns[cat].length))), categories.length === 0 && !loading && React.createElement("div", {
      className: "p-4 text-xs text-center text-gray-400 italic"
    }, "No categories."))), React.createElement("div", {
      className: "flex-1 p-4 flex flex-col bg-white overflow-hidden"
    }, activeCategory ? React.createElement(React.Fragment, null, React.createElement("div", {
      className: "flex justify-between items-center mb-4 pb-2 border-b border-dashed border-gray-100 flex-shrink-0"
    }, React.createElement("h3", {
      className: "text-base font-bold text-gray-800 capitalize flex items-center gap-2"
    }, activeCategory, React.createElement("button", {
      onClick: () => {
        setCatModalMode('rename');
        setCatNameInput(activeCategory);
        setShowCatModal(true);
      },
      className: "text-gray-300 hover:text-secondary transition p-1",
      title: "Rename Name"
    }, React.createElement(Icon, {
      name: "edit",
      className: "w-3.5 h-3.5"
    }))), React.createElement("button", {
      onClick: handleDeleteCategory,
      className: "text-red-400 hover:text-red-600 hover:bg-red-50 px-2 py-1 rounded transition text-xs font-medium flex items-center gap-1"
    }, React.createElement(Icon, {
      name: "trash",
      className: "w-3 h-3"
    }), " Delete")), React.createElement("form", {
      onSubmit: handleAddOption,
      className: "flex gap-2 mb-4 flex-shrink-0"
    }, React.createElement("input", {
      className: "flex-1 p-2 border border-gray-300 rounded focus:ring-1 focus:ring-secondary outline-none text-xs",
      placeholder: `Add option to ${activeCategory}...`,
      value: newValue,
      onChange: e => setNewValue(e.target.value)
    }), React.createElement("button", {
      type: "submit",
      disabled: !newValue.trim() || loading,
      className: "px-4 py-2 bg-secondary text-white font-bold text-xs rounded hover:opacity-90 disabled:opacity-50 shadow-sm transition"
    }, "Add")), React.createElement("div", {
      className: "flex-1 overflow-y-auto border border-gray-100 rounded bg-gray-50/30 p-1"
    }, dropdowns[activeCategory].length > 0 ? React.createElement("div", {
      className: "divide-y divide-gray-100"
    }, dropdowns[activeCategory].map((opt, i) => React.createElement("div", {
      key: i,
      className: "flex justify-between items-center p-2.5 bg-white hover:bg-accent/20 transition group first:rounded-t last:rounded-b"
    }, React.createElement("span", {
      className: "text-gray-600 text-sm"
    }, opt), React.createElement("button", {
      onClick: () => handleDeleteOption(opt),
      className: "text-gray-300 hover:text-red-500 hover:bg-white p-1 rounded opacity-0 group-hover:opacity-100 transition shadow-sm"
    }, React.createElement(Icon, {
      name: "trash",
      className: "w-3.5 h-3.5"
    }))))) : React.createElement("div", {
      className: "h-full flex flex-col items-center justify-center text-gray-300"
    }, React.createElement("p", {
      className: "text-xs"
    }, "No options found.")))) : React.createElement("div", {
      className: "flex-1 flex flex-col items-center justify-center text-gray-300"
    }, React.createElement(Icon, {
      name: "settings",
      className: "w-10 h-10 mb-2 opacity-10"
    }), React.createElement("p", {
      className: "text-sm font-medium"
    }, "Select a category")))), showCatModal && React.createElement("div", {
      className: "fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
    }, React.createElement("div", {
      className: "bg-white rounded shadow-xl w-full max-w-sm animate-fade-in p-5 text-sm"
    }, React.createElement("h3", {
      className: "font-bold text-gray-800 mb-3 text-base"
    }, catModalMode === 'add' ? 'New Category' : 'Rename Category'), React.createElement("input", {
      className: "w-full p-2 border rounded mb-4 focus:ring-1 focus:ring-primary outline-none",
      placeholder: "Category Name",
      value: catNameInput,
      onChange: e => setCatNameInput(e.target.value),
      autoFocus: true
    }), React.createElement("div", {
      className: "flex justify-end gap-2"
    }, React.createElement("button", {
      onClick: () => setShowCatModal(false),
      className: "px-3 py-1.5 text-gray-500 hover:bg-gray-100 rounded text-xs border border-transparent"
    }, "Cancel"), React.createElement("button", {
      onClick: handleCategorySubmit,
      className: "px-3 py-1.5 bg-primary text-white rounded hover:opacity-90 text-xs font-bold"
    }, catModalMode === 'add' ? 'Create' : 'Save')))));
  };
  window.AdminDropdowns = DropdownsAdmin;
</script>
    <script>
    // React hooks and contexts already declared in index.html
    const META_SCHEMA = [{
        key: 'field_id',
        label: 'ID (Section/Col)',
        type: 'text'
    }, {
        key: 'key',
        label: 'Field Key (Unique DB Column)',
        type: 'text',
        required: true
    }, {
        key: 'label',
        label: 'Display Label',
        type: 'text',
        required: true
    }, {
        key: 'type',
        label: 'Field Type',
        type: 'dropdown',
        dropdown: true,
        required: true
    }, {
        key: 'required',
        label: 'Required?',
        type: 'dropdown',
        dropdown: true,
        required: true
    }, {
        key: 'parentId',
        label: 'Parent Link (Key of Parent)',
        type: 'text'
    }, {
        key: 'skiplogic',
        label: 'Skip Logic',
        type: 'text'
    }, {
        key: 'sortable',
        label: 'Sortable?',
        type: 'dropdown',
        dropdown: true
    }, {
        key: 'align',
        label: 'Alignment',
        type: 'dropdown',
        dropdown: true
    }, {
        key: 'min',
        label: 'Min Value',
        type: 'number'
    }, {
        key: 'max',
        label: 'Max Value',
        type: 'number'
    }, {
        key: 'tblHidden',
        label: 'Hidden in Table?',
        type: 'dropdown',
        dropdown: true
    }, {
        key: 'disabled',
        label: 'Read Only?',
        type: 'dropdown',
        dropdown: true
    }, {
        key: 'hideColumn',
        label: 'Hidden Everywhere?',
        type: 'dropdown',
        dropdown: true
    }, {
        key: 'dropdown',
        label: 'Is Dropdown? (Auto)',
        type: 'dropdown',
        dropdown: true,
        hideColumn: true
    }, {
        key: 'id',
        label: 'ID',
        type: 'number',
        hidden: true,
        disabled: true
    }];
    const META_DROPDOWNS = {
        type: ['text', 'number', 'date', 'dropdown', 'multiselect', 'textarea', 'radio2', 'radio3', 'calculate_age'],
        required: ['yes', 'no'],
        dropdown: ['yes', 'no'],
        disabled: ['yes', 'no'],
        hideColumn: ['yes', 'no'],
        align: ['left', 'center', 'right']
    };
    const FieldEditor = ({
        initialData,
        onSave,
        onCancel,
        dropdownHeaders
    }) => {
        const [form, setForm] = useState({
            key: '',
            label: '',
            type: 'text',
            required: 'no',
            dropdown: 'no',
            disabled: 'no',
            hideColumn: 'no',
            align: 'left',
            ...initialData
        });
        const isDropdownType = form.type === 'dropdown' || form.type === 'multiselect';
        const handleChange = (k, v) => {
            setForm(p => {
                const n = {
                    ...p,
                    [k]: v
                };
                if (k === 'type') {
                    if (v === 'dropdown' || v === 'multiselect') n.dropdown = 'yes'; else n.dropdown = 'no';
                }
                return n;
            });
        };
        const handleSourceChange = src => {
            setForm(p => ({
                ...p,
                key: src,
                label: src.charAt(0).toUpperCase() + src.slice(1).replace(/_/g, ' ')
            }));
        };
        return React.createElement("div", {
            className: "fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
        }, React.createElement("div", {
            className: "bg-white rounded-lg shadow-2xl w-full max-w-2xl flex flex-col animate-fade-in max-h-[90vh]"
        }, React.createElement("div", {
            className: "p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg"
        }, React.createElement("h2", {
            className: "font-bold text-lg text-primary"
        }, initialData.id ? 'Edit Field' : 'Add New Field'), React.createElement("button", {
            onClick: onCancel,
            className: "text-gray-400 hover:text-danger"
        }, window.Icon ? React.createElement(window.Icon, {
            name: "close"
        }) : React.createElement("span", null, "X"))), React.createElement("div", {
            className: "p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6"
        }, React.createElement("div", {
            className: "col-span-2 md:col-span-1"
        }, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Field Type"), React.createElement("select", {
            className: "w-full p-2 border rounded focus:ring-2 focus:ring-secondary outline-none",
            value: form.type,
            onChange: e => handleChange('type', e.target.value)
        }, META_DROPDOWNS.type.map(t => React.createElement("option", {
            key: t,
            value: t
        }, t)))), isDropdownType && React.createElement("div", {
            className: "col-span-2 md:col-span-1 bg-yellow-50 p-3 rounded border border-yellow-200"
        }, React.createElement("label", {
            className: "block text-xs font-bold text-orange-600 uppercase mb-1"
        }, "Dropdown Source (Category)"), React.createElement("select", {
            className: "w-full p-2 border border-orange-300 rounded focus:ring-2 focus:ring-orange-200 outline-none bg-white",
            onChange: e => handleSourceChange(e.target.value)
        }, React.createElement("option", {
            value: ""
        }, "-- Select Source Helper --"), dropdownHeaders.map(h => React.createElement("option", {
            key: h,
            value: h
        }, h))), React.createElement("p", {
            className: "text-[10px] text-orange-500 mt-1"
        }, "Selecting a source will auto-set the Key.")), React.createElement("div", null, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Field Key (DB Column)"), React.createElement("input", {
            className: "w-full p-2 border rounded focus:ring-2 focus:ring-secondary outline-none font-mono text-sm",
            value: form.key,
            onChange: e => handleChange('key', e.target.value),
            placeholder: "e.g. first_name"
        })), React.createElement("div", null, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Display Label"), React.createElement("input", {
            className: "w-full p-2 border rounded focus:ring-2 focus:ring-secondary outline-none",
            value: form.label,
            onChange: e => handleChange('label', e.target.value),
            placeholder: "e.g. First Name"
        })), React.createElement("div", {
            className: "flex gap-4"
        }, React.createElement("div", {
            className: "flex-1"
        }, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Required?"), React.createElement("select", {
            className: "w-full p-2 border rounded focus:ring-2 focus:ring-secondary outline-none",
            value: form.required,
            onChange: e => handleChange('required', e.target.value)
        }, React.createElement("option", {
            value: "yes"
        }, "Yes"), React.createElement("option", {
            value: "no"
        }, "No"))), React.createElement("div", {
            className: "flex-1"
        }, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Read Only?"), React.createElement("select", {
            className: "w-full p-2 border rounded focus:ring-2 focus:ring-secondary outline-none",
            value: form.disabled,
            onChange: e => handleChange('disabled', e.target.value)
        }, React.createElement("option", {
            value: "yes"
        }, "Yes"), React.createElement("option", {
            value: "no"
        }, "No")))), React.createElement("div", {
            className: "flex gap-4"
        }, React.createElement("div", {
            className: "flex-1"
        }, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Parent Component ID (for dependency)"), React.createElement("input", {
            className: "w-full p-2 border rounded focus:ring-2 focus:ring-secondary outline-none text-sm",
            value: form.parentId || '',
            onChange: e => handleChange('parentId', e.target.value),
            placeholder: "Key of parent field"
        })), React.createElement("div", {
            className: "flex-1"
        }, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Skip Logic (Evaluated JS)"), React.createElement("input", {
            className: "w-full p-2 border rounded focus:ring-2 focus:ring-secondary outline-none text-sm",
            value: form.skiplogic || '',
            onChange: e => handleChange('skiplogic', e.target.value),
            placeholder: "e.g. data.age > 18"
        }))), React.createElement("div", {
            className: "flex gap-4"
        }, React.createElement("div", {
            className: "flex-1"
        }, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Min Value / Length"), React.createElement("input", {
            type: "number",
            className: "w-full p-2 border rounded focus:ring-2 focus:ring-secondary outline-none text-sm",
            value: form.min || '',
            onChange: e => handleChange('min', e.target.value),
            placeholder: "Optional"
        })), React.createElement("div", {
            className: "flex-1"
        }, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Max Value / Length"), React.createElement("input", {
            type: "number",
            className: "w-full p-2 border rounded focus:ring-2 focus:ring-secondary outline-none text-sm",
            value: form.max || '',
            onChange: e => handleChange('max', e.target.value),
            placeholder: "Optional"
        }))), React.createElement("div", {
            className: "col-span-2"
        }, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Advanced Options"), React.createElement("div", {
            className: "grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-50 p-3 rounded border"
        }, React.createElement("div", null, React.createElement("label", {
            className: "block text-[10px] uppercase text-gray-400"
        }, "ID (Section/Col)"), React.createElement("input", {
            className: "w-full p-1 text-sm border rounded",
            value: form.field_id || '',
            onChange: e => handleChange('field_id', e.target.value)
        })), React.createElement("div", null, React.createElement("label", {
            className: "block text-[10px] uppercase text-gray-400"
        }, "Alignment"), React.createElement("select", {
            className: "w-full p-1 text-sm border rounded",
            value: form.align,
            onChange: e => handleChange('align', e.target.value)
        }, React.createElement("option", {
            value: "left"
        }, "Left"), React.createElement("option", {
            value: "center"
        }, "Center"), React.createElement("option", {
            value: "right"
        }, "Right"))), React.createElement("div", null, React.createElement("label", {
            className: "block text-[10px] uppercase text-gray-400"
        }, "Hidden in Table?"), React.createElement("select", {
            className: "w-full p-1 text-sm border rounded",
            value: form.tblHidden,
            onChange: e => handleChange('tblHidden', e.target.value)
        }, React.createElement("option", {
            value: "no"
        }, "No"), React.createElement("option", {
            value: "yes"
        }, "Yes"))), React.createElement("div", null, React.createElement("label", {
            className: "block text-[10px] uppercase text-gray-400"
        }, "Sortable?"), React.createElement("select", {
            className: "w-full p-1 text-sm border rounded",
            value: form.sortable,
            onChange: e => handleChange('sortable', e.target.value)
        }, React.createElement("option", {
            value: "no"
        }, "No"), React.createElement("option", {
            value: "yes"
        }, "Yes"))), React.createElement("div", null, React.createElement("label", {
            className: "block text-[10px] uppercase text-gray-400"
        }, "Hide Column Completely"), React.createElement("select", {
            className: "w-full p-1 text-sm border rounded",
            value: form.hideColumn,
            onChange: e => handleChange('hideColumn', e.target.value)
        }, React.createElement("option", {
            value: "no"
        }, "No"), React.createElement("option", {
            value: "yes"
        }, "Yes")))))), React.createElement("div", {
            className: "p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-3"
        }, React.createElement("button", {
            onClick: onCancel,
            className: "px-4 py-2 border rounded bg-white hover:bg-gray-100 text-sm font-medium"
        }, "Cancel"), React.createElement("button", {
            onClick: () => onSave(form),
            className: "px-6 py-2 bg-primary text-white rounded hover:opacity-90 text-sm font-medium"
        }, "Save Field"))));
    };
    const FormBuilder = () => {
        const {
            user
        } = useContext(AuthContext);
        const {
            addAlert
        } = useContext(AlertContext);
        const [selectedSchema, setSelectedSchema] = useState('');
        const [fields, setFields] = useState([]);
        const [loading, setLoading] = useState(false);
        const [previewMode, setPreviewMode] = useState(false);
        const [dropdownHeaders, setDropdownHeaders] = useState([]);
        const [editingField, setEditingField] = useState(null);
        const [isNew, setIsNew] = useState(false);
        const [showCreateModal, setShowCreateModal] = useState(false);
        const [newSchemaData, setNewSchemaData] = useState({
            name: '',
            datasheet: ''
        });
        const [allSchemas, setAllSchemas] = useState([]);
        const fetchSchemas = async () => {
            try {
                const res = await server.getAllSchemas();
                const map = new Map();
                res.forEach(r => {
                    if (r.schema) map.set(r.schema, r);
                });
                setAllSchemas(Array.from(map.values()));
            } catch (e) {
                console.error(e);
            }
        };
        useEffect(() => {
            fetchSchemas();
        }, []);
        const currentSchemaInfo = useMemo(() => {
            return allSchemas.find(s => s.schema === selectedSchema);
        }, [selectedSchema, allSchemas]);
        const handleCreateSchema = async () => {
            if (!newSchemaData.name.trim() || !newSchemaData.datasheet.trim()) {
                addAlert("Schema Name and Datasheet Name are required", "warning");
                return;
            }
            const cleanSchema = newSchemaData.name.trim().replace(/[^a-zA-Z0-9_]/g, '_');
            const cleanDS = newSchemaData.datasheet.trim().replace(/[^a-zA-Z0-9_]/g, '_');
            setLoading(true);
            try {
                const res = await server.createNewSchema(cleanSchema, cleanDS);
                if (res.success) {
                    addAlert("Schema created! You may need to grant access in Users Admin.", "success");
                    setShowCreateModal(false);
                    setNewSchemaData({
                        name: '',
                        datasheet: ''
                    });
                    fetchSchemas();
                    setSelectedSchema(cleanSchema);
                } else {
                    addAlert(res.error, "error");
                }
            } catch (e) {
                addAlert(e.message, "error");
            } finally {
                setLoading(false);
            }
        };
        useEffect(() => {
            if (!selectedSchema) {
                setFields([]);
                return;
            }
            loadSchemaFields();
        }, [selectedSchema]);
        useEffect(() => {
            const loadDD = async () => {
                try {
                    const d = await server.getDropdownOptions();
                    if (d && d.headers) setDropdownHeaders(d.headers);
                } catch (e) {
                    console.error("DD Error", e);
                }
            };
            loadDD();
        }, []);
        const loadSchemaFields = async () => {
            setLoading(true);
            try {
                await server.clearSchemaCache(selectedSchema);
                const data = await server.getSchema(selectedSchema);
                if (data.error) throw new Error(data.error);
                setFields(data);
            } catch (e) {
                addAlert("Failed to load schema: " + e.message, 'error');
            } finally {
                setLoading(false);
            }
        };
        const handleSaveField = async fieldData => {
            setLoading(true);
            try {
                const payload = {
                    ...fieldData
                };
                ['required', 'dropdown', 'disabled', 'hideColumn'].forEach(k => {
                    if (typeof payload[k] === 'boolean') payload[k] = payload[k] ? 'yes' : 'no';
                });
                let res;
                if (isNew) {
                    res = await server.addRecord(payload, selectedSchema, [], user);
                } else {
                    res = await server.editRecord(payload.id, payload, selectedSchema, [], user);
                }
                if (res.success) {
                    addAlert("Field saved successfully", 'success');
                    setEditingField(null);
                    loadSchemaFields();
                } else {
                    throw new Error(res.error);
                }
            } catch (e) {
                addAlert(e.message, 'error');
            } finally {
                setLoading(false);
            }
        };
        const handleDeleteField = async id => {
            if (!confirm("Delete this field definition? This will NOT delete column in data, but remove it from form.")) return;
            setLoading(true);
            try {
                const res = await server.deleteRecord(id, selectedSchema, user);
                if (res.success) {
                    addAlert("Field deleted", 'success');
                    loadSchemaFields();
                } else throw new Error(res.error);
            } catch (e) {
                addAlert(e.message, 'error');
            } finally {
                setLoading(false);
            }
        };
        const renderList = () => React.createElement("div", {
            className: "bg-white rounded shadow h-full flex flex-col"
        }, React.createElement("div", {
            className: "p-4 border-b flex justify-between items-center bg-gray-50"
        }, React.createElement("h3", {
            className: "font-bold text-lg text-primary"
        }, "Form Fields (", fields.length, ")"), React.createElement("div", {
            className: "flex gap-2"
        }, React.createElement("button", {
            onClick: () => setPreviewMode(true),
            className: "px-3 py-1.5 border border-primary text-primary rounded text-sm font-medium hover:bg-primary hover:text-white transition"
        }, "Preview Form"), React.createElement("button", {
            onClick: () => {
                setIsNew(true);
                setEditingField({});
            },
            className: "px-3 py-1.5 bg-primary text-white rounded text-sm font-medium hover:opacity-90 transition"
        }, "+ Add Field"))), React.createElement("div", {
            className: "flex-1 overflow-auto p-0"
        }, React.createElement("table", {
            className: "min-w-full divide-y divide-gray-200"
        }, React.createElement("thead", {
            className: "bg-gray-100 text-xs text-gray-500 uppercase font-bold sticky top-0 shadow-sm"
        }, React.createElement("tr", null, React.createElement("th", {
            className: "px-4 py-3 text-left"
        }, "Key"), React.createElement("th", {
            className: "px-4 py-3 text-left"
        }, "Label"), React.createElement("th", {
            className: "px-4 py-3 text-left"
        }, "Type"), React.createElement("th", {
            className: "px-4 py-3 text-center"
        }, "Req"), React.createElement("th", {
            className: "px-4 py-3 text-right"
        }, "Order"), React.createElement("th", {
            className: "px-4 py-3 text-right"
        }, "Actions"))), React.createElement("tbody", {
            className: "divide-y divide-gray-200"
        }, fields.map((f, i) => React.createElement("tr", {
            key: f.id || i,
            className: "hover:bg-blue-50"
        }, React.createElement("td", {
            className: "px-4 py-2 text-sm font-mono text-gray-700"
        }, f.key), React.createElement("td", {
            className: "px-4 py-2 text-sm text-gray-800 font-medium"
        }, f.label), React.createElement("td", {
            className: "px-4 py-2 text-sm"
        }, React.createElement("span", {
            className: `px-2 py-0.5 rounded textxs border ${f.type === 'dropdown' ? 'bg-purple-100 text-purple-700 border-purple-200' : 'bg-gray-100 text-gray-600 border-gray-200'}`
        }, f.type)), React.createElement("td", {
            className: "px-4 py-2 text-center"
        }, f.required ? React.createElement("span", {
            className: "text-green-600"
        }, "\u2713") : React.createElement("span", {
            className: "text-gray-300"
        }, "-")), React.createElement("td", {
            className: "px-4 py-2 text-right text-xs text-gray-400"
        }, f.id), React.createElement("td", {
            className: "px-4 py-2 text-right"
        }, React.createElement("button", {
            onClick: () => {
                setIsNew(false);
                setEditingField(f);
            },
            className: "text-secondary hover:text-teal-700 mr-3"
        }, "Edit"), React.createElement("button", {
            onClick: () => handleDeleteField(f.id),
            className: "text-gray-400 hover:text-danger"
        }, "Delete"))))))));
        const renderEditor = () => {
            return React.createElement(FieldEditor, {
                initialData: editingField,
                onSave: handleSaveField,
                onCancel: () => setEditingField(null),
                dropdownHeaders: dropdownHeaders
            });
        };
        const renderPreview = () => React.createElement("div", {
            className: "fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-8 backdrop-blur-md"
        }, React.createElement("div", {
            className: "bg-white w-full max-w-4xl h-[90vh] rounded shadow-2xl flex flex-col overflow-hidden relative"
        }, React.createElement("button", {
            onClick: () => setPreviewMode(false),
            className: "absolute top-2 right-2 z-10 p-2 bg-gray-200 hover:bg-red-500 hover:text-white rounded-full transition"
        }, React.createElement(Icon, {
            name: "close"
        })), React.createElement("div", {
            className: "p-4 border-b bg-gray-50"
        }, React.createElement("h2", {
            className: "text-xl font-bold"
        }, "Form Preview: ", selectedSchema)), React.createElement("div", {
            className: "flex-1 overflow-auto bg-gray-100 p-8 flex justify-center"
        }, React.createElement("div", {
            className: "w-full max-w-3xl"
        }, React.createElement("div", {
            className: "bg-white p-8 rounded-xl shadow-lg border border-gray-100"
        }, window.DynamicForm && React.createElement(window.DynamicForm, {
            schema: fields,
            dropdowns: {},
            user: user,
            initialData: {},
            mode: 'add',
            onSave: () => alert("This is just a preview!"),
            onCancel: () => setPreviewMode(false)
        }))))));
        const Icon = ({
            name,
            className
        }) => window.Icon ? React.createElement(window.Icon, {
            name: name,
            className: className
        }) : React.createElement("span", null, name);
        const handleSync = async () => {
            addAlert("Syncing to BigQuery...", "info");
            try {
                const res = await server.syncDataWeb();
                if (res.success) addAlert(res.message, 'success'); else addAlert(res.error, 'error');
            } catch (e) {
                addAlert(e.message, 'error');
            }
        };
        return React.createElement("div", {
            className: "h-full flex flex-col md:flex-row animate-fade-in bg-white border rounded shadow overflow-hidden m-4"
        }, React.createElement("div", {
            className: "w-full md:w-64 bg-gray-50 border-r border-gray-100 flex flex-col"
        }, React.createElement("div", {
            className: "p-4 border-b border-gray-100 flex justify-between items-center"
        }, React.createElement("h3", {
            className: "font-bold text-gray-700 text-xs uppercase tracking-wider"
        }, "Forms"), React.createElement("div", {
            className: "flex gap-2"
        }, React.createElement("button", {
            onClick: handleSync,
            className: "text-gray-400 hover:text-blue-600",
            title: "Sync All Data to BigQuery"
        }, React.createElement(Icon, {
            name: "refresh",
            className: "w-3.5 h-3.5"
        })), React.createElement("button", {
            onClick: () => setShowCreateModal(true),
            className: "text-secondary hover:text-primary",
            title: "Create New Form"
        }, React.createElement(Icon, {
            name: "plus",
            className: "w-4 h-4"
        })))), React.createElement("div", {
            className: "flex-1 overflow-y-auto"
        }, allSchemas.length === 0 ? React.createElement("div", {
            className: "p-4 text-xs text-center text-gray-400 italic"
        }, "No forms found.") : React.createElement("ul", null, allSchemas.map(s => React.createElement("li", {
            key: s.schema
        }, React.createElement("button", {
            onClick: () => setSelectedSchema(s.schema),
            className: `w-full text-left px-4 py-3 border-l-4 transition hover:bg-white group ${selectedSchema === s.schema ? 'bg-white border-primary shadow-sm' : 'border-transparent'}`
        }, React.createElement("div", {
            className: `text-sm font-bold ${selectedSchema === s.schema ? 'text-primary' : 'text-gray-600'}`
        }, s.schema), React.createElement("div", {
            className: "text-[10px] text-gray-400 font-mono mt-0.5 flex items-center gap-1 group-hover:text-gray-500"
        }, React.createElement(Icon, {
            name: "table",
            className: "w-3 h-3"
        }), " ", s.datasheet))))))), React.createElement("div", {
            className: "flex-1 flex flex-col relative overflow-hidden"
        }, React.createElement("header", {
            className: "px-6 py-4 border-b bg-white flex justify-between items-center z-10 shadow-sm"
        }, React.createElement("div", null, React.createElement("h2", {
            className: "text-lg font-bold text-primary flex items-center gap-2"
        }, selectedSchema ? React.createElement(React.Fragment, null, selectedSchema, currentSchemaInfo && React.createElement("span", {
            className: "text-xs font-normal text-gray-400 px-2 py-0.5 rounded bg-gray-100"
        }, currentSchemaInfo.datasheet)) : 'Form Builder'), React.createElement("p", {
            className: "text-xs text-gray-500 mt-1"
        }, selectedSchema ? 'Manage fields and layout' : 'Select a form to begin')), selectedSchema && React.createElement("div", {
            className: "flex gap-3"
        }, React.createElement("button", {
            onClick: loadSchemaFields,
            className: "text-gray-400 hover:text-primary transition",
            title: "Refresh"
        }, React.createElement(Icon, {
            name: "refresh",
            className: "w-4 h-4"
        })))), React.createElement("div", {
            className: "flex-1 overflow-hidden relative bg-gray-50/50"
        }, !selectedSchema ? React.createElement("div", {
            className: "h-full flex flex-col items-center justify-center text-gray-300"
        }, React.createElement(Icon, {
            name: "settings",
            className: "w-16 h-16 mb-4 opacity-10"
        }), React.createElement("p", {
            className: "font-medium"
        }, "Select a form from the sidebar")) : loading && !editingField ? React.createElement("div", {
            className: "h-full flex items-center justify-center"
        }, React.createElement("div", {
            className: "loader w-8 h-8 border-4 border-gray-200 border-t-primary rounded-full animate-spin"
        })) : React.createElement("div", {
            className: "h-full overflow-hidden"
        }, renderList()))), editingField && renderEditor(), previewMode && renderPreview(), showCreateModal && React.createElement("div", {
            className: "fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
        }, React.createElement("div", {
            className: "bg-white rounded shadow-xl w-full max-w-sm animate-fade-in p-6"
        }, React.createElement("h3", {
            className: "font-bold text-gray-800 mb-4 text-lg"
        }, "Create New Form"), React.createElement("div", {
            className: "mb-4"
        }, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Schema Name (Unique Code)"), React.createElement("input", {
            className: "w-full p-2 border rounded focus:ring-1 focus:ring-primary outline-none text-sm",
            placeholder: "e.g. BEN_REG_V1",
            value: newSchemaData.name,
            onChange: e => setNewSchemaData({
                ...newSchemaData,
                name: e.target.value
            }),
            autoFocus: true
        }), React.createElement("p", {
            className: "text-[10px] text-gray-400 mt-1"
        }, "Unique ID for the schema definition sheet.")), React.createElement("div", {
            className: "mb-6"
        }, React.createElement("label", {
            className: "block text-xs font-bold text-gray-500 uppercase mb-1"
        }, "Datasheet Name (DB Table)"), React.createElement("input", {
            className: "w-full p-2 border rounded focus:ring-1 focus:ring-primary outline-none text-sm",
            placeholder: "e.g. beneficiaries",
            value: newSchemaData.datasheet,
            onChange: e => setNewSchemaData({
                ...newSchemaData,
                datasheet: e.target.value
            })
        }), React.createElement("p", {
            className: "text-[10px] text-gray-400 mt-1"
        }, "Name of the sheet/table where data is stored.")), React.createElement("div", {
            className: "flex justify-end gap-2"
        }, React.createElement("button", {
            onClick: () => setShowCreateModal(false),
            className: "px-4 py-2 text-gray-500 hover:bg-gray-100 rounded text-sm font-medium transition"
        }, "Cancel"), React.createElement("button", {
            onClick: handleCreateSchema,
            disabled: loading,
            className: "px-4 py-2 bg-primary text-white rounded hover:opacity-90 text-sm font-bold shadow-sm transition disabled:opacity-50"
        }, loading ? 'Creating...' : 'Create Form')))));
    };
    window.FormBuilder = FormBuilder;
</script>
    <script>
const DeletedLogs = () => {
  const {
    addAlert
  } = useContext(AlertContext);
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(false);
  const [selectedLog, setSelectedLog] = useState(null);
  useEffect(() => {
    fetchLogs();
  }, []);
  const fetchLogs = async () => {
    setLoading(true);
    try {
      const res = await server.getDeletionLogs();
      if (res.error) throw new Error(res.error);
      setLogs(Array.isArray(res) ? res : []);
    } catch (e) {
      addAlert("Failed to load logs: " + e.message, 'error');
    } finally {
      setLoading(false);
    }
  };
  return React.createElement("div", {
    className: "p-6 h-full flex flex-col space-y-4"
  }, React.createElement("div", {
    className: "flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200"
  }, React.createElement("div", null, React.createElement("h2", {
    className: "text-xl font-bold text-primary flex items-center gap-2"
  }, React.createElement(Icon, {
    name: "trash",
    className: "w-6 h-6 text-danger"
  }), "Deleted Records Audit Log"), React.createElement("p", {
    className: "text-sm text-gray-500"
  }, "History of all deleted entries")), React.createElement("button", {
    onClick: fetchLogs,
    className: "px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition text-sm font-medium flex items-center gap-2"
  }, React.createElement(Icon, {
    name: "search",
    className: "w-4 h-4"
  }), " Refresh")), React.createElement("div", {
    className: "flex-1 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col"
  }, loading ? React.createElement("div", {
    className: "flex-1 flex items-center justify-center"
  }, React.createElement("div", {
    className: "loader h-8 w-8 rounded-full border-4 border-t-4 border-primary"
  })) : logs.length === 0 ? React.createElement("div", {
    className: "flex-1 flex flex-col items-center justify-center text-gray-400"
  }, React.createElement(Icon, {
    name: "trash",
    className: "w-12 h-12 mb-2 opacity-20"
  }), React.createElement("p", null, "No deletion logs found.")) : React.createElement("div", {
    className: "flex-1 overflow-auto"
  }, React.createElement("table", {
    className: "w-full text-left text-sm"
  }, React.createElement("thead", {
    className: "bg-gray-50 text-xs font-bold text-gray-500 uppercase sticky top-0 z-10 border-b border-gray-200"
  }, React.createElement("tr", null, React.createElement("th", {
    className: "px-6 py-3"
  }, "Timestamp"), React.createElement("th", {
    className: "px-6 py-3"
  }, "Deleter"), React.createElement("th", {
    className: "px-6 py-3"
  }, "Type"), React.createElement("th", {
    className: "px-6 py-3"
  }, "Datasheet"), React.createElement("th", {
    className: "px-6 py-3"
  }, "Row ID"), React.createElement("th", {
    className: "px-6 py-3 text-right"
  }, "Details"))), React.createElement("tbody", {
    className: "divide-y divide-gray-100"
  }, logs.map((log, idx) => React.createElement("tr", {
    key: idx,
    className: "hover:bg-gray-50/50 transition"
  }, React.createElement("td", {
    className: "px-6 py-3 whitespace-nowrap text-gray-600 font-medium"
  }, log.timestamp), React.createElement("td", {
    className: "px-6 py-3 text-gray-700"
  }, React.createElement("span", {
    className: "font-semibold"
  }, log.deleter)), React.createElement("td", {
    className: "px-6 py-3"
  }, React.createElement("span", {
    className: `px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${log.usertype === 'superadmin' ? 'bg-purple-100 text-purple-700' : log.usertype === 'admin' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}`
  }, log.usertype)), React.createElement("td", {
    className: "px-6 py-3 text-gray-600 font-mono text-xs"
  }, log.datasheet), React.createElement("td", {
    className: "px-6 py-3 text-gray-600 font-mono text-xs"
  }, "#", log.rowid), React.createElement("td", {
    className: "px-6 py-3 text-right"
  }, React.createElement("button", {
    onClick: () => setSelectedLog(log),
    className: "text-secondary hover:text-teal-700 text-xs font-bold"
  }, "View Data"))))))), React.createElement("div", {
    className: "bg-gray-50 border-t border-gray-200 px-4 py-2 text-xs text-gray-500"
  }, "Total Logs: ", logs.length)), selectedLog && React.createElement("div", {
    className: "fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
  }, React.createElement("div", {
    className: "bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col animate-fade-in"
  }, React.createElement("div", {
    className: "p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-lg"
  }, React.createElement("h3", {
    className: "font-bold text-lg text-primary"
  }, "Deleted Record Details"), React.createElement("button", {
    onClick: () => setSelectedLog(null),
    className: "text-gray-400 hover:text-danger"
  }, React.createElement(Icon, {
    name: "close"
  }))), React.createElement("div", {
    className: "p-6 overflow-y-auto font-mono text-xs text-gray-700 bg-gray-50/50"
  }, React.createElement("pre", {
    className: "whitespace-pre-wrap break-words border p-4 rounded bg-white shadow-sm"
  }, JSON.stringify(JSON.parse(selectedLog.fulldatajson || '{}'), null, 2))), React.createElement("div", {
    className: "p-4 border-t border-gray-100 flex justify-end"
  }, React.createElement("button", {
    onClick: () => setSelectedLog(null),
    className: "px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 font-medium text-sm"
  }, "Close")))));
};
window.DeletedLogs = DeletedLogs;
</script>
    <script>
    // CRG Module - Component Definition
    // Relies on global variables defined in index.html (server, React hooks, etc.)



    // --- MultiSelect Dropdown Component ---
    // --- MultiSelect Dropdown Component ---
    // (Moved to index.html to be globally available)

    // --- Meeting Form Component ---
    const MeetingForm = ({ user, datasheet, dropdowns, onSave, onCancel, mode, initialData }) => {
        const { useContext, useState, useEffect, useMemo, useCallback } = React;
        const { addAlert } = useContext(window.AlertContext || React.createContext({}));
        const Icon = window.Icon || (() => null);
        const MultiSelectDropdown = window.MultiSelectDropdown || (() => null);


        // Determine if State should be locked or restricted
        const userStateStr = user.state ? String(user.state) : '';
        const isNational = userStateStr.toLowerCase() === 'national';

        // Parse user assigned states (comma separated)
        const userAssignedStates = isNational ? [] : userStateStr.split(',').map(s => s.trim()).filter(s => s);

        // Determine options available to this user
        // If National: all found options. If specific: only their assigned states.
        const allStateOptions = dropdowns.state || [];
        const visibleStateOptions = isNational ? allStateOptions : userAssignedStates;

        // Lock ONLY if user has exactly one assigned state (and not National)
        const lockedState = !isNational && userAssignedStates.length === 1 ? userAssignedStates[0] : null;

        // If user has district, lock it.
        const lockedDistrict = user.district || null;

        // Helper function to convert date from "dd-MMM-yyyy" or Date object to "yyyy-MM-dd"
        const convertDateFormat = (val) => {
            if (!val) return '';

            // If already yyyy-MM-dd
            if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}/.test(val)) return val.substring(0, 10);

            try {
                const dateObj = new Date(val);
                if (!isNaN(dateObj.getTime())) {
                    const y = dateObj.getFullYear();
                    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const d = String(dateObj.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                }
            } catch (e) { }

            // Manual fallback for "dd-MMM-yyyy" if Date() fails
            try {
                if (typeof val === 'string' && val.includes('-')) {
                    const parts = val.split('-');
                    if (parts.length === 3) {
                        const day = parts[0].padStart(2, '0');
                        const monthMap = { jan: '01', feb: '02', mar: '03', apr: '04', may: '05', jun: '06', jul: '07', aug: '08', sep: '09', oct: '10', nov: '11', dec: '12' };
                        const month = monthMap[parts[1].toLowerCase()];
                        const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                        if (month && year) return `${year}-${month}-${day}`;
                    }
                }
            } catch (e) { }

            return val;
        };

        const [meetingData, setMeetingData] = useState(initialData ? {
            ...initialData,
            state: initialData.state || lockedState || '',
            district: initialData.district || lockedDistrict || '',
            date_of_meeting: convertDateFormat(initialData.date_of_meeting) || ''
        } : {
            state: lockedState || '',
            district: lockedDistrict || '',
            minutes_prepared: 'No',
            minutes_shared: 'No'
        });
        const [members, setMembers] = useState([]);
        const [attendance, setAttendance] = useState({});
        const [actionPoints, setActionPoints] = useState(() => {
            const rawActionPoints = initialData?.action_points || initialData?.action_ponts;
            if (!rawActionPoints) return [];
            if (Array.isArray(rawActionPoints)) return rawActionPoints;

            if (typeof rawActionPoints === 'string' && rawActionPoints.trim()) {
                // Try parsing as JSON first
                if (rawActionPoints.trim().startsWith('[')) {
                    try {
                        const parsed = JSON.parse(rawActionPoints);
                        if (Array.isArray(parsed)) return parsed;
                    } catch (e) { }
                }

                // Fallback: Split by semicolon or newline
                const descriptions = rawActionPoints.split(/[;\n]/).map(s => s.trim()).filter(Boolean);
                return descriptions.map((desc, i) => ({
                    id: `temp-${Date.now()}-${i}`,
                    action_points: desc,
                    responsible_person: '',
                    timeline_for_action: '',
                    action_status: 'Open',
                    escalation_required: 'No'
                }));
            }
            return [];
        });
        const [loading, setLoading] = useState(false);
        const [saving, setSaving] = useState(false);

        // Fetch Full Meeting Details (Action Points & Attendance) for Edit Mode
        useEffect(() => {
            if (mode === 'edit' && initialData?.id) {
                const fetchDetails = async () => {
                    try {
                        const type = datasheet.includes('State') ? 'State' : 'District';
                        const res = await server.getMeetingDetails(type, initialData.id);
                        if (res && res.success) {
                            // Update Action Points (Dedicated sheet is source of truth)
                            if (res.actionPoints) {
                                setActionPoints(res.actionPoints.map(ap => ({
                                    ...ap,
                                    action_points: ap.action_points || ap.description || '',
                                    responsible_person: (ap.responsible_person || ap.responsible_person_entity || ap.responsible_entity || '').trim(),
                                    timeline_for_action: convertDateFormat(ap.timeline_for_action || ap.timeline || ap.deadline),
                                    action_status: ap.action_status || ap.status || 'Open',
                                    escalation_required: ap.escalation_required || ap.escalation_required_to_naco || 'No'
                                })));
                            }

                            // Overlay Attendance status from the Attendance sheet
                            if (res.attendance) {
                                setAttendance(prevAtt => {
                                    const nextAtt = { ...prevAtt };
                                    res.attendance.forEach(attRecord => {
                                        const memberId = attRecord.member_id || attRecord.id;
                                        if (memberId && nextAtt[memberId]) {
                                            nextAtt[memberId].present = attRecord.present || 'No';
                                        }
                                    });
                                    return nextAtt;
                                });
                            }
                        }
                    } catch (e) {
                        console.error('Failed to fetch meeting details:', e);
                    }
                };
                fetchDetails();
            }
        }, [mode, initialData?.id]);

        // Fetch Members for Attendance
        useEffect(() => {
            const fetchMembers = async () => {
                // Only fetch if we have required location context
                const type = datasheet.includes('State') ? 'State' : 'District';
                if (!meetingData.state) return; // Must have state
                if (type === 'District' && !meetingData.district) return; // District form needs district

                try {
                    setLoading(true);
                    const filter = { state: meetingData.state };
                    if (type === 'District') filter.district = meetingData.district;

                    const res = await server.getCRGMembers(type, filter);
                    if (res && res.success) {
                        setMembers(res.members);
                        // Initialize attendance: Use initialData if in edit mode, otherwise default to 'No'
                        const newAtt = {};

                        // Parse participants if it's a string
                        let participants = [];
                        if (initialData?.participants) {
                            if (Array.isArray(initialData.participants)) {
                                participants = initialData.participants;
                            } else if (typeof initialData.participants === 'string') {
                                // Could be JSON array or comma-separated names
                                if (initialData.participants.trim().startsWith('[')) {
                                    try {
                                        participants = JSON.parse(initialData.participants);
                                    } catch (e) {
                                        console.warn('Failed to parse participants as JSON:', e);
                                    }
                                } else {
                                    const names = initialData.participants.split(',').map(n => n.trim()).filter(n => n);
                                    // We'll mark members as present if their name is in the list
                                    participants = names.map(name => ({ member_name: name, present: 'Yes' }));
                                }
                            }
                        }

                        setAttendance(prevAtt => {
                            const updatedAtt = { ...prevAtt };
                            res.members.forEach(m => {
                                // Priority: 
                                // 1. Already set in state (from getMeetingDetails)
                                // 2. Found in initialData (string/array)
                                // 3. Default 'No'

                                if (updatedAtt[m.id]?.present) {
                                    // Keep existing overlay
                                    updatedAtt[m.id] = { ...m, ...updatedAtt[m.id] };
                                } else {
                                    let initialPresent = 'No';
                                    let participant = participants.find(p => String(p.member_id || p.id) === String(m.id));

                                    if (!participant && participants.length > 0) {
                                        participant = participants.find(p => {
                                            const pName = (p.member_name || '').trim().toLowerCase();
                                            const mName = (m.name_of_nominee || m.username || '').trim().toLowerCase();
                                            return pName && mName && pName === mName;
                                        });
                                    }

                                    if (participant) initialPresent = participant.present || 'Yes';
                                    updatedAtt[m.id] = { ...m, present: initialPresent };
                                }
                            });
                            return updatedAtt;
                        });
                    } else {
                        if (addAlert) addAlert("Failed to fetch members: " + res.error, 'error');
                        setMembers([]);
                    }
                } catch (e) {
                    console.error(e);
                } finally {
                    setLoading(false);
                }
            };

            // Debounce fetch to avoid double calls on rapid state/district switches
            const t = setTimeout(fetchMembers, 300);
            return () => clearTimeout(t);
        }, [datasheet, meetingData.state, meetingData.district]); // removed user dependency, relied on meetingData init

        // Handlers
        const handleMeetingChange = (key, val) => {
            setMeetingData(prev => {
                const newData = { ...prev, [key]: val };
                // If State changes, clear District (unless locked)
                if (key === 'state' && prev.state !== val && !lockedDistrict) {
                    newData.district = '';
                }
                return newData;
            });
        };

        const handleAttendanceChange = (memberId, isPresent) => {
            setAttendance(prev => ({
                ...prev,
                [memberId]: { ...prev[memberId], present: isPresent ? 'Yes' : 'No' }
            }));
        };

        const removeActionPoint = (index) => {
            const newAp = [...actionPoints];
            newAp.splice(index, 1);
            setActionPoints(newAp);
        };

        const saveRowDraft = (index) => {
            try {
                const draft = {
                    meetingData: meetingData,
                    attendance: attendance,
                    actionPoints: actionPoints,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem('crg_meeting_draft', JSON.stringify(draft));
                addAlert('Draft saved to browser storage.', 'success');
            } catch (e) {
                addAlert('Failed to save draft locally.', 'error');
            }
        };

        const addActionPoint = () => {
            setActionPoints(prev => [...prev, {
                action_points: '',
                responsible_person: '',
                timeline_for_action: '',
                action_status: 'Open',
                escalation_required: 'No'
            }]);
        };

        const updateActionPoint = (idx, key, val) => {
            setActionPoints(prev => prev.map((item, i) => i === idx ? { ...item, [key]: val } : item));
        };


        const handleSubmit = async (e) => {
            e.preventDefault();
            // Validate
            if (!meetingData.date_of_meeting) return addAlert("Date of Meeting is required", 'warning');
            if (datasheet.includes('District') && !meetingData.district) return addAlert("District is required", 'warning');
            if (mode === 'edit' && !meetingData.id) return addAlert("Missing Meeting ID for Update", 'error');

            // Validate Action Points
            const invalidAP = actionPoints.some(ap => !ap.action_points || ap.action_points.trim() === '');
            if (invalidAP) return addAlert("Please provide descriptions for all action points", 'warning');

            // Format Payload
            const attendanceList = Object.values(attendance).map(m => {
                const mid = m.id || m.member_id;
                if (!mid) {
                }
                return {
                    member_id: mid,
                    member_name: m.name_of_nominee || m.member_name || m.username,
                    present: m.present || 'No'
                };
            });

            const missingMemberIds = attendanceList.some(a => !a.member_id);
            if (missingMemberIds) return addAlert("Some participant records are missing IDs. Please refresh and try again.", 'error');

            try {
                const payload = {
                    ...meetingData,
                    participants: attendanceList,
                    action_points: actionPoints
                };
                setSaving(true); // UI feedback
                await onSave(payload);
            } catch (e) {
                addAlert("Failed to save meeting: " + e.message, 'error');
            } finally {
                setSaving(false);
            }
        };

        // Derivations
        // District options depend on selected state
        const districtOptions = (meetingData.state && dropdowns.district) ? (dropdowns.district[meetingData.state] || []) : [];

        return React.createElement("div", { className: "h-full flex flex-col bg-white rounded-lg shadow border border-gray-200" },
            React.createElement("div", { className: "p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-lg" },
                React.createElement("h2", { className: "font-bold text-lg text-primary" }, mode === 'edit' ? "Update Meeting" : "Add Meeting"),
                React.createElement("button", { onClick: onCancel, className: "text-gray-400 hover:text-danger" }, React.createElement(Icon, { name: "close" }))
            ),
            React.createElement("form", { onSubmit: handleSubmit, className: "flex-1 overflow-y-auto p-6 space-y-8" },
                // Section 1: Meeting Details
                React.createElement("div", null,
                    React.createElement("h3", { className: "text-sm font-bold text-gray-700 uppercase tracking-wide border-b border-gray-200 pb-2 mb-4" }, "Meeting Details"),
                    // Top Row: State, District, Date, Type (4 cols)
                    React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-4 gap-4 mb-4" },
                        // State (Multi-state support)
                        React.createElement("div", null,
                            React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "State"),
                            lockedState ?
                                React.createElement("input", {
                                    className: "w-full p-2 border rounded text-sm bg-gray-100 text-gray-500",
                                    value: lockedState,
                                    readOnly: true
                                }) :
                                React.createElement("select", {
                                    className: "w-full p-2 border rounded text-sm focus:ring-2 focus:ring-primary/20 outline-none",
                                    value: meetingData.state || '',
                                    onChange: e => handleMeetingChange('state', e.target.value)
                                },
                                    React.createElement("option", { value: "" }, "-- Select State --"),
                                    visibleStateOptions.map(o => React.createElement("option", { key: o, value: o }, o))
                                )
                        ),

                        // District (Dependent)
                        datasheet.includes('District') && React.createElement("div", null,
                            React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "District"),
                            lockedDistrict ?
                                React.createElement("input", {
                                    className: "w-full p-2 border rounded text-sm bg-gray-100 text-gray-500",
                                    value: lockedDistrict,
                                    readOnly: true
                                }) :
                                React.createElement("select", {
                                    className: "w-full p-2 border rounded text-sm focus:ring-2 focus:ring-primary/20 outline-none",
                                    value: meetingData.district || '',
                                    disabled: !meetingData.state,
                                    onChange: e => handleMeetingChange('district', e.target.value)
                                },
                                    React.createElement("option", { value: "" }, "-- Select District --"),
                                    districtOptions.map(o => React.createElement("option", { key: o, value: o }, o))
                                )
                        ),

                        React.createElement("div", null,
                            React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Date of Meeting"),
                            React.createElement("input", {
                                type: "date",
                                required: true,
                                className: "w-full p-2 border rounded text-sm focus:ring-2 focus:ring-primary/20 outline-none",
                                value: meetingData.date_of_meeting || '',
                                onChange: e => handleMeetingChange('date_of_meeting', e.target.value)
                            })
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Meeting Type"),
                            React.createElement("select", {
                                className: "w-full p-2 border rounded text-sm focus:ring-2 focus:ring-primary/20 outline-none",
                                value: meetingData.meeting_type || '',
                                onChange: e => handleMeetingChange('meeting_type', e.target.value)
                            },
                                React.createElement("option", { value: "" }, "-- Select --"),
                                ['Quarterly', 'Special', 'Formation'].map(o => React.createElement("option", { key: o, value: o }, o))
                            )
                        ),
                        // Textarea Grid (2x2 Layout)
                        React.createElement("div", { className: "col-span-full grid grid-cols-1 md:grid-cols-2 gap-4" },
                            // Key Agenda
                            React.createElement("div", null,
                                React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Key Agenda"),
                                React.createElement("textarea", {
                                    className: "w-full p-2 border rounded text-sm focus:ring-2 focus:ring-primary/20 outline-none",
                                    rows: 2,
                                    value: meetingData.key_agenda || '',
                                    onChange: e => handleMeetingChange('key_agenda', e.target.value)
                                })
                            ),
                            // Key Decisions
                            React.createElement("div", null,
                                React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Key Decisions"),
                                React.createElement("textarea", {
                                    className: "w-full p-2 border rounded text-sm focus:ring-2 focus:ring-primary/20 outline-none",
                                    rows: 2,
                                    value: meetingData.key_decisions || '',
                                    onChange: e => handleMeetingChange('key_decisions', e.target.value)
                                })
                            ),
                            // Status of Previous Action Points
                            React.createElement("div", null,
                                React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Status of Action Points from Previous Meeting"),
                                React.createElement("textarea", {
                                    className: "w-full p-2 border rounded text-sm focus:ring-2 focus:ring-primary/20 outline-none",
                                    rows: 2,
                                    value: meetingData.status_of_action_points_from_previous_meeting || '',
                                    onChange: e => handleMeetingChange('status_of_action_points_from_previous_meeting', e.target.value)
                                })
                            ),
                            // Remarks
                            React.createElement("div", null,
                                React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Remarks"),
                                React.createElement("textarea", {
                                    className: "w-full p-2 border rounded text-sm focus:ring-2 focus:ring-primary/20 outline-none",
                                    rows: 2,
                                    value: meetingData.remarks || '',
                                    onChange: e => handleMeetingChange('remarks', e.target.value)
                                })
                            )
                        ),

                        // Attendance & Admin Row (4 cols)
                        React.createElement("div", { className: "col-span-full grid grid-cols-1 md:grid-cols-4 gap-4 items-start" },
                            // Attendance (Moved here)
                            React.createElement("div", { className: "md:col-span-2" },
                                React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1 flex justify-between" },
                                    "Attendance Check",
                                    React.createElement("span", { className: "text-xs font-normal text-primary" }, `${Object.values(attendance).filter(m => m.present === 'Yes').length}/${members.length}`)
                                ),
                                loading ? React.createElement("div", { className: "text-xs text-gray-400" }, "Loading...") :
                                React.createElement(MultiSelectDropdown || (() => null), {
                                        options: members.map(m => ({ label: m.name_of_nominee, value: String(m.id), sub: m.category || m.designation })),
                                        selected: Object.keys(attendance).filter(id => attendance[id].present === 'Yes'),
                                        onChange: (selectedIds) => {
                                            const newAtt = { ...attendance };
                                            members.forEach(m => {
                                                newAtt[m.id] = { ...m, present: selectedIds.includes(String(m.id)) ? 'Yes' : 'No' };
                                            });
                                            setAttendance(newAtt);
                                        },
                                        placeholder: "Select Participants...",
                                        showChips: true,
                                        selectedLabel: "Present"
                                    })
                            ),
                            // Quorum Attended
                            React.createElement("div", null,
                                React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Quorum Attended?"),
                                React.createElement("select", {
                                    className: "w-full p-2 border rounded text-sm focus:ring-2 focus:ring-primary/20 outline-none",
                                    value: meetingData.quorum_attended || 'No',
                                    onChange: e => handleMeetingChange('quorum_attended', e.target.value)
                                }, ['Yes', 'No'].map(o => React.createElement("option", { key: o, value: o }, o)))
                            ),
                            // Minutes Prepared
                            React.createElement("div", null,
                                React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Minutes Prepared?"),
                                React.createElement("select", {
                                    className: "w-full p-2 border rounded text-sm focus:ring-2 focus:ring-primary/20 outline-none",
                                    value: meetingData.minutes_prepared || 'No',
                                    onChange: e => handleMeetingChange('minutes_prepared', e.target.value)
                                }, ['Yes', 'No'].map(o => React.createElement("option", { key: o, value: o }, o)))
                            ),
                            // Minutes Shared
                            React.createElement("div", null,
                                React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Minutes Shared?"),
                                React.createElement("select", {
                                    className: "w-full p-2 border rounded text-sm focus:ring-2 focus:ring-primary/20 outline-none",
                                    value: meetingData.minutes_shared || 'No',
                                    onChange: e => handleMeetingChange('minutes_shared', e.target.value)
                                }, ['Yes', 'No'].map(o => React.createElement("option", { key: o, value: o }, o)))
                            )
                        )
                    )
                ),

                // Section 3: Action Points
                React.createElement("div", null,
                    React.createElement("h3", { className: "text-sm font-bold text-gray-700 uppercase tracking-wide border-b border-gray-200 pb-2 mb-4 flex items-center justify-between" },
                        React.createElement("span", null, "Action Points"),
                        React.createElement("button", {
                            type: "button",
                            onClick: addActionPoint,
                            className: "text-xs flex items-center gap-1 bg-primary/10 text-primary px-3 py-1 rounded hover:bg-primary/20 transition"
                        }, React.createElement(Icon, { name: "plus", className: "w-3 h-3" }), "Add Action")
                    ),
                    React.createElement("div", { className: "space-y-3" },
                        actionPoints.map((item, idx) => React.createElement("div", { key: idx, className: "bg-gray-50 p-4 rounded border border-gray-200 relative animate-fade-in" },
                            React.createElement("div", { className: "absolute top-2 right-2 flex items-center gap-1" },
                                React.createElement("button", {
                                    type: "button",
                                    title: "Save Draft",
                                    onClick: () => saveRowDraft(idx),
                                    className: "text-gray-400 hover:text-green-600 transition p-1"
                                }, React.createElement(Icon, { name: "save", className: "w-4 h-4" })),
                                React.createElement("button", {
                                    type: "button",
                                    title: "Remove",
                                    onClick: () => removeActionPoint(idx),
                                    className: "text-gray-400 hover:text-danger transition p-1"
                                }, React.createElement(Icon, { name: "trash", className: "w-4 h-4" }))
                            ),
                            React.createElement("div", { className: "grid grid-cols-1 gap-4" },
                                React.createElement("div", { className: "col-span-full" },
                                    React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Action Point Description"),
                                    React.createElement("input", {
                                        className: "w-full p-2 border rounded text-sm outline-none focus:border-primary bg-white",
                                        value: item.action_points,
                                        onChange: e => updateActionPoint(idx, 'action_points', e.target.value),
                                        placeholder: "Describe the action item..."
                                    })
                                ),
                                // 4-Column Layout
                                React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-4 gap-4" },
                                    React.createElement("div", null,
                                        React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Responsible Person"),
                                        React.createElement("select", {
                                            className: "w-full p-2 border rounded text-sm outline-none focus:border-primary bg-white",
                                            value: item.responsible_person,
                                            onChange: e => updateActionPoint(idx, 'responsible_person', e.target.value)
                                        },
                                            React.createElement("option", { value: "" }, "-- Select --"),
                                            members.map(m => React.createElement("option", { key: m.id, value: m.name_of_nominee }, m.name_of_nominee))
                                        )
                                    ),
                                    React.createElement("div", null,
                                        React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Timeline"),
                                        React.createElement("input", {
                                            type: "date",
                                            className: "w-full p-2 border rounded text-sm outline-none focus:border-primary bg-white",
                                            value: item.timeline_for_action,
                                            onChange: e => updateActionPoint(idx, 'timeline_for_action', e.target.value)
                                        })
                                    ),
                                    React.createElement("div", null,
                                        React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Action Status"),
                                        React.createElement("select", {
                                            className: "w-full p-2 border rounded text-sm outline-none focus:border-primary bg-white",
                                            value: item.action_status || 'Open',
                                            onChange: e => updateActionPoint(idx, 'action_status', e.target.value)
                                        }, ['Open', 'In Progress', 'Closed'].map(o => React.createElement("option", { key: o, value: o }, o)))
                                    ),
                                    React.createElement("div", null,
                                        React.createElement("label", { className: "block text-xs font-semibold text-gray-500 mb-1" }, "Escalation to NACO?"),
                                        React.createElement("select", {
                                            className: "w-full p-2 border rounded text-sm outline-none focus:border-primary bg-white",
                                            value: item.escalation_required || 'No',
                                            onChange: e => updateActionPoint(idx, 'escalation_required', e.target.value)
                                        }, ['Yes', 'No'].map(o => React.createElement("option", { key: o, value: o }, o)))
                                    )
                                )
                            )
                        ))
                    ),
                    actionPoints.length === 0 && React.createElement("div", { className: "text-center py-8 text-gray-400 text-sm border-2 border-dashed border-gray-100 rounded" }, "No action points added yet.")
                ),
                // Footer Buttons (Inside Form)
                React.createElement("div", { className: "p-4 border-t border-gray-100 flex justify-end gap-3 bg-gray-50 rounded-b-lg sticky bottom-0 z-10" },
                    React.createElement("button", {
                        type: "button",
                        onClick: onCancel,
                        disabled: saving,
                        className: "px-4 py-2 text-gray-600 font-medium text-sm hover:bg-white border border-transparent hover:border-gray-200 rounded transition"
                    }, "Cancel"),
                    React.createElement("button", {
                        type: "submit",
                        disabled: saving,
                        className: `px-6 py-2 bg-primary text-white font-medium text-sm rounded shadow hover:bg-primary-dark transition transform hover:scale-105 flex items-center gap-2 ${saving ? "opacity-75 cursor-not-allowed" : ""}`
                    },
                        saving && React.createElement(Icon, { name: "loader", className: "w-4 h-4 animate-spin" }),
                        saving ? "Saving..." : (mode === 'edit' ? "Update Meeting" : "Add Meeting")
                    )
                )
            ) // End Form
        );
    };

    // --- PDF Generation Helper ---
    const generateMeetingPDF = (row, user, datasheetTitle) => {
        try {
            // 1. Data Parsing
            const date = window.ensureDDMMMYYYY ? window.ensureDDMMMYYYY(row.date_of_meeting) : row.date_of_meeting;
            const participants = row.participants ? String(row.participants).split(',').map(s => s.trim()).filter(Boolean) : [];

            // Parse Action Points (Semicolon separated)
            const apRaw = (row.action_points || row.action_points_description || "").split('; ');
            const rpRaw = (row.responsible_person || "").split('; ');
            const tlRaw = (row.timeline_for_action || "").split('; ');
            const stRaw = (row.action_status || "").split('; ');

            const actionPoints = apRaw.map((desc, i) => ({
                desc: desc || "-",
                resp: rpRaw[i] || "-",
                time: tlRaw[i] || "-",
                status: stRaw[i] || "Open"
            })).filter(ap => ap.desc !== "-");

            // 2. HTML Template
            const styles = `
                <style data-optimized="true">@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');@page{size: A4;margin: 15mm}body{font-family: 'Roboto',sans-serif;font-size: 11pt;color: #333;line-height: 1.4}.header{display: flex;justify-content: space-between;align-items: center;border-bottom: 2px solid #2c3e50;padding-bottom: 10px;margin-bottom: 20px}.logo{height: 50px}.title-box{text-align: right}.title{font-size: 18pt;font-weight: bold;color: #2c3e50;margin: 0}.subtitle{font-size: 10pt;color: #666;margin-top: 5px}.grid{display: grid;grid-template-columns: 1fr 1fr;gap: 15px;margin-bottom: 20px}.field{margin-bottom: 5px}.label{font-size: 8pt;font-weight: bold;color: #7f8c8d;text-transform: uppercase}.value{font-weight: 500;font-size: 10pt}.section{margin-top: 20px;margin-bottom: 10px}.section-title{font-size: 12pt;font-weight: bold;color: #2980b9;border-bottom: 1px solid #eee;padding-bottom: 5px;margin-bottom: 10px}.content-box{background: #f9f9f9;padding: 10px;border-radius: 4px;border: 1px solid #eee;min-height: 30px;font-size: 10pt;white-space: pre-wrap}table{width: 100%;border-collapse: collapse;font-size: 9pt;margin-top: 10px}th{background: #ecf0f1;text-align: left;padding: 8px;border-bottom: 1px solid #BDC3C7;font-weight: bold;color: #2c3e50}td{padding: 8px;border-bottom: 1px solid #eee;vertical-align: top}tr:last-child td{border-bottom: none}.status-Open{color: #c0392b;font-weight: bold}.status-In{color: #f39c12;font-weight: bold}.status-Closed{color: #27ae60;font-weight: bold}.footer{position: fixed;bottom: 0;width: 100%;text-align: center;font-size: 8pt;color: #95a5a6;border-top: 1px solid #eee;padding-top: 10px}</style>
            `;

            const html = `
                <html>
                <head><title>Meeting Export - ${row.id}</title>${styles}</head>
                <body>
                    <div class="header">
                        <img src="https://saathii.in/wp-content/uploads/2021/05/saathii_transparent.png" class="logo" />
                        <div class="title-box">
                            <h1 class="title">Meeting Minutes</h1>
                            <div class="subtitle">Reference: ${row.id}</div>
                        </div>
                    </div>

                    <div class="grid">
                        <div>
                            <div class="field"><div class="label">State</div><div class="value">${row.state || "-"}</div></div>
                            <div class="field"><div class="label">Date of Meeting</div><div class="value">${date}</div></div>
                        </div>
                        <div>
                            ${row.district ? `<div class="field"><div class="label">District</div><div class="value">${row.district}</div></div>` : ''}
                            <div class="field"><div class="label">Meeting Type</div><div class="value">${row.meeting_type || "Quarterly"}</div></div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">Key Agenda & Decisions</div>
                        <div class="field">
                             <div class="label">Key Agenda</div>
                             <div class="content-box">${row.key_agenda || "N/A"}</div>
                        </div>
                        <div class="field" style="margin-top: 10px;">
                             <div class="label">Key Decisions</div>
                             <div class="content-box">${row.key_decisions || "N/A"}</div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">Action Points</div>
                        ${actionPoints.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40%">Action Item</th>
                                    <th style="width: 20%">Responsible</th>
                                    <th style="width: 20%">Timeline</th>
                                    <th style="width: 20%">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${actionPoints.map(ap => `
                                <tr>
                                    <td>${ap.desc}</td>
                                    <td>${ap.resp}</td>
                                    <td>${ap.time}</td>
                                    <td><span class="status-${ap.status.replace(' Progress', '')}">${ap.status}</span></td>
                                </tr>`).join('')}
                            </tbody>
                        </table>` : '<div style="font-style: italic; color: #7f8c8d;">No action points recorded.</div>'}
                    </div>

                    <div class="section">
                         <div class="section-title">Attendance</div>
                         <div class="content-box">
                            <strong>${participants.length} Participants Present:</strong><br/>
                            ${participants.join(', ') || "None recorded"}
                         </div>
                    </div>

                    <div class="footer">
                        Generated by ${user.name} on ${new Date().toLocaleString()} | SAATHII CSS MIS
                    </div>
                </body>
                </html>
            `;

            // 3. Print Execution
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write(html);
            doc.close();

            iframe.contentWindow.focus();
            setTimeout(() => {
                iframe.contentWindow.print();
                setTimeout(() => document.body.removeChild(iframe), 1000); // Cleanup
            }, 500); // Allow images to load

        } catch (e) {
            alert("Failed to generate PDF: " + e.message);
        }
    };

    // Custom DataTable for CRG (Supports inline edit for action_status)
    // --- Skeleton Components ---

    // --- Action Points Details Popup ---
    const ActionPointsPopup = ({ meetingID, type, aggregatedData, user, onClose, onUpdate }) => {
        const { useState, useEffect } = React;
        const [items, setItems] = useState([]);

        useEffect(() => {
            const ap = (aggregatedData.action_points || "").split('; ');
            const rp = (aggregatedData.responsible_person || "").split('; ');
            const tl = (aggregatedData.timeline_for_action || "").split('; ');
            const st = (aggregatedData.action_status || "").split('; ');
            const es = (aggregatedData.escalation_required || "").split('; ');

            const parsed = ap.map((val, i) => ({
                actionID: `${meetingID}-AP${i + 1}`,
                action_points: val,
                responsible_person: rp[i] || '',
                timeline_for_action: tl[i] || '',
                action_status: st[i] || 'Open',
                escalation_required: es[i] || 'No'
            })).filter(item => item.action_points);

            setItems(parsed);
        }, [aggregatedData, meetingID]);

        const updateStatus = async (item, newStatus) => {
            const prev = [...items];
            setItems(items.map(i => i.actionID === item.actionID ? { ...i, action_status: newStatus } : i));

            try {
                const res = await server.updateCRGActionStatus(type, item.actionID, newStatus, user);
                if (res.success) {
                    if (onUpdate) onUpdate();
                } else {
                    setItems(prev);
                    alert(res.error);
                }
            } catch (e) {
                setItems(prev);
                alert(e.message);
            }
        };

        return React.createElement("div", { className: "fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60", onClick: onClose },
            React.createElement("div", { className: "bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[85vh] flex flex-col overflow-hidden", onClick: e => e.stopPropagation() },
                // Header
                React.createElement("div", { className: "px-6 py-4 border-b flex items-center justify-between bg-gradient-to-r from-primary to-secondary text-white" },
                    React.createElement("div", null,
                        React.createElement("h3", { className: "text-lg font-bold" }, "Detailed Action Points"),
                        React.createElement("p", { className: "text-xs opacity-90" }, `Meeting Reference: ${meetingID}`)
                    ),
                    React.createElement("button", { onClick: onClose, className: "w-8 h-8 flex items-center justify-center hover:bg-white/20 rounded-full transition" }, "")
                ),

                // Body
                React.createElement("div", { className: "flex-1 overflow-auto p-6 bg-gray-50" },
                    items.length === 0 ? React.createElement("div", { className: "text-center py-10 text-gray-400" }, "No detailed action points found.") :
                        React.createElement("div", { className: "space-y-4" },
                            items.map((item, idx) => React.createElement("div", { key: item.actionID, className: "p-4 border rounded-xl bg-white shadow-sm border-gray-200" },
                                React.createElement("div", { className: "flex flex-col md:flex-row gap-4 mb-4" },
                                    React.createElement("div", { className: "flex-1" },
                                        React.createElement("div", { className: "text-[10px] uppercase font-bold text-gray-400 mb-1" }, `Item #${idx + 1}`),
                                        React.createElement("div", { className: "text-sm text-gray-800 font-semibold leading-relaxed" }, item.action_points)
                                    ),
                                    React.createElement("div", { className: "w-full md:w-40 shrink-0" },
                                        React.createElement("div", { className: "text-[10px] uppercase font-bold text-gray-400 mb-1" }, "Current Status"),
                                        React.createElement("select", {
                                            className: `w-full p-2 text-xs border rounded-lg font-bold shadow-sm ${item.action_status === 'Closed' ? 'bg-green-50 text-green-700 border-green-200' : item.action_status === 'Open' ? 'bg-red-50 text-red-700 border-red-200' : 'bg-yellow-50 text-yellow-700 border-yellow-200'}`,
                                            value: item.action_status,
                                            onChange: (e) => updateStatus(item, e.target.value)
                                        },
                                            ['Open', 'In Progress', 'Closed'].map(st => React.createElement("option", { key: st, value: st }, st))
                                        )
                                    )
                                ),
                                React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-3" },
                                    React.createElement("div", { className: "flex items-start gap-2" },
                                        React.createElement("div", { className: "w-1.5 h-1.5 rounded-full bg-blue-400 mt-1.5" }),
                                        React.createElement("div", null,
                                            React.createElement("div", { className: "text-[10px] text-gray-400 font-bold uppercase" }, "Responsible"),
                                            React.createElement("div", { className: "text-xs text-gray-700 font-medium" }, item.responsible_person || "Unassigned")
                                        )
                                    ),
                                    React.createElement("div", { className: "flex items-start gap-2" },
                                        React.createElement("div", { className: "w-1.5 h-1.5 rounded-full bg-purple-400 mt-1.5" }),
                                        React.createElement("div", null,
                                            React.createElement("div", { className: "text-[10px] text-gray-400 font-bold uppercase" }, "Timeline"),
                                            React.createElement("div", { className: "text-xs text-gray-700 font-medium" }, item.timeline_for_action || "No deadline")
                                        )
                                    ),
                                    React.createElement("div", { className: "flex items-start gap-2" },
                                        React.createElement("div", { className: "w-1.5 h-1.5 rounded-full bg-orange-400 mt-1.5" }),
                                        React.createElement("div", null,
                                            React.createElement("div", { className: "text-[10px] text-gray-400 font-bold uppercase" }, "Escalation"),
                                            React.createElement("div", { className: "text-xs text-gray-700 font-medium" }, item.escalation_required || "No")
                                        )
                                    )
                                )
                            ))
                        )
                ),

                // Footer
                React.createElement("div", { className: "px-6 py-4 border-t bg-white flex justify-end gap-3" },
                    React.createElement("button", { onClick: onClose, className: "px-5 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm font-semibold" }, "Dismiss")
                )
            )
        );
    };

    const CRGDataTable = ({ right, user, mode }) => {
        const { useState, useEffect, useCallback, useMemo, useContext } = React;
        const { addAlert } = useContext(window.AlertContext || {});
        // Icons
        const Icon = window.Icon || (() => null);
        const DynamicForm = window.DynamicForm;
        const SkeletonRow = window.SkeletonRow || (({ cols }) => React.createElement("div", null, "Loading..."));

        const [data, setData] = useState([]);
        const [total, setTotal] = useState(0);
        const [schema, setSchema] = useState([]);
        const [dropdowns, setDropdowns] = useState({});
        const [loading, setLoading] = useState(true);
        const [page, setPage] = useState(1);
        const [search, setSearch] = useState("");
        const [sort, setSort] = useState({ key: 'id', dir: 'desc' });
        const [viewMode, setViewMode] = useState('list'); // 'list', 'add', 'edit', 'view'
        const [activeRec, setActiveRec] = useState(null);
        const [debouncedSearch, setDebouncedSearch] = useState(search);
        const [isSearchOpen, setIsSearchOpen] = useState(false);
        const [apModal, setApModal] = useState({ open: false, data: null });

        // Column Selection State
        const [selectedColumns, setSelectedColumns] = useState([]);

        // Helper to process dropdowns (copied from index logic simplified)
        const processDropdowns = (raw, sch) => {
            const options = window.processRawDropdownData ? window.processRawDropdownData(raw, sch) : {};

            // FORCE populate State and District if missing (Critical for CRG Module)
            // Function to extract simple list
            const extractList = (key) => {
                if (options[key]) return; // Already exists
                if (!raw || !raw.headers || !raw.data) return;

                // Find header index (case insensitive)
                const idx = raw.headers.findIndex(h => String(h).trim().toLowerCase().replace(/[^a-z0-9]/g, '') === key.toLowerCase());
                if (idx === -1) return;

                const unique = new Set();
                raw.data.forEach(row => {
                    const val = String(row[idx] || '').trim();
                    if (val) unique.add(val);
                });
                options[key] = Array.from(unique).sort();
            };

            // Function to extract Dependent list (District dependent on State)
            const extractDependent = (childKey, parentKey) => {
                if (options[childKey]) return;
                if (!raw || !raw.headers || !raw.data) return;

                const cIdx = raw.headers.findIndex(h => String(h).trim().toLowerCase().replace(/[^a-z0-9]/g, '') === childKey.toLowerCase());
                const pIdx = raw.headers.findIndex(h => String(h).trim().toLowerCase().replace(/[^a-z0-9]/g, '') === parentKey.toLowerCase());

                if (cIdx === -1 || pIdx === -1) return;

                const depMap = {};
                raw.data.forEach(row => {
                    const pVal = String(row[pIdx] || '').trim();
                    const cVal = String(row[cIdx] || '').trim();
                    if (pVal && cVal) {
                        if (!depMap[pVal]) depMap[pVal] = new Set();
                        depMap[pVal].add(cVal);
                    }
                });

                options[childKey] = {};
                Object.keys(depMap).forEach(k => {
                    options[childKey][k] = Array.from(depMap[k]).sort();
                });
            };

            extractList('state');
            extractDependent('district', 'state');

            return options;
        };

        useEffect(() => {
            const h = setTimeout(() => setDebouncedSearch(search), 500);
            return () => clearTimeout(h);
        }, [search]);

        useEffect(() => { setPage(1); }, [debouncedSearch, right.datasheet]);

        useEffect(() => {
            if (schema.length > 0 && selectedColumns.length === 0) {
                const defaults = schema.filter(c => !c.hideColumn).map(c => c.key);
                setSelectedColumns(defaults);
            }
        }, [schema]);

        const fetchData = useCallback(async () => {
            setLoading(true);
            try {
                // Fetch Schema & Dropdowns if needed
                if (schema.length === 0) {
                    const [s, d] = await Promise.all([
                        server.getSchema(right.schema),
                        server.getDropdownOptions()
                    ]);
                    if (s.error) throw new Error(s.error);

                    // FIX: Force 'participants' column to be visible for Meetings
                    if (right.datasheet && right.datasheet.includes('Meetings')) {
                        const pIdx = s.findIndex(c => c.key === 'participants');
                        if (pIdx > -1) {
                            s[pIdx].hideColumn = false;
                        }
                    }

                    setSchema(s);
                    // Init selected columns
                    const defaults = s.filter(c => !c.hideColumn).map(c => c.key);
                    setSelectedColumns(defaults);

                    if (!d.error) setDropdowns(processDropdowns(d, s));
                }

                const params = {
                    username: user.username,
                    userType: user.userType,
                    userSR: user.sr,
                    userState: user.state,
                    datasheetName: right.datasheet,
                    schemaName: right.schema,
                    page: page,
                    pageSize: 25,
                    search: debouncedSearch,
                    sortKey: sort.key,
                    sortDir: sort.dir
                };
                const res = await server.getPaginatedData(params);
                if (res.error) throw new Error(res.error);
                setData(res.data);
                setTotal(res.totalRecords);
            } catch (e) {
                if (addAlert) addAlert(e.message, 'error');
            } finally {
                setLoading(false);
            }
        }, [right, user, page, debouncedSearch, sort]);

        useEffect(() => {
            setSchema([]); // Reset schema when switching tabs/datasheets
            setData([]);
            setSelectedColumns([]); // Reset selection
            fetchData();
        }, [right.datasheet, fetchData]);

        const handleSave = async (record) => {
            if (addAlert) addAlert("Saving...", "info");
            try {
                let res;
                if (right.datasheet && right.datasheet.includes('Meetings')) {
                    const type = right.datasheet.includes('State') ? 'State' : 'District';
                    // Extract arrays for backend processing
                    const attendance = record.participants || [];
                    const actions = record.action_points || record.action_ponts || []; // Support both spellings for compatibility

                    res = await server.saveMeetingData(type, record, attendance, actions, user);
                } else {
                    res = viewMode === 'add'
                        ? await server.addRecord(record, right.datasheet, schema, user)
                        : await server.editRecord(record.id, record, right.datasheet, schema, user);
                }

                if (res && res.success) {
                    if (addAlert) addAlert(res.message || "Saved successfully", 'success');

                    if (right.datasheet && right.datasheet.includes('Meetings')) {
                        // For Custom Meetings, just reload data to ensure sync
                        fetchData();
                        setViewMode('list');
                    } else {
                        // Standard Optimistic Update
                        const realRec = res.savedData;
                        realRec.id = res.id;
                        if (viewMode === 'add') {
                            setData(prev => [realRec, ...prev]);
                            setTotal(t => t + 1);
                        } else {
                            setData(prev => prev.map(r => r.id === realRec.id ? realRec : r));
                        }
                        setViewMode('list');
                    }
                } else throw new Error(res.error);
            } catch (e) {
                if (addAlert) addAlert(e.message, 'error');
            }
        };

        const handleDelete = async (id) => {
            if (!confirm("Are you sure?")) return;
            const prevData = [...data];
            setData(d => d.filter(r => r.id !== id));
            if (addAlert) addAlert("Deleting...", "info");
            try {
                const res = await server.deleteRecord(id, right.datasheet, user);
                if (res && res.success) {
                    if (addAlert) addAlert("Deleted successfully", 'success');
                } else {
                    setData(prevData);
                    if (addAlert) addAlert(res.error, 'error');
                }
            } catch (e) {
                setData(prevData);
                if (addAlert) addAlert(e.message, "error");
            }
        };

        const handleInlineStatusChange = async (id, newStatus) => {
            // Optimistic Update
            const prevData = [...data];
            const rec = data.find(r => r.id === id);
            if (!rec) return;

            const updated = { ...rec, action_status: newStatus };
            setData(d => d.map(r => r.id === id ? updated : r));

            try {
                const res = await server.editRecord(id, updated, right.datasheet, schema, user);
                if (!res.success) {
                    setData(prevData);
                    if (addAlert) addAlert(res.error, 'error');
                }
            } catch (e) {
                setData(prevData);
                if (addAlert) addAlert("Update Failed: " + e.message, 'error');
            }
        };

        const handleExport = async () => {
            if (addAlert) addAlert("Preparing export...", "info");
            try {
                const params = {
                    username: user.username,
                    userType: user.userType,
                    userSR: user.sr,
                    userState: user.state,
                    datasheetName: right.datasheet,
                    schemaName: right.schema,
                    search: debouncedSearch,
                    sortKey: sort.key,
                    sortDir: sort.dir
                };
                const res = await server.exportData(params);
                if (res && res.success) {
                    const link = document.createElement('a');
                    link.href = 'data:text/csv;base64,' + res.csv;
                    link.download = `${right.datasheet}_export.csv`;
                    link.click();
                    if (addAlert) addAlert("Export downloaded", "success");
                } else if (addAlert) addAlert(res.error, "error");
            } catch (e) {
                if (addAlert) addAlert(e.message, "error");
            }
        };

        const visibleCols = useMemo(() => {
            return schema.filter(c => selectedColumns.includes(c.key));
        }, [schema, selectedColumns]);

        const columnOptions = useMemo(() => {
            return schema.filter(c => !c.hideColumn).map(c => ({ label: c.label || c.key, value: c.key }));
        }, [schema]);

        const totalPages = Math.ceil(total / 25) || 1;

        // Custom Cell Renderer
        const renderCell = (row, col) => {
            const val = row[col.key];
            // Handle both spellings to support legacy schema typos
            if ((col.key === 'action_points' || col.key === 'action_ponts') && (right.datasheet || '').includes('Meetings')) {
                return React.createElement("div", {
                    className: "text-blue-600 hover:text-blue-800 cursor-pointer font-bold decoration-blue-300 underline underline-offset-4 decoration-dashed flex items-center gap-1",
                    onClick: (e) => {
                        e.stopPropagation();
                        setApModal({
                            open: true,
                            data: {
                                meetingID: row.id,
                                aggregatedData: {
                                    action_points: row.action_points,
                                    responsible_person: row.responsible_person || '',
                                    timeline_for_action: row.timeline_for_action || '',
                                    action_status: row.action_status || '',
                                    escalation_required: row.escalation_required || ''
                                }
                            }
                        });
                    }
                },
                    React.createElement(Icon, { name: "external-link", className: "w-3 h-3" }),
                    val && val.length > 50 ? val.substring(0, 50) + "..." : (val || "View Details")
                );
            }
            if (col.key === 'action_status' && right.edit === 'allow') {
                // Inline Edit for action_status
                const options = ['Open', 'In Progress', 'Closed'];
                return React.createElement("select", {
                    className: `p-1 text-xs border rounded ${val === 'Closed' ? 'bg-green-50 text-green-700' : val === 'Open' ? 'bg-red-50 text-red-700' : 'bg-yellow-50 text-yellow-700'}`,
                    value: val || '',
                    onClick: e => e.stopPropagation(), // prevent row click
                    onChange: e => handleInlineStatusChange(row.id, e.target.value)
                }, options.map(o => React.createElement("option", { key: o, value: o }, o)));
            }
            if (col.key === 'participants') {
                const names = val ? String(val).split(',').map(s => s.trim()).filter(Boolean) : [];
                const count = names.length;
                return React.createElement("div", {
                    className: "flex items-center gap-1 text-xs",
                    title: names.join('\n') // Tooltip with full names
                },
                    React.createElement(Icon, { name: "users", className: "w-3 h-3 text-gray-500" }),
                    React.createElement("span", { className: "font-medium text-gray-700" }, `${count} Participant${count !== 1 ? 's' : ''}`)
                );
            }
            if (col.type === 'date') return window.ensureDDMMMYYYY ? window.ensureDDMMMYYYY(val) : val;
            return val;
        };

        return React.createElement("div", { className: "h-[calc(100vh-140px)] flex flex-col" },
            viewMode === 'list' ? React.createElement(React.Fragment, null,
                // Toolbar
                React.createElement("div", { className: "mb-4 bg-white p-3 rounded shadow-sm border border-gray-200 flex flex-col md:flex-row items-center justify-between gap-3" },
                    React.createElement("div", { className: "flex items-center gap-4 flex-1" },
                        React.createElement("h2", { className: "text-lg font-bold text-gray-800" }, right.datasheetTitle || right.datasheet),
                        // Column Selector
                        React.createElement(window.MultiSelectDropdown, {
                            options: columnOptions,
                            selected: selectedColumns,
                            onChange: setSelectedColumns,
                            placeholder: "Select Columns",
                            showChips: false,
                            small: true,
                            selectedLabel: "Columns"
                        })
                    ),
                    React.createElement("div", { className: "flex items-center gap-2" },
                        // Search
                        isSearchOpen ? React.createElement("div", { className: "flex items-center bg-white border border-primary rounded shadow-sm animate-fade-in" },
                            React.createElement("input", {
                                autoFocus: true,
                                type: "text",
                                placeholder: "Search...",
                                className: "pl-2 pr-2 py-1 text-sm outline-none w-40 text-gray-700",
                                value: search,
                                onChange: e => setSearch(e.target.value),
                                onBlur: () => !search && setIsSearchOpen(false)
                            }),
                            React.createElement("button", { onClick: () => { setSearch(''); setIsSearchOpen(false); }, className: "p-1 text-gray-400 hover:text-danger" }, "x")
                        ) : React.createElement("button", {
                            onClick: () => setIsSearchOpen(true),
                            className: "p-2 text-gray-500 hover:text-primary bg-gray-50 rounded-full", title: "Search"
                        }, React.createElement(Icon, { name: "search" })),

                        // Add Button
                        right.edit === 'allow' && React.createElement("button", {
                            onClick: () => { setActiveRec(null); setViewMode('add'); },
                            className: "flex items-center justify-center w-8 h-8 bg-primary text-white rounded-full shadow hover:bg-opacity-90 transition",
                            title: `Add ${right.datasheetTitle || 'Record'}`
                        }, React.createElement(Icon, { name: "plus", className: "w-5 h-5" })),

                        // Export Button
                        React.createElement("button", {
                            onClick: handleExport,
                            className: "flex items-center justify-center w-8 h-8 bg-blue-500 text-white rounded-full shadow hover:bg-blue-600 transition",
                            title: "Export"
                        }, React.createElement(Icon, { name: "download" }))
                    )
                ),

                // Table
                React.createElement("div", { className: "bg-white rounded-lg shadow border border-gray-200 flex-1 overflow-hidden flex flex-col" },
                    React.createElement("div", { className: "overflow-auto flex-1" },
                        React.createElement("table", { className: "min-w-full divide-y divide-gray-200" },
                            React.createElement("thead", { className: "bg-gradient-to-b from-primary to-secondary text-white sticky top-0 z-40" },
                                React.createElement("tr", null,
                                    visibleCols.map(col => React.createElement("th", {
                                        key: col.key,
                                        className: "px-4 py-3 text-left text-xs font-bold uppercase tracking-wider cursor-pointer hover:bg-white/10 align-bottom",
                                        style: { minWidth: (col.key === 'id' || col.key === 'sr') ? '80px' : '160px' },
                                        onClick: () => setSort({ key: col.key, dir: sort.key === col.key && sort.dir === 'asc' ? 'desc' : 'asc' })
                                    }, React.createElement("div", { className: "header-clamp", title: col.label }, col.label))),
                                    React.createElement("th", { className: "px-4 py-3 text-right text-xs font-bold uppercase tracking-wider sticky right-0 bg-secondary z-50 align-bottom" }, "Actions")
                                )
                            ),
                            React.createElement("tbody", { className: "divide-y divide-gray-200 bg-white" },
                                loading ? Array.from({ length: 25 }).map((_, i) => React.createElement(SkeletonRow, { key: i, cols: visibleCols })) :
                                    data.length === 0 ? React.createElement("tr", null, React.createElement("td", { colSpan: "100", className: "p-12 text-center text-gray-400" }, "No records found.")) :
                                        data.map(row => React.createElement("tr", { key: row.id, className: "hover:bg-gray-50 group" },
                                            visibleCols.map(col => React.createElement("td", { key: col.key, className: "px-4 py-2 text-gray-700 text-sm align-middle" },
                                                React.createElement("div", { className: "header-clamp", title: row[col.key] }, renderCell(row, col))
                                            )),
                                            React.createElement("td", { className: "px-4 py-2 whitespace-nowrap text-right sticky right-0 bg-white group-hover:bg-gray-50 border-l" },
                                                React.createElement("div", { className: "flex justify-end gap-2" },
                                                    // PDF Export Button (Meetings Only)
                                                    (right.datasheet && right.datasheet.includes('Meetings')) && React.createElement("button", {
                                                        onClick: (e) => { e.stopPropagation(); generateMeetingPDF(row, user, right.datasheetTitle); },
                                                        className: "text-red-600 hover:text-red-800 bg-red-50 px-1.5 py-0.5 rounded hover:bg-red-100 transition text-[10px] font-bold border border-red-100 flex items-center leading-none",
                                                        title: "Export Minutes (PDF)"
                                                    }, "PDF"),

                                                    right.edit === 'allow' && React.createElement("button", { onClick: () => { setActiveRec(row); setViewMode('edit'); }, className: "text-blue-500 hover:text-blue-700" }, React.createElement(Icon, { name: "edit" })),
                                                    right.delete === 'allow' && React.createElement("button", { onClick: () => handleDelete(row.id), className: "text-red-500 hover:text-red-700" }, React.createElement(Icon, { name: "trash" }))
                                                )
                                            )
                                        ))
                            )
                        )
                    ),
                    // Pagination
                    React.createElement("div", { className: "bg-gray-50 border-t border-gray-200 px-4 py-2 text-xs text-gray-500 flex items-center justify-between" },
                        React.createElement("span", null, `Showing ${data.length}/${total}`),
                        React.createElement("div", { className: "flex items-center gap-2" },
                            React.createElement("button", { disabled: page === 1, onClick: () => setPage(p => p - 1), className: "disabled:opacity-50" }, "Prev"),
                            React.createElement("span", null, `${page} / ${totalPages}`),
                            React.createElement("button", { disabled: page >= totalPages, onClick: () => setPage(p => p + 1), className: "disabled:opacity-50" }, "Next")
                        )
                    )
                ),
                apModal.open && React.createElement(ActionPointsPopup, {
                    meetingID: apModal.data.meetingID,
                    type: mode,
                    aggregatedData: apModal.data.aggregatedData,
                    user: user,
                    onClose: () => setApModal({ open: false, data: null }),
                    onUpdate: () => fetchData()
                })
            ) : ((viewMode === 'add' || viewMode === 'edit') && right.datasheet.includes('Meetings')) ? (
                React.createElement(MeetingForm, {
                    key: `${viewMode}-${activeRec?.id || 'new'}`,
                    user: user,
                    datasheet: right.datasheet,
                    dropdowns: dropdowns,
                    onSave: handleSave,
                    onCancel: () => setViewMode('list'),
                    mode: viewMode,
                    initialData: viewMode === 'edit' ? activeRec : null
                })
            ) : (DynamicForm && React.createElement(DynamicForm, {
                schema: schema,
                dropdowns: dropdowns,
                user: user,
                initialData: activeRec,
                mode: viewMode,
                datasheet: right.datasheet,
                onSave: handleSave,
                onCancel: () => setViewMode('list'),
                inline: true
            }))
        );
    };



    // Main CRG Module
    const CRGModule = ({ mode, user, initialTab }) => {
        const { useState, useEffect, useMemo } = React;
        // Tabs: Nomination | Meetings | ActionPoints
        const tabs = [
            { id: 'nomination', label: 'Nomination', suffix: 'Nomination' },
            { id: 'meeting', label: 'Meetings', suffix: 'Meetings' }
        ];

        const [activeTab, setActiveTab ] = useState(initialTab || 'nomination');

        // Determine permissions for current tab
        // Schema Naming Convention: "{mode}_{Suffix}" e.g. "State_Nomination"
        const currentSuffix = tabs.find(t => t.id === activeTab)?.suffix;
        const targetDatasheet = `${mode}_${currentSuffix}`; // e.g. State_Nomination

        const DATASHEET_CONFIG = {
            'State_Nomination': { schema: 'Schema_State_Nomination', title: 'State Nomination / Members', group: 'State CRG' },
            'State_Meetings': { schema: 'Schema_State_Meetings', title: 'State Meetings & Minutes', group: 'State CRG' },
            'District_Nomination': { schema: 'Schema_District_Nomination', title: 'District Nomination / Members', group: 'District CRG' },
            'District_Meetings': { schema: 'Schema_District_Meetings', title: 'District Meetings & Minutes', group: 'District CRG' }
        };
        const config = DATASHEET_CONFIG[targetDatasheet];

        // Find permission in user.accessRights
        // CONFIG OVERRIDE: We trust our local config for Schema/Title over backend metadata if available.
        let permission = (user.accessRights || []).find(r =>
            (r.datasheet || '').toLowerCase() === targetDatasheet.toLowerCase() ||
            (r.datasheetTitle || '').toLowerCase() === targetDatasheet.toLowerCase() ||
            (config && (r.datasheetTitle || '').toLowerCase() === config.title.toLowerCase())
        );

        // Superadmin or Config Fallback
        if (!permission && user.userType === 'superadmin') {
            permission = {
                datasheet: targetDatasheet,
                datasheetTitle: config ? config.title : targetDatasheet.replace(/_/g, ' '),
                schema: config ? config.schema : 'Schema_' + targetDatasheet,
                edit: 'allow',
                delete: 'allow'
            };
        }

        // Force apply Config (Fix for potential metadata mismatch or caching issues)
        if (permission && config) {
            permission = {
                ...permission,
                schema: config.schema,
                datasheetTitle: config.title,
                group: config.group
            };
        }

        // If no permission, do we hide tab or show error?
        // User map shows all tabs for 'csso1', so likely we show tabs and error content if no access.

        return React.createElement("div", { className: "p-4 h-full flex flex-col bg-gray-50" },
            // Header & Tabs
            React.createElement("div", { className: "mb-4" },
                React.createElement("h1", { className: "text-2xl font-bold text-primary mb-4" }, `${mode} CRG Management`),
                React.createElement("div", { className: "flex space-x-1 border-b border-gray-300" },
                    tabs.map(tab => React.createElement("button", {
                        key: tab.id,
                        onClick: () => setActiveTab(tab.id),
                        className: `px-4 py-2 text-sm font-medium rounded-t-lg transition-colors border-t border-l border-r ${activeTab === tab.id ? 'bg-white border-gray-300 border-b-white text-primary' : 'bg-gray-100 border-transparent text-gray-500 hover:text-gray-700'}`
                    }, tab.label))
                )
            ),

            // Content
            React.createElement("div", { className: "flex-1 bg-white p-4 border border-t-0 border-gray-300 rounded-b-lg shadow-sm" },
                permission ? React.createElement(CRGDataTable, {
                    key: targetDatasheet, // force remount on tab switch
                    right: permission,
                    user: user,
                    mode: mode
                }) : React.createElement("div", { className: "text-center text-red-500 py-10" },
                    `Access Denied: You do not have permission to view ${targetDatasheet}`
                )
            )
        );
    };

    window.CRGModule = CRGModule;
</script>

    <script>
        const {
            useState,
            useEffect,
            useContext,
            createContext,
            useMemo,
            useCallback
        } = React;
        const server = new Proxy({}, {
            get: (_, fnName) => (...args) => new Promise((resolve, reject) => {
                if (!google.script) {
                    setTimeout(() => resolve({
                        success: true,
                        data: [],
                        totalRecords: 0
                    }), 500);
                    return;
                }
                google.script.run.withSuccessHandler(resolve).withFailureHandler(e => reject(new Error(e.message)))[fnName](...args);
            })
        });
        const AuthContext = createContext(null);
        window.AuthContext = AuthContext;
        const AlertContext = createContext(null);
        window.AlertContext = AlertContext;
        const Icon = ({
            name,
            className = "w-5 h-5"
        }) => {
            const icons = {
                menu: React.createElement("path", {
                    d: "M4 6h16M4 12h16M4 18h16"
                }),
                close: React.createElement("path", {
                    d: "M18 6L6 18M6 6l12 12"
                }),
                logout: React.createElement("path", {
                    d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14l5-5-5-5m5 5H9"
                }),
                plus: React.createElement("path", {
                    d: "M12 5v14m-7-7h14"
                }),
                home: React.createElement("g", null, React.createElement("path", {
                    d: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"
                }), React.createElement("polyline", {
                    points: "9 22 9 12 15 12 15 22"
                })),
                edit: React.createElement("path", {
                    d: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                }),
                trash: React.createElement("path", {
                    d: "M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                }),
                download: React.createElement("path", {
                    d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m7-10l5 5m0 0l-5 5m5-5H3"
                }),
                prev: React.createElement("path", {
                    d: "M15 18l-6-6 6-6"
                }),
                next: React.createElement("path", {
                    d: "M9 18l6-6-6-6"
                }),
                search: React.createElement("path", {
                    d: "M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"
                }),
                eye: React.createElement("g", null, React.createElement("path", {
                    d: "M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                }), React.createElement("circle", {
                    cx: "12",
                    cy: "12",
                    r: "3"
                })),
                chevronLeft: React.createElement("path", {
                    d: "M15 18l-6-6 6-6"
                }),
                users: React.createElement("g", null, React.createElement("path", {
                    d: "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                }), React.createElement("circle", {
                    cx: "9",
                    cy: "7",
                    r: "4"
                }), React.createElement("path", {
                    d: "M23 21v-2a4 4 0 0 0-3-3.87"
                }), React.createElement("path", {
                    d: "M16 3.13a4 4 0 0 1 0 7.75"
                })),
                settings: React.createElement("g", null, React.createElement("circle", {
                    cx: "12",
                    cy: "12",
                    r: "3"
                }), React.createElement("path", {
                    d: "M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"
                }))
            };
            return React.createElement("svg", {
                xmlns: "http://www.w3.org/2000/svg",
                width: "24",
                height: "24",
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            }, icons[name] || null);
        };
        window.Icon = Icon;

        // PWA Install Prompt Management
        const PWAInstallContext = createContext(null);

        const PWAInstallProvider = ({ children }) => {
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [showBanner, setShowBanner] = useState(false);
            const [isInstalled, setIsInstalled] = useState(false);

            useEffect(() => {
                // Check if already installed
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                    setIsInstalled(true);
                    return;
                }

                // Check if user dismissed recently (within 7 days)
                const dismissedTime = localStorage.getItem('pwa-install-dismissed');
                if (dismissedTime) {
                    const daysSinceDismissed = (Date.now() - parseInt(dismissedTime)) / (1000 * 60 * 60 * 24);
                    if (daysSinceDismissed < 7) {
                        return; // Don't show banner
                    }
                }

                // Listen for beforeinstallprompt event
                const handleBeforeInstall = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                    setShowBanner(true);
                };

                // Listen for successful install
                const handleAppInstalled = () => {
                    setIsInstalled(true);
                    setShowBanner(false);
                    setDeferredPrompt(null);
                    localStorage.removeItem('pwa-install-dismissed');
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstall);
                window.addEventListener('appinstalled', handleAppInstalled);

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstall);
                    window.removeEventListener('appinstalled', handleAppInstalled);
                };
            }, []);

            const handleInstall = async () => {
                if (!deferredPrompt) return;

                // Handle installation
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;

                setDeferredPrompt(null);
                setShowBanner(false);
            };

            const handleDismiss = () => {
                setShowBanner(false);
                localStorage.setItem('pwa-install-dismissed', Date.now().toString());
            };

            return React.createElement(PWAInstallContext.Provider, {
                value: { deferredPrompt, showBanner, isInstalled, handleInstall, handleDismiss }
            }, children);
        };

        // Install Banner Component
        const InstallBanner = () => {
            const { showBanner, handleInstall, handleDismiss } = useContext(PWAInstallContext);

            if (!showBanner) return null;

            return React.createElement('div', {
                className: 'fixed top-0 left-0 right-0 z-[999] animate-slide-down'
            },
                React.createElement('div', {
                    className: 'bg-gradient-to-r from-primary to-secondary text-white px-4 py-3 shadow-lg backdrop-blur-md border-b border-white/20'
                },
                    React.createElement('div', {
                        className: 'max-w-7xl mx-auto flex items-center justify-between gap-4'
                    },
                        React.createElement('div', {
                            className: 'flex items-center gap-3 flex-1'
                        },
                            React.createElement('svg', {
                                className: 'w-6 h-6 flex-shrink-0',
                                fill: 'none',
                                stroke: 'currentColor',
                                viewBox: '0 0 24 24'
                            },
                                React.createElement('path', {
                                    strokeLinecap: 'round',
                                    strokeLinejoin: 'round',
                                    strokeWidth: 2,
                                    d: 'M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z'
                                })
                            ),
                            React.createElement('div', {
                                className: 'flex-1'
                            },
                                React.createElement('p', {
                                    className: 'font-semibold text-sm md:text-base'
                                }, 'Install SAATHII CSS MIS'),
                                React.createElement('p', {
                                    className: 'text-xs md:text-sm text-white/90 hidden sm:block'
                                }, 'Add to your home screen for quick access and offline support')
                            )
                        ),
                        React.createElement('div', {
                            className: 'flex items-center gap-2'
                        },
                            React.createElement('button', {
                                onClick: handleInstall,
                                className: 'px-4 py-2 bg-white text-primary rounded-lg font-semibold text-sm hover:bg-white/90 transition shadow-md whitespace-nowrap'
                            }, 'Install'),
                            React.createElement('button', {
                                onClick: handleDismiss,
                                className: 'p-2 hover:bg-white/10 rounded-lg transition',
                                'aria-label': 'Dismiss'
                            },
                                React.createElement(Icon, { name: 'close', className: 'w-5 h-5' })
                            )
                        )
                    )
                )
            );
        };

        // Install Button for Header (to be used in MainLayout)
        const InstallButton = ({ className = '' }) => {
            const pwaContext = useContext(PWAInstallContext);

            if (!pwaContext || pwaContext.isInstalled || !pwaContext.deferredPrompt) return null;

            return React.createElement('button', {
                onClick: pwaContext.handleInstall,
                className: `flex items-center gap-2 px-3 py-2 rounded-lg bg-primary/10 text-primary hover:bg-primary/20 transition ${className}`,
                title: 'Install App'
            },
                React.createElement('svg', {
                    className: 'w-5 h-5',
                    fill: 'none',
                    stroke: 'currentColor',
                    viewBox: '0 0 24 24'
                },
                    React.createElement('path', {
                        strokeLinecap: 'round',
                        strokeLinejoin: 'round',
                        strokeWidth: 2,
                        d: 'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4'
                    })
                ),
                React.createElement('span', {
                    className: 'text-sm font-medium hidden md:inline'
                }, 'Install App')
            );
        };

        window.InstallButton = InstallButton;

        const ToastContext = createContext(null);
        window.ToastContext = ToastContext;

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);

            const addToast = useCallback((msg, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => removeToast(id), 5000);
            }, []);

            const removeToast = useCallback((id) => {
                setToasts(prev => prev.map(t => t.id === id ? { ...t, exiting: true } : t));
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 300);
            }, []);

            return React.createElement(AlertContext.Provider, { value: { addAlert: addToast } },
                children,
                React.createElement("div", { className: "fixed top-4 right-4 z-[100] flex flex-col gap-3 pointer-events-none" },
                    toasts.map(t => React.createElement("div", {
                        key: t.id,
                        className: `pointer-events-auto px-4 py-3 rounded-lg shadow-glass text-white text-sm min-w-[250px] flex items-center gap-3 backdrop-blur-md border border-white/20 ${t.exiting ? 'animate-fade-out' : 'animate-slide-in-right'
                            } ${t.type === 'error' ? 'bg-red-500/90' : t.type === 'success' ? 'bg-green-500/90' : 'bg-blue-500/90'}`,
                        onClick: () => removeToast(t.id)
                    },
                        React.createElement(Icon, { name: t.type === 'error' ? 'close' : 'menu', className: "w-4 h-4 opacity-80" }), // Simplified icon mapping
                        React.createElement("span", { className: "font-medium" }, t.msg)
                    ))
                )
            );
        };

        const SkeletonCard = () => React.createElement("div", { className: "dash-card h-40 animate-pulse border-gray-100" },
            React.createElement("div", { className: "h-4 w-24 bg-gray-200 rounded mb-4" }),
            React.createElement("div", { className: "h-8 w-16 bg-gray-300 rounded mb-auto" }),
            React.createElement("div", { className: "h-px w-full bg-gray-100 my-4" }),
            React.createElement("div", { className: "h-4 w-20 bg-gray-200 rounded ml-auto" })
        );
        window.SkeletonCard = SkeletonCard;
        window.SkeletonCard = SkeletonCard;

        const SkeletonRow = ({ cols }) => React.createElement("tr", { className: "animate-pulse" },
            cols.map((_, i) => React.createElement("td", { key: i, className: "px-4 py-3" },
                React.createElement("div", { className: "h-4 bg-gray-200 rounded w-full opacity-50" })
            )),
            React.createElement("td", { className: "px-4 py-3" },
                React.createElement("div", { className: "h-4 bg-gray-200 rounded w-8 ml-auto" })
            )
        );
        window.SkeletonRow = SkeletonRow;
        const formatDateToDDMMMYYYY = dateInput => {
            let date = null;
            if (dateInput instanceof Date && !isNaN(dateInput)) {
                date = dateInput;
            } else if (typeof dateInput === 'string' && dateInput.trim() !== '') {
                if (/^\d{4}-\d{2}-\d{2}(T.*Z?)?$/.test(dateInput)) {
                    try {
                        date = new Date(dateInput);
                    } catch (e) { }
                } else if (/^\d{2}-[A-Za-z]{3}-\d{4}$/.test(dateInput)) {
                    return dateInput;
                } else {
                    try {
                        date = new Date(dateInput);
                    } catch (e) { }
                }
            }
            if (!(date instanceof Date) || isNaN(date)) return null;
            try {
                const day = String(date.getUTCDate()).padStart(2, '0');
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = months[date.getUTCMonth()];
                const year = date.getUTCFullYear();
                if (!month || isNaN(day) || isNaN(year) || year < 1900) return null;
                return `${day}-${month}-${year}`;
            } catch (e) {
                return null;
            }
        };
        const ensureDDMMMYYYY = dateInput => {
            if (!dateInput) return '';
            return formatDateToDDMMMYYYY(dateInput) || '';
        };
        const processRawDropdownData = (rawDropdownSheetData, schema) => {
            const options = {};
            if (!rawDropdownSheetData || !Array.isArray(rawDropdownSheetData.headers) || !Array.isArray(rawDropdownSheetData.data) || !Array.isArray(schema)) {
                return options;
            }
            const {
                headers: ddHeaders,
                data: ddData
            } = rawDropdownSheetData;
            const sanitize = str => String(str).trim().toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/^(\d)/, '_$1');
            const ddHeaderIndexMap = {};
            ddHeaders.forEach((h, i) => {
                const key = sanitize(h);
                if (key && !ddHeaderIndexMap.hasOwnProperty(key)) ddHeaderIndexMap[key] = i;
            });
            const dropdownFieldsInSchema = schema.filter(col => col.dropdown);
            if (dropdownFieldsInSchema.length === 0) return {};
            dropdownFieldsInSchema.forEach(colSchema => {
                options[colSchema.key] = colSchema.parentId || colSchema.parentId2 ? {} : [];
                const childColKey = colSchema.key;
                const parentColKey = colSchema.parentId;
                const childColIndex = ddHeaderIndexMap[childColKey];
                if (childColIndex === undefined) return;
                if (!parentColKey) {
                    const uniqueOptions = new Set();
                    ddData.forEach(row => {
                        if (Array.isArray(row) && childColIndex < row.length) {
                            const val = String(row[childColIndex] || '').trim();
                            if (val) uniqueOptions.add(val);
                        }
                    });
                    options[childColKey] = Array.from(uniqueOptions).sort();
                } else {
                    const parentColIndex = ddHeaderIndexMap[parentColKey];
                    if (parentColIndex === undefined) {
                        return;
                    }
                    const dependentOptionsMap = {};
                    ddData.forEach(row => {
                        if (Array.isArray(row) && parentColIndex < row.length && childColIndex < row.length) {
                            const parentValue = String(row[parentColIndex] || '').trim();
                            const childValue = String(row[childColIndex] || '').trim();
                            if (parentValue && childValue) {
                                if (!dependentOptionsMap[parentValue]) {
                                    dependentOptionsMap[parentValue] = new Set();
                                }
                                dependentOptionsMap[parentValue].add(childValue);
                            }
                        }
                    });
                    Object.keys(dependentOptionsMap).forEach(pv => {
                        options[childColKey][pv] = Array.from(dependentOptionsMap[pv]).sort();
                    });
                }
            });
            return options;
        };
        // Expose for CRG Module
        window.processRawDropdownData = processRawDropdownData;

        const Login = () => {
            const {
                login
            } = useContext(AuthContext);
            const [creds, setCreds] = useState({
                u: '',
                p: ''
            });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const handleSubmit = async e => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await login(creds.u, creds.p);
                } catch (err) {
                    setError(err.message || "Login failed");
                } finally {
                    setLoading(false);
                }
            };
            return React.createElement("div", {
                className: "min-h-screen flex items-center justify-center bg-gray-50 p-4 relative"
            },
                // Logo
                React.createElement("img", {
                    src: "https://saathii.in/wp-content/uploads/2021/05/saathii_transparent.png",
                    className: "absolute top-4 left-4 h-16 w-auto bg-white p-2 rounded-lg shadow-md opacity-90 hover:opacity-100 transition-all",
                    alt: "SAATHII Logo"
                }),
                React.createElement("div", {
                    className: "bg-white p-8 rounded-xl shadow-xl w-full max-w-sm border border-gray-100"
                }, React.createElement("h1", {
                    className: "text-3xl font-bold text-primary mb-2 text-center"
                }, "SAATHII CSS MIS"), React.createElement("p", {
                    className: "text-gray-500 text-center mb-6 text-sm"
                }, "Please sign in to continue"), React.createElement("form", {
                    onSubmit: handleSubmit,
                    className: "space-y-4"
                }, React.createElement("div", null, React.createElement("label", {
                    className: "block text-xs font-bold text-gray-700 uppercase mb-1"
                }, "Username"), React.createElement("input", {
                    className: "w-full p-2.5 border rounded focus:ring-2 focus:ring-primary outline-none transition bg-white/50 focus:bg-white",
                    value: creds.u,
                    onChange: e => setCreds({
                        ...creds,
                        u: e.target.value
                    })
                })), React.createElement("div", null, React.createElement("label", {
                    className: "block text-xs font-bold text-gray-700 uppercase mb-1"
                }, "Password"), React.createElement("input", {
                    type: "password",
                    className: "w-full p-2.5 border rounded focus:ring-2 focus:ring-primary outline-none transition bg-white/50 focus:bg-white",
                    value: creds.p,
                    onChange: e => setCreds({
                        ...creds,
                        p: e.target.value
                    })
                })), error && React.createElement("div", {
                    className: "p-2 bg-red-50 text-danger text-xs rounded text-center border border-red-100"
                }, error), React.createElement("button", {
                    disabled: loading,
                    className: "w-full bg-gradient-to-r from-primary to-secondary text-white py-2.5 rounded hover:opacity-90 disabled:opacity-50 transition font-medium shadow-lg transform hover:-translate-y-0.5"
                }, loading ? 'Authenticating...' : 'Sign In'))));
        };
        window.Login = Login;
        const CollapsibleMultiSelect = ({ options, value, onChange, disabled, placeholder }) => {
            const [open, setOpen] = useState(false);
            const ref = React.useRef(null);
            useEffect(() => {
                const clickOutside = (e) => {
                    if (ref.current && !ref.current.contains(e.target)) setOpen(false);
                };
                document.addEventListener("mousedown", clickOutside);
                return () => document.removeEventListener("mousedown", clickOutside);
            }, []);
            const curVals = (value || '').split(',').map(s => s.trim()).filter(Boolean);
            const toggle = (opt) => {
                const next = curVals.includes(opt) ? curVals.filter(v => v !== opt) : [...curVals, opt];
                onChange(next.join(', '));
            };
            return React.createElement("div", { ref: ref, className: "relative w-full" },
                React.createElement("div", {
                    onClick: () => !disabled && setOpen(!open),
                    className: `w-full p-1.5 text-sm border rounded flex justify-between items-center cursor-pointer transition ${disabled ? 'bg-gray-100 text-gray-500' : 'bg-white hover:border-primary'}`
                },
                    React.createElement("span", { className: "truncate pr-2" }, curVals.length > 0 ? curVals.join(', ') : (placeholder || 'Select Options...')),
                    React.createElement("span", { className: `text-[10px] transition-transform ${open ? 'rotate-180' : ''}` }, "")
                ),
                open && React.createElement("div", {
                    className: "absolute z-50 w-full mt-1 bg-white border border-gray-200 shadow-xl rounded-lg max-h-48 overflow-y-auto p-2"
                },
                    options.length > 0 ? options.map(opt => React.createElement("label", {
                        key: opt,
                        className: "flex items-center gap-2 mb-1.5 cursor-pointer hover:bg-gray-50 p-1 rounded transition-colors"
                    },
                        React.createElement("input", {
                            type: "checkbox",
                            checked: curVals.includes(opt),
                            onChange: () => toggle(opt),
                            disabled: disabled,
                            className: "rounded text-primary focus:ring-secondary"
                        }),
                        React.createElement("span", { className: "text-sm text-gray-700" }, opt)
                    )) : React.createElement("div", { className: "text-xs text-gray-400 italic p-1" }, "No options")
                )
            );
        };

        // Attendance Field Component
        const AttendanceField = ({ value, onChange, state, district, type, disabled }) => {
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(false);
            useEffect(() => {
                if (!state) return;
                const fetchMembers = async () => {
                    setLoading(true);
                    try {
                        const logicType = type.includes('State') ? 'State' : 'District';
                        const res = await server.getCRGMembers(logicType, { state, district });
                        if (res.success) setMembers(res.members);
                    } catch (e) { }
                    setLoading(false);
                };
                fetchMembers();
            }, [state, district, type]);
            const currentList = Array.isArray(value) ? value : [];
            const handleToggle = (member, isPresent) => {
                const existingIdx = currentList.findIndex(m => m.member_id === member.id);
                let newList = [...currentList];
                if (existingIdx >= 0) {
                    newList[existingIdx] = { ...newList[existingIdx], present: isPresent ? 'Yes' : 'No' };
                } else {
                    newList.push({ member_id: member.id, member_name: member.name_of_nominee, present: isPresent ? 'Yes' : 'No' });
                }
                onChange(newList);
            };
            if (loading) return React.createElement("div", { className: "text-xs text-gray-500" }, "Loading members...");
            return React.createElement("div", { className: "border rounded p-2 max-h-60 overflow-y-auto bg-gray-50" },
                members.length === 0 ? React.createElement("div", { className: "text-xs italic text-gray-400" }, "No members found.") :
                    members.map(m => {
                        const existing = currentList.find(c => c.member_id === m.id);
                        const isChecked = existing ? existing.present === 'Yes' : false;
                        return React.createElement("div", { key: m.id, className: "flex items-center justify-between py-1 border-b last:border-0" },
                            React.createElement("span", { className: "text-sm text-gray-700 font-medium" }, m.name_of_nominee),
                            React.createElement("label", { className: "flex items-center gap-2 cursor-pointer" },
                                React.createElement("span", { className: "text-[10px] uppercase font-bold text-gray-400" }, "Present"),
                                React.createElement("input", {
                                    type: "checkbox",
                                    checked: isChecked,
                                    disabled: disabled,
                                    onChange: (e) => handleToggle(m, e.target.checked),
                                    className: "rounded text-primary focus:ring-secondary"
                                })
                            )
                        );
                    })
            );
        };

        // Action Points Field Component
        const ActionPointsField = ({ value, onChange, disabled }) => {
            const [items, setItems] = useState(Array.isArray(value) ? value : []);
            const [newItem, setNewItem] = useState({ action_points: '', responsible_person_entity: '', timeline_for_action: '' });
            useEffect(() => { if (Array.isArray(value)) setItems(value); }, [value]);
            const add = () => {
                if (!newItem.action_points) return;
                const next = [...items, { ...newItem, action_id: `T${Date.now()}` }];
                setItems(next); onChange(next);
                setNewItem({ action_points: '', responsible_person_entity: '', timeline_for_action: '' });
            };
            const remove = (idx) => { const next = items.filter((_, i) => i !== idx); setItems(next); onChange(next); };
            return React.createElement("div", { className: "space-y-2" },
                items.map((it, i) => React.createElement("div", { key: i, className: "p-2 bg-white rounded border border-gray-100 shadow-sm flex justify-between items-start gap-2" },
                    React.createElement("div", { className: "flex-1 text-xs" },
                        React.createElement("div", { className: "font-bold text-gray-800" }, it.action_points),
                        React.createElement("div", { className: "text-gray-500 mt-1" }, `${it.responsible_person_entity || 'No Resp.'} | ${it.timeline_for_action || 'No Date'}`)
                    ),
                    !disabled && React.createElement("button", { type: 'button', onClick: () => remove(i), className: "text-gray-300 hover:text-danger" }, "")
                )),
                !disabled && React.createElement("div", { className: "p-2 border border-dashed border-gray-300 rounded bg-gray-50 grid gap-2" },
                    React.createElement("textarea", {
                        placeholder: "Action description...",
                        className: "w-full p-1.5 text-xs border rounded focus:ring-1 focus:ring-primary outline-none",
                        rows: 2,
                        value: newItem.action_points,
                        onChange: e => setNewItem({ ...newItem, action_points: e.target.value })
                    }),
                    React.createElement("div", { className: "grid grid-cols-2 gap-2" },
                        React.createElement("input", {
                            type: "text",
                            placeholder: "Responsible",
                            className: "p-1.5 text-xs border rounded focus:ring-1 focus:ring-primary outline-none",
                            value: newItem.responsible_person_entity,
                            onChange: e => setNewItem({ ...newItem, responsible_person_entity: e.target.value })
                        }),
                        React.createElement("input", {
                            type: "date",
                            className: "p-1.5 text-xs border rounded focus:ring-1 focus:ring-primary outline-none",
                            value: newItem.timeline_for_action,
                            onChange: e => setNewItem({ ...newItem, timeline_for_action: e.target.value })
                        })
                    ),
                    React.createElement("button", {
                        type: "button",
                        onClick: add,
                        className: "bg-primary/10 text-primary text-[10px] font-bold uppercase py-1 px-3 rounded hover:bg-primary hover:text-white transition-colors"
                    }, "Add Item")
                )
            );
        };

        // Pending Actions Field Component
        const PendingActionsField = ({ value, state, district, type }) => {
            const [points, setPoints] = useState([]);
            useEffect(() => {
                if (!state) return;
                (async () => {
                    try {
                        const logicType = type.includes('State') ? 'State' : 'District';
                        const res = await server.getPendingActionPoints(logicType, { state, district });
                        if (res.success) setPoints(res.actions);
                    } catch (e) { console.warn(e); }
                })();
            }, [state, district, type]);
            return React.createElement("div", { className: "text-xs border rounded p-2 max-h-40 overflow-auto bg-gray-50/50" },
                points.length === 0 ? React.createElement("div", { className: "p-4 text-center text-gray-400 italic" }, "No pending action points.") :
                    points.map(p => React.createElement("div", { key: p.id, className: "mb-2 border-b border-gray-100 last:border-0 pb-1" },
                        React.createElement("div", { className: "font-semibold text-gray-700" }, p.action_points),
                        React.createElement("div", { className: "text-[10px] text-gray-500 flex justify-between" },
                            React.createElement("span", null, p.responsible_person_entity),
                            React.createElement("span", null, `Due: ${p.timeline_for_action}`)
                        )
                    ))
            );
        };

        const DynamicForm = ({
            schema,
            dropdowns,
            user,
            initialData,
            onSave,
            onCancel,
            mode,
            datasheet // NEW PROP
        }) => {
            const [form, setForm] = useState({});
            const [errors, setErrors] = useState({});
            const isViewMode = mode === 'view';
            const formatDateForInput = d => {
                if (!d) return '';
                const date = new Date(d);
                if (isNaN(date.getTime())) return '';
                const offset = date.getTimezoneOffset();
                const adjusted = new Date(date.getTime() - (offset * 60 * 1000));
                return adjusted.toISOString().split('T')[0];
            };

            const formatDateDDMMMYYYY = d => {
                if (!d) return '';
                const date = new Date(d);
                if (isNaN(date.getTime())) return d;
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${String(date.getDate()).padStart(2, '0')}-${months[date.getMonth()]}-${date.getFullYear()}`;
            };

            useEffect(() => {
                const init = {};
                const todayDate = formatDateForInput(new Date());
                schema.forEach(col => {
                    if (!col.hideColumn || col.type === 'today') {
                        let val = '';
                        if (initialData && initialData.hasOwnProperty(col.key)) {
                            val = initialData[col.key];
                        } else if (mode === 'add') {
                            if (col.type === 'today' || col.key === 'today') val = todayDate;
                            else if (col.key === 'sr' && user.sr) val = user.sr;
                            else if (col.key === 'state' && user.userType === 'user' && Array.isArray(user.state) && user.state.length === 1) {
                                val = user.state[0];
                            }
                        }
                        if (col.type === 'date' || col.type === 'today') val = formatDateForInput(val);
                        init[col.key] = val ?? '';
                    }
                });
                setForm(init);
                setErrors({});
            }, [initialData, user, mode, schema]);
            const getOptions = field => {
                if (field.key === 'state' && user && user.state && Array.isArray(user.state)) {
                    return user.state;
                }
                if (!dropdowns || typeof dropdowns !== 'object') return [];
                if (field.parentId) {
                    const parentKey = field.parentId;
                    const parentVal = form[parentKey];
                    if (!parentVal) return [];
                    return dropdowns[field.key]?.[parentVal] || [];
                } else {
                    return dropdowns[field.key] || [];
                }
            };
            useEffect(() => {
                const dob = form.date_of_birth;
                if (dob) {
                    const birthDate = new Date(dob);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const m = today.getMonth() - birthDate.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    if (!isNaN(age) && age >= 0) {
                        const ageField = schema.find(f => f.type === 'calculate_age');
                        if (ageField && String(form[ageField.key]) !== String(age)) {
                            setForm(prev => ({
                                ...prev,
                                [ageField.key]: String(age)
                            }));
                        }
                    }
                }
            }, [form.date_of_birth, schema]);

            const handleChange = (key, value) => {
                setForm(prev => {
                    const next = {
                        ...prev,
                        [key]: value
                    };
                    schema.forEach(child => {
                        if (child.parentId === key) {
                            next[child.key] = '';
                        }
                    });
                    return next;
                });
                if (errors[key]) setErrors(prev => ({
                    ...prev,
                    [key]: null
                }));
            };
            const checkVisibility = field => {
                if (!field.skiplogic) return true;
                const logic = field.skiplogic.trim();
                if (!logic) return true;
                try {
                    if (logic.includes('=')) {
                        const parts = logic.split('=').map(s => s.trim());
                        if (parts.length === 2) {
                            const key = parts[0];
                            const val = parts[1];
                            const currentVal = form[key];
                            return String(currentVal).toLowerCase() === String(val).toLowerCase();
                        }
                    }
                    return true;
                } catch (e) {
                    console.warn("Skip Logic Error", e);
                    return true;
                }
            };
            const handleSubmit = async e => {
                e.preventDefault();
                if (isViewMode) return;
                const newErrors = {};
                let valid = true;
                schema.forEach(f => {
                    if (checkVisibility(f) && !f.hideColumn && f.key !== 'id') {
                        const val = form[f.key];
                        if (f.required) {
                            if (val === undefined || val === null || String(val).trim() === '') {
                                newErrors[f.key] = "Required";
                                valid = false;
                            }
                        }
                        if (f.type === 'date' && val) {
                            const d = new Date(val);
                            const today = new Date();
                            today.setHours(23, 59, 59, 999);
                            if (!isNaN(d.getTime()) && d > today) {
                                newErrors[f.key] = "Cannot be in future";
                                valid = false;
                            }
                        }
                    }
                });

                // --- DUPLICATE CHECK (Mobile) ---
                if (valid && (mode === 'add' || (mode === 'edit' && initialData))) {
                    // Check key='mobile'
                    const mobileField = schema.find(f => f.key === 'mobile');
                    if (mobileField) {
                        const val = form['mobile'];
                        const isChanged = mode === 'add' || (mode === 'edit' && initialData['mobile'] !== val);

                        if (val && isChanged) {
                            try {
                                // Show "Checking..." or similar? pass for now, just await.
                                // We need datasheet name.
                                if (datasheet) {
                                    const dupRes = await server.checkDuplicateValue(datasheet, 'mobile', val);
                                    if (dupRes.exists) {
                                        newErrors['mobile'] = `Duplicate value found in ${dupRes.source}.`;
                                        valid = false;
                                    }
                                }
                            } catch (err) {
                                console.warn("Validation check failed", err);
                            }
                        }
                    }
                }

                setErrors(newErrors);
                if (valid) {
                    const dataToSave = {
                        ...form
                    };
                    // Transform dates to DD-MMM-YYYY for saving
                    schema.forEach(f => {
                        if ((f.type === 'today' || f.type === 'date') && dataToSave[f.key]) {
                            dataToSave[f.key] = formatDateDDMMMYYYY(dataToSave[f.key]);
                        }
                    });

                    if (initialData?.id) dataToSave.id = initialData.id;
                    await onSave(dataToSave);
                }
            };
            const modalTitle = mode === 'add' ? 'Add New Record' : mode === 'edit' ? 'Edit Record' : 'View Record Details';
            return React.createElement("div", {
                className: "h-full flex flex-col bg-white rounded-lg shadow-lg border border-gray-200 border-t-4 border-t-primary animate-fade-in"
            }, React.createElement("div", {
                className: "flex-1 flex flex-col overflow-hidden"
            }, React.createElement("div", {
                className: "p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-lg"
            }, React.createElement("h2", {
                className: "font-bold text-lg text-primary"
            }, modalTitle), React.createElement("button", {
                onClick: onCancel,
                className: "text-gray-400 hover:text-danger transition"
            }, React.createElement(Icon, {
                name: "close"
            }))), React.createElement("form", {
                id: "frm",
                onSubmit: handleSubmit,
                className: "flex-1 p-4 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"
            }, schema.map(f => {
                if (f.hideColumn || f.key === 'id') return null;
                if (!checkVisibility(f)) return null;
                const isStateDisabled = f.key === 'state' && user.userType === 'user' && user.state.length === 1;
                const isDisabled = f.disabled || isStateDisabled || f.key === 'sr' || isViewMode;
                return React.createElement("div", {
                    key: f.key,
                    className: 'col-span-1'
                }, React.createElement("label", {
                    className: "block text-xs font-semibold text-gray-600 mb-1 uppercase"
                }, f.label, " ", f.required && !isViewMode && React.createElement("span", {
                    className: "text-danger"
                }, "*")), f.type === 'calculate_age' ? React.createElement("input", {
                    type: "text",
                    readOnly: true,
                    className: "w-full p-1.5 text-sm border rounded bg-gray-100 text-gray-600 outline-none cursor-not-allowed",
                    value: form[f.key] || ''
                }) : f.type && f.type.includes('Attendance') ? React.createElement(AttendanceField, {
                    value: form[f.key],
                    onChange: (val) => handleChange(f.key, val),
                    state: form.state || (Array.isArray(user.state) ? user.state[0] : user.state),
                    district: form.district,
                    type: f.type,
                    disabled: isDisabled
                }) : f.type && (f.type.includes('ActionPoints') && f.type.includes('pending')) ? React.createElement(PendingActionsField, {
                    state: form.state || (Array.isArray(user.state) ? user.state[0] : user.state),
                    district: form.district,
                    type: f.type
                }) : f.type && f.type.includes('ActionPoints') ? React.createElement(ActionPointsField, {
                    value: form[f.key],
                    onChange: (val) => handleChange(f.key, val),
                    disabled: isDisabled
                }) : f.type === 'multiselect' ? React.createElement(CollapsibleMultiSelect, {
                    options: getOptions(f),
                    value: form[f.key],
                    onChange: (val) => handleChange(f.key, val),
                    disabled: isDisabled,
                    placeholder: f.parentId ? 'Select parent first...' : 'Select Options...'
                }) : f.dropdown ? React.createElement("select", {
                    className: `w-full p-1.5 text-sm border rounded focus:ring-2 focus:ring-secondary outline-none transition ${isDisabled ? 'bg-gray-100 text-gray-600' : 'bg-white'}`,
                    value: form[f.key] || '',
                    onChange: e => handleChange(f.key, e.target.value),
                    disabled: isDisabled
                }, React.createElement("option", {
                    value: ""
                }, isViewMode && !form[f.key] ? '-' : 'Select Option...'), !isViewMode && getOptions(f).map(o => React.createElement("option", {
                    key: o,
                    value: o
                }, o))) : f.type === 'radio2' ? React.createElement("select", {
                    className: `w-full p-1.5 text-sm border rounded focus:ring-2 focus:ring-secondary outline-none transition ${isDisabled ? 'bg-gray-100 text-gray-600' : 'bg-white'}`,
                    value: form[f.key] || '',
                    onChange: e => handleChange(f.key, e.target.value),
                    disabled: isDisabled
                }, React.createElement("option", {
                    value: ""
                }, isViewMode && !form[f.key] ? '-' : '-- Select --'), !isViewMode && ['Yes', 'No'].map(o => React.createElement("option", {
                    key: o,
                    value: o
                }, o))) : f.type === 'radio3' ? React.createElement("select", {
                    className: `w-full p-1.5 text-sm border rounded focus:ring-2 focus:ring-secondary outline-none transition ${isDisabled ? 'bg-gray-100 text-gray-600' : 'bg-white'}`,
                    value: form[f.key] || '',
                    onChange: e => handleChange(f.key, e.target.value),
                    disabled: isDisabled
                }, React.createElement("option", {
                    value: ""
                }, isViewMode && !form[f.key] ? '-' : '-- Select --'), !isViewMode && ['Yes', 'No', 'NA'].map(o => React.createElement("option", {
                    key: o,
                    value: o
                }, o))) : f.type === 'textarea' ? React.createElement("textarea", {
                    rows: 3,
                    className: `w-full p-1.5 text-sm border rounded focus:ring-2 focus:ring-secondary outline-none transition ${isDisabled ? 'bg-gray-100 text-gray-600' : 'bg-white'}`,
                    value: form[f.key] || '',
                    onChange: e => handleChange(f.key, e.target.value),
                    disabled: isDisabled
                }) : React.createElement("input", {
                    type: f.type === 'number' ? 'number' : f.type === 'date' ? 'date' : 'text',
                    max: f.type === 'date' ? new Date().toISOString().split('T')[0] : undefined,
                    className: `w-full p-1.5 text-sm border rounded focus:ring-2 focus:ring-secondary outline-none transition ${isDisabled ? 'bg-gray-100 text-gray-600' : 'bg-white'}`,
                    value: form[f.key] || '',
                    onChange: e => handleChange(f.key, e.target.value),
                    disabled: isDisabled
                }), !isViewMode && errors[f.key] && React.createElement("span", {
                    className: "text-danger text-[10px] mt-0.5 block"
                }, errors[f.key]));
            })), React.createElement("div", {
                className: "p-3 border-t border-gray-100 flex justify-end gap-3 bg-gray-50 rounded-b-lg"
            }, React.createElement("button", {
                type: "button",
                onClick: onCancel,
                className: "px-4 py-1.5 border border-gray-300 rounded text-gray-700 bg-white hover:bg-gray-50 font-medium text-sm"
            }, isViewMode ? 'Close' : 'Cancel'), !isViewMode && React.createElement("button", {
                type: "submit",
                form: "frm",
                className: "px-4 py-1.5 bg-primary text-white rounded hover:bg-opacity-90 font-medium text-sm shadow-sm"
            }, mode === 'add' ? 'Add Record' : 'Save Changes'))));
        };
        window.DynamicForm = DynamicForm;
        // Global MultiSelect Dropdown (Moved from CRGModule)
        const MultiSelectDropdown = ({ options, selected, onChange, placeholder = "Select...", showChips = false, small = false, selectedLabel = "Selected" }) => {
            const { useState, useRef, useEffect } = React;
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const toggleOption = (val) => {
                const newSelected = selected.includes(val)
                    ? selected.filter(s => s !== val)
                    : [...selected, val];
                onChange(newSelected);
            };

            const handleSelectAll = () => {
                if (selected.length === options.length) {
                    onChange([]); // Deselect All
                } else {
                    onChange(options.map(o => o.value)); // Select All
                }
            };

            const selectedCount = selected.length;
            const displayLabel = selectedCount > 0
                ? `${selectedCount} ${selectedLabel}`
                : placeholder;

            const selectedObjects = options.filter(o => selected.includes(o.value));

            return React.createElement("div", { className: `relative ${small ? 'w-40' : 'w-full'}`, ref: dropdownRef },
                // Dropdown Trigger
                React.createElement("div", {
                    className: `w-full ${small ? 'py-1 px-2 text-xs' : 'p-2 text-sm'} border rounded bg-white cursor-pointer flex justify-between items-center hover:border-primary transition border-gray-300`,
                    onClick: () => setIsOpen(!isOpen)
                },
                    React.createElement("span", { className: `${selectedCount > 0 ? "text-primary font-bold" : "text-gray-400"} truncate` }, displayLabel),
                    React.createElement(window.Icon || (() => "v"), { name: "chevron-down", className: `w-3 h-3 text-gray-400 transition-transform ${isOpen ? "rotate-180" : ""}` })
                ),
                // Menu
                isOpen && React.createElement("div", { className: "absolute z-50 w-56 mt-1 bg-white border border-gray-200 rounded shadow-xl max-h-60 overflow-y-auto left-0" },
                    // Select All Action
                    React.createElement("div", {
                        className: "p-2 border-b border-gray-100 flex items-center gap-2 cursor-pointer hover:bg-gray-50 font-bold text-xs text-primary uppercase tracking-wider sticky top-0 bg-white z-10",
                        onClick: handleSelectAll
                    },
                        React.createElement("span", null, selected.length === options.length ? "Deselect All" : "Select All")
                    ),
                    options.map(opt => {
                        const isSelected = selected.includes(opt.value);
                        return React.createElement("div", {
                            key: opt.value,
                            className: `p-2 flex items-center gap-2 cursor-pointer hover:bg-gray-50 border-b border-gray-50 last:border-0 ${isSelected ? "bg-blue-50/50" : ""}`,
                            onClick: () => toggleOption(opt.value)
                        },
                            React.createElement("div", {
                                className: `w-3 h-3 flex-shrink-0 rounded border flex items-center justify-center transition-colors ${isSelected ? "bg-primary border-primary" : "border-gray-300 bg-white"}`
                            }, isSelected && React.createElement(window.Icon || (() => "x"), { name: "check", className: "w-2 h-2 text-white" })),
                            React.createElement("div", { className: "flex-1 min-w-0" },
                                React.createElement("div", { className: "text-xs text-gray-700 font-medium truncate", title: opt.label }, opt.label),
                                opt.sub && React.createElement("div", { className: "text-[10px] text-gray-500 truncate" }, opt.sub)
                            )
                        );
                    })
                ),
                // Selected Chips (Optional)
                showChips && selectedCount > 0 && React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-2 mt-2" },
                    selectedObjects.map(obj => React.createElement("div", {
                        key: obj.value,
                        className: "flex items-center justify-between bg-blue-50 text-blue-700 px-3 py-1 rounded border border-blue-100 text-xs"
                    },
                        React.createElement("span", { className: "truncate font-medium" }, obj.label),
                        React.createElement("button", {
                            onClick: (e) => { e.stopPropagation(); toggleOption(obj.value); },
                            className: "ml-2 text-blue-400 hover:text-blue-600 focus:outline-none"
                        }, "")
                    ))
                )
            );
        };
        window.MultiSelectDropdown = MultiSelectDropdown;

        const DataTable = ({
            right,
            user,
            initialPrefetch
        }) => {
            const {
                addAlert
            } = useContext(AlertContext);
            // Use prefetched data if available for this datasheet
            const hasPrefetch = initialPrefetch && initialPrefetch.datasheet === right.datasheet;
            const [data, setData] = useState(hasPrefetch ? initialPrefetch.data : []);
            const [total, setTotal] = useState(hasPrefetch ? initialPrefetch.total : 0);
            const [schema, setSchema] = useState([]);
            const [dropdowns, setDropdowns] = useState(null);
            const [loading, setLoading] = useState(!hasPrefetch);
            const [page, setPage] = useState(1);
            const [search, setSearch] = useState("");
            const [sort, setSort] = useState({
                key: 'id',
                dir: 'desc'
            });
            const [mode, setMode] = useState('list');
            const [activeRec, setActiveRec] = useState(null);
            const [debouncedSearch, setDebouncedSearch] = useState(search);
            const [isSearchOpen, setIsSearchOpen] = useState(false);
            const [skipInitialFetch, setSkipInitialFetch] = useState(hasPrefetch);

            // Column Selection State
            const [selectedColumns, setSelectedColumns] = useState([]);

            useEffect(() => {
                const h = setTimeout(() => setDebouncedSearch(search), 500);
                return () => clearTimeout(h);
            }, [search]);
            useEffect(() => {
                setPage(1);
            }, [debouncedSearch]);

            // Init selected columns when schema loads
            useEffect(() => {
                if (schema.length > 0 && selectedColumns.length === 0) {
                    // Default: All visible columns
                    const defaults = schema.filter(c => !c.hideColumn).map(c => c.key);
                    setSelectedColumns(defaults);
                }
            }, [schema]);

            const fetchData = useCallback(async () => {
                setLoading(true);
                try {
                    if (schema.length === 0) {
                        const [s, d] = await Promise.all([
                            server.getSchema(right.schema),
                            server.getDropdownOptions()
                        ]);
                        if (s.error) throw new Error(s.error);
                        if (d.error) throw new Error(d.error);

                        setSchema(s);
                        // Init selected columns here too for prefetch case catch-up
                        const defaults = s.filter(c => !c.hideColumn).map(c => c.key);
                        setSelectedColumns(defaults);

                        const processedDropdowns = processRawDropdownData(d, s);
                        setDropdowns(processedDropdowns);
                    }
                    const params = {
                        username: user.username,
                        userType: user.userType,
                        userSR: user.sr,
                        userState: user.state,
                        datasheetName: right.datasheet,
                        schemaName: right.schema,
                        page: page,
                        pageSize: 25,
                        search: debouncedSearch,
                        sortKey: sort.key,
                        sortDir: sort.dir
                    };
                    const res = await server.getPaginatedData(params);
                    if (res.error) throw new Error(res.error);
                    setData(res.data);
                    setTotal(res.totalRecords);
                } catch (e) {
                    addAlert(e.message, 'error');
                } finally {
                    setLoading(false);
                }
            }, [right, user, page, debouncedSearch, sort]);
            useEffect(() => {
                // Skip initial fetch if we used prefetched data
                if (skipInitialFetch) {
                    setSkipInitialFetch(false);
                    // Still need to load schema
                    (async () => {
                        try {
                            const [s, d] = await Promise.all([
                                server.getSchema(right.schema),
                                server.getDropdownOptions()
                            ]);
                            if (!s.error) {
                                setSchema(s);
                                const defaults = s.filter(c => !c.hideColumn).map(c => c.key);
                                setSelectedColumns(defaults);
                            }
                            if (!d.error) setDropdowns(processRawDropdownData(d, s));
                        } catch (e) { }
                    })();
                    return;
                }
                fetchData();
            }, [fetchData]);

            // Filter visible cols based on selection
            const visibleCols = useMemo(() => {
                // Return schema items that are in selectedColumns AND not hidden by definition (double check)
                return schema.filter(c => selectedColumns.includes(c.key));
            }, [schema, selectedColumns]);

            const handleSave = async record => {
                addAlert("Saving...", "info");
                try {
                    const res = mode === 'add' ? await server.addRecord(record, right.datasheet, schema, user) : await server.editRecord(record.id, record, right.datasheet, schema, user);
                    if (res.success) {
                        addAlert(res.message, 'success');
                        const realRec = res.savedData;
                        realRec.id = res.id;
                        if (mode === 'add') {
                            setData(prev => [realRec, ...prev]);
                            setTotal(t => t + 1);
                        } else {
                            setData(prev => prev.map(r => r.id === realRec.id ? realRec : r));
                        }
                        setMode('list');
                    } else throw new Error(res.error);
                } catch (e) {
                    addAlert(e.message, 'error');
                }
            };
            const handleDelete = async id => {
                if (!confirm("Are you sure?")) return;
                const prevData = [...data];
                setData(d => d.filter(r => r.id !== id));
                addAlert("Deleting...", "info");
                try {
                    const res = await server.deleteRecord(id, right.datasheet, user);
                    if (res.success) {
                        addAlert("Deleted successfully", 'success');
                    } else {
                        setData(prevData);
                        addAlert(res.error, 'error');
                    }
                } catch (e) {
                    setData(prevData);
                    addAlert(e.message, "error");
                }
            };
            const handleExport = async () => {
                addAlert("Preparing export...", "info");
                try {
                    const params = {
                        username: user.username,
                        userType: user.userType,
                        userSR: user.sr,
                        userState: user.state,
                        datasheetName: right.datasheet,
                        schemaName: right.schema,
                        search: debouncedSearch,
                        sortKey: sort.key,
                        sortDir: sort.dir
                    };
                    const res = await server.exportData(params);
                    if (res.success) {
                        const link = document.createElement('a');
                        link.href = 'data:text/csv;base64,' + res.csv;
                        link.download = `${right.datasheet}_export.csv`;
                        link.click();
                        addAlert("Export downloaded", "success");
                    } else addAlert(res.error, "error");
                } catch (e) {
                    addAlert(e.message, "error");
                }
            };
            const totalPages = Math.ceil(total / 25) || 1;

            // Available options for column selector (exclude known internal/hidden cols if desired, but here we just take schema)
            const columnOptions = useMemo(() => {
                return schema.filter(c => !c.hideColumn).map(c => ({ label: c.label || c.key, value: c.key }));
            }, [schema]);

            return React.createElement("div", {
                className: "p-4 h-full flex flex-col"
            }, mode === 'list' && React.createElement("div", {
                className: "mb-4 bg-white p-3 rounded shadow-sm border border-gray-200 flex flex-col md:flex-row items-center justify-between gap-3"
            }, React.createElement("div", { className: "flex items-center gap-4 flex-1" },
                React.createElement("h2", {
                    className: "text-xl font-bold text-gray-800 whitespace-nowrap"
                }, right.datasheetTitle || right.datasheet),
                // Column Selector (Left Side)
                React.createElement(MultiSelectDropdown, {
                    options: columnOptions,
                    selected: selectedColumns,
                    onChange: setSelectedColumns,
                    placeholder: "Select Columns",
                    showChips: false,
                    small: true,
                    selectedLabel: "Columns"
                })
            ), React.createElement("div", {
                className: "flex items-center gap-3"
            }, isSearchOpen ? React.createElement("div", {
                className: "flex items-center bg-white border border-primary rounded shadow-sm animate-fade-in"
            }, React.createElement("input", {
                autoFocus: true,
                type: "text",
                placeholder: "Search...",
                className: "pl-2 pr-2 py-1 text-sm outline-none w-40 text-gray-700",
                value: search,
                onChange: e => setSearch(e.target.value),
                onBlur: () => !search && setIsSearchOpen(false)
            }), React.createElement("button", {
                onClick: () => { setSearch(''); setIsSearchOpen(false); },
                className: "p-1.5 text-gray-400 hover:text-danger"
            }, React.createElement(Icon, {
                name: "close",
                className: "w-3 h-3"
            }))) : React.createElement("button", {
                onClick: () => setIsSearchOpen(true),
                className: "p-2 text-gray-500 hover:text-primary transition bg-gray-50 rounded-full hover:bg-blue-50",
                title: "Search"
            }, React.createElement(Icon, {
                name: "search"
            })), right.edit === 'allow' && React.createElement("button", {
                onClick: () => {
                    setActiveRec(null);
                    setMode('add');
                },
                className: "flex items-center justify-center w-8 h-8 bg-primary text-white rounded-full shadow hover:bg-opacity-90 transition transform hover:scale-105",
                title: "Add Record"
            }, React.createElement(Icon, {
                name: "plus"
            })), React.createElement("button", {
                onClick: handleExport,
                className: "flex items-center justify-center w-8 h-8 bg-blue-500 text-white rounded-full shadow hover:bg-blue-600 transition transform hover:scale-105",
                title: "Export"
            }, React.createElement(Icon, {
                name: "download"
            })))), mode === 'list' && React.createElement("div", {
                className: "bg-white rounded-lg shadow border border-gray-200 flex-1 overflow-hidden flex flex-col"
            }, React.createElement("div", {
                className: "overflow-auto flex-1"
            }, React.createElement("table", {
                className: "min-w-full divide-y divide-gray-200"
            }, React.createElement("thead", {
                className: "bg-gradient-to-b from-primary to-secondary text-white sticky top-0 z-40 shadow-sm"
            }, React.createElement("tr", null, visibleCols.map(col => React.createElement("th", {
                key: col.key,
                className: "px-4 py-3 text-left text-xs font-bold uppercase tracking-wider cursor-pointer hover:bg-white/10 select-none align-bottom transition-colors",
                style: {
                    minWidth: col.key === 'sr' ? '75px' : '150px'
                },
                onClick: () => setSort({
                    key: col.key,
                    dir: sort.key === col.key && sort.dir === 'asc' ? 'desc' : 'asc'
                })
            }, React.createElement("div", {
                className: "flex items-end gap-1 w-full"
            }, React.createElement("span", {
                className: "header-clamp flex-1",
                title: col.label
            }, col.label), sort.key === col.key && React.createElement("span", {
                className: "flex-shrink-0 text-secondary mb-0.5 text-[10px]"
            }, sort.dir === 'asc' ? '' : '')))), React.createElement("th", {
                className: "px-4 py-3 text-right text-xs font-bold uppercase tracking-wider sticky right-0 bg-secondary z-50 shadow-l border-l border-white/10 align-bottom"
            }, "Actions"))), React.createElement("tbody", {
                className: "divide-y divide-gray-200 bg-white"
            }, loading ? Array.from({ length: 8 }).map((_, i) => React.createElement(SkeletonRow, { key: i, cols: visibleCols })) : data.length === 0 ? React.createElement("tr", null, React.createElement("td", {
                colSpan: "100",
                className: "p-12 text-center text-gray-400 italic"
            }, "No records found.")) : data.map(row => React.createElement("tr", {
                key: row.id,
                className: `hover:bg-accent/20 even:bg-slate-50/70 group transition duration-75 ease-in-out ${row._optimistic ? 'bg-yellow-50' : ''}`
            }, visibleCols.map(col => React.createElement("td", {
                key: col.key,
                className: "px-4 py-2 text-gray-700 align-top"
            }, React.createElement("div", {
                className: "header-clamp",
                title: row[col.key]
            }, col.type === 'date' ? ensureDDMMMYYYY(row[col.key]) : row[col.key]))), React.createElement("td", {
                className: "px-4 py-2 whitespace-nowrap text-right font-medium sticky right-0 bg-white group-hover:bg-blue-50/80 group-even:bg-slate-50/70 z-30 border-l border-gray-100 shadow-l align-top"
            }, React.createElement("div", {
                className: "flex justify-end gap-2"
            }, React.createElement("button", {
                onClick: () => {
                    setActiveRec(row);
                    setMode('view');
                },
                className: "text-blue-500 hover:text-blue-700 transition",
                title: "View"
            }, React.createElement(Icon, {
                name: "eye"
            })), right.edit === 'allow' && React.createElement("button", {
                onClick: () => {
                    setActiveRec(row);
                    setMode('edit');
                },
                className: "text-orange-500 hover:text-orange-600 transition",
                title: "Edit"
            }, React.createElement(Icon, {
                name: "edit"
            })), right.delete === 'allow' && React.createElement("button", {
                onClick: () => handleDelete(row.id),
                className: "text-red-500 hover:text-red-600 transition",
                title: "Delete"
            }, React.createElement(Icon, {
                name: "trash"
            }))))))))), React.createElement("div", {
                className: "bg-gray-50 border-t border-gray-200 px-4 py-2 text-xs text-gray-500 flex items-center justify-between"
            }, React.createElement("div", {
                className: "flex items-center gap-4"
            }, React.createElement("span", null, "Showing ", data.length, "/", total)), React.createElement("div", {
                className: "flex items-center bg-white border border-gray-300 rounded shadow-sm overflow-hidden h-7"
            }, React.createElement("button", {
                disabled: page === 1,
                onClick: () => setPage(p => p - 1),
                className: "px-2 h-full hover:bg-gray-50 text-gray-600 disabled:opacity-40 border-r"
            }, React.createElement(Icon, {
                name: "prev"
            })), React.createElement("span", {
                className: "px-3 font-medium text-gray-600 whitespace-nowrap"
            }, page, " / ", totalPages), React.createElement("button", {
                disabled: page >= totalPages,
                onClick: () => setPage(p => p + 1),
                className: "px-2 h-full hover:bg-gray-50 text-gray-600 disabled:opacity-40 border-l"
            }, React.createElement(Icon, {
                name: "next"
            }))))), mode !== 'list' && React.createElement(DynamicForm, {
                schema: schema,
                dropdowns: dropdowns,
                user: user,
                initialData: activeRec,
                mode: mode,
                datasheet: right.datasheet, // PASS PROP
                onSave: handleSave,
                onCancel: () => setMode('list')
            }));
        };
        const Home = ({ user, navigateToTab }) => {
            return React.createElement("div", { className: "p-8 h-full overflow-y-auto bg-gray-50/50" },
                React.createElement("div", { className: "max-w-5xl mx-auto space-y-8 animate-fade-in" },
                    React.createElement("div", { className: "bg-gradient-to-r from-primary to-blue-900 rounded-2xl p-10 text-white shadow-xl relative overflow-hidden" },
                        React.createElement("div", { className: "absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-16 -mt-16 blur-2xl" }),
                        React.createElement("div", { className: "relative z-10" },
                            React.createElement("h1", { className: "text-2xl font-bold mb-2" }, `Welcome, ${user.name}!`),
                            React.createElement("p", { className: "text-blue-100 mb-6 max-w-lg text-sm" }, "Access your centralized Management Information System (MIS) dashboard and datasheets for Community-Led Monitoring under Community Systems Strengthening."),
                            React.createElement("button", {
                                onClick: () => navigateToTab('dash'),
                                className: "px-6 py-2 bg-secondary text-white font-bold rounded-lg shadow-lg hover:bg-[#ad1457] transition transform hover:-translate-y-0.5 flex items-center gap-2 text-sm"
                            }, React.createElement(Icon, { name: "menu" }), "Open Dashboard")
                        )
                    ),
                    React.createElement("div", null,
                        React.createElement("h2", { className: "text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 px-1" },
                            React.createElement(Icon, { name: "menu", className: "text-secondary" }),
                            "Your Datasheets"
                        ),
                        React.createElement("div", { className: "grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2" },
                            user.accessRights
                                .filter(r => !r.group || !r.group.toLowerCase().includes('crg'))
                                .map((r, i) => {
                                    // Find original index for navigation
                                    const originalIdx = user.accessRights.indexOf(r);
                                    return React.createElement("div", {
                                        key: i,
                                        onClick: () => navigateToTab(originalIdx),
                                        className: "bg-white p-2 rounded border border-gray-100 hover:shadow-md hover:border-secondary/30 transition-all cursor-pointer group"
                                    },
                                        React.createElement("div", { className: "flex items-center gap-2" },
                                            React.createElement("div", { className: "w-6 h-6 rounded bg-blue-50 text-primary flex items-center justify-center font-bold text-xs group-hover:bg-primary group-hover:text-white transition-colors flex-shrink-0" },
                                                (r.datasheetTitle || r.datasheet || '?').charAt(0)
                                            ),
                                            React.createElement("div", { className: "min-w-0 flex-1" },
                                                React.createElement("h3", { className: "font-semibold text-xs text-gray-800 group-hover:text-primary truncate" }, r.datasheetTitle || r.datasheet)
                                            )
                                        )
                                    );
                                })
                        ),
                        // CRG Modules Section for Home Page
                        React.createElement("div", { className: "mt-8" },
                            React.createElement("h2", { className: "text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 px-1" },
                                React.createElement(Icon, { name: "users", className: "text-secondary" }),
                                "CRG Modules"
                            ),
                            React.createElement("div", { className: "grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2" },
                                React.createElement("div", {
                                    onClick: () => navigateToTab('state-crg'),
                                    className: "bg-white p-2 rounded border border-gray-100 hover:shadow-md hover:border-secondary/30 transition-all cursor-pointer group"
                                },
                                    React.createElement("div", { className: "flex items-center gap-2" },
                                        React.createElement("div", { className: "w-6 h-6 rounded bg-purple-50 text-purple-600 flex items-center justify-center font-bold text-xs group-hover:bg-purple-600 group-hover:text-white transition-colors flex-shrink-0" }, "S"),
                                        React.createElement("div", { className: "min-w-0 flex-1" },
                                            React.createElement("h3", { className: "font-semibold text-xs text-gray-800 group-hover:text-purple-600 truncate" }, "State CRG")
                                        )
                                    )
                                ),
                                React.createElement("div", {
                                    onClick: () => navigateToTab('district-crg'),
                                    className: "bg-white p-2 rounded border border-gray-100 hover:shadow-md hover:border-secondary/30 transition-all cursor-pointer group"
                                },
                                    React.createElement("div", { className: "flex items-center gap-2" },
                                        React.createElement("div", { className: "w-6 h-6 rounded bg-purple-50 text-purple-600 flex items-center justify-center font-bold text-xs group-hover:bg-purple-600 group-hover:text-white transition-colors flex-shrink-0" }, "D"),
                                        React.createElement("div", { className: "min-w-0 flex-1" },
                                            React.createElement("h3", { className: "font-semibold text-xs text-gray-800 group-hover:text-purple-600 truncate" }, "District CRG")
                                        )
                                    )
                                )
                            )
                        )
                    ),)
            );
        };
        const MainLayout = () => {
            const {
                user,
                logout,
                appData
            } = useContext(AuthContext);
            const [tab, setTab] = useState('home');
            const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth > 768);
            const [loadedModules, setLoadedModules] = useState({});
            const Dashboard = window.DashboardComponent || (() => React.createElement("div", {
                className: "p-10 text-center text-gray-400"
            }, "Dashboard module not loaded."));
            const isAdmin = user.userType === 'superadmin';

            // Lazy load admin modules only when first accessed
            const getAdminModule = (moduleName) => {
                if (loadedModules[moduleName]) return loadedModules[moduleName];
                const module = window[moduleName];
                if (module) {
                    setLoadedModules(prev => ({ ...prev, [moduleName]: module }));
                    return module;
                }
                return () => React.createElement("div", { className: "p-10 text-center text-gray-400 animate-pulse" },
                    React.createElement("div", { className: "inline-block w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin mr-2" }),
                    "Loading module..."
                );
            };

            const renderContent = () => {
                if (tab === 'home') return React.createElement(Home, { user: user, navigateToTab: setTab });
                if (tab === 'dash') return React.createElement(Dashboard, {
                    user: user,
                    navigateToTab: setTab,
                    initialData: appData
                });
                if (tab === 'users') return React.createElement(getAdminModule('AdminUsers'), null);
                if (tab === 'dropdowns') return React.createElement(getAdminModule('AdminDropdowns'), null);
                if (tab === 'forms') return React.createElement(getAdminModule('FormBuilder'), null);
                if (tab === 'deleted-logs') return React.createElement(getAdminModule('DeletedLogs'), null);
                if (tab === 'state-crg') return React.createElement(window.CRGModule, { mode: 'State', user: user });
                if (tab === 'district-crg') return React.createElement(window.CRGModule, { mode: 'District', user: user });
                return React.createElement(DataTable, {
                    key: tab,
                    right: user.accessRights[tab],
                    user: user,
                    initialDropdowns: appData?.dropdowns,
                    initialPrefetch: appData?.prefetch
                });
            };
            return React.createElement("div", {
                className: "flex h-screen overflow-hidden bg-background"
            }, React.createElement("div", {
                className: `${isSidebarOpen ? 'w-48 translate-x-0' : 'w-16 -translate-x-full md:translate-x-0'} bg-gradient-to-b from-[#ad1457] to-[#081a58] text-white flex flex-col shadow-2xl z-50 flex-shrink-0 sidebar-transition transition-all duration-300 fixed md:relative h-full`
            }, React.createElement("div", {
                className: "p-4 border-b border-primary/50 flex items-center justify-between h-16"
            }, React.createElement("div", {
                className: `flex items-center gap-3 overflow-hidden ${!isSidebarOpen && 'hidden'}`
            }, React.createElement("div", {
                className: "overflow-hidden whitespace-nowrap"
            }, React.createElement("p", {
                className: "font-bold text-sm truncate"
            }, user.name), React.createElement("p", {
                className: "text-xs text-gray-300 truncate"
            }, user.designation))), React.createElement("button", {
                onClick: () => setIsSidebarOpen(!isSidebarOpen),
                className: `text-white hover:text-accent focus:outline-none ${!isSidebarOpen && 'mx-auto'}`
            }, isSidebarOpen ? React.createElement(Icon, {
                name: "chevronLeft"
            }) : React.createElement(Icon, {
                name: "menu"
            }))), React.createElement("div", {
                className: "flex-1 overflow-y-auto overflow-x-hidden py-4 space-y-1"
            }, React.createElement("button", {
                onClick: () => setTab('home'),
                className: `w-full flex items-center gap-3 px-4 py-2 text-xs hover:bg-white/10 border-l-4 transition-all duration-200 ${tab === 'home' ? 'border-accent bg-white/10' : 'border-transparent'} ${!isSidebarOpen && 'justify-center px-0'}`,
                title: "Home"
            }, React.createElement(Icon, {
                name: "home",
                className: "w-5 h-5 shrink-0"
            }), " ", React.createElement("span", {
                className: `whitespace-nowrap ${!isSidebarOpen && 'hidden'}`
            }, "Home")), isSidebarOpen && React.createElement("div", {
                className: "px-4 py-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider whitespace-nowrap mt-2"
            }, "Datasheets"), !isSidebarOpen && React.createElement("div", {
                className: "h-4"
            }), user.accessRights
                .filter(r => !r.group || !r.group.toLowerCase().includes('crg'))
                .map((r, i) => {
                    const originalIdx = user.accessRights.indexOf(r);
                    return React.createElement("button", {
                        key: i,
                        onClick: () => setTab(originalIdx),
                        className: `w-full flex items-center gap-3 px-4 py-2 text-xs hover:bg-white/10 border-l-4 transition-all duration-200 ${tab === originalIdx ? 'border-accent bg-white/10' : 'border-transparent'} ${!isSidebarOpen && 'justify-center px-0'}`,
                        title: r.datasheetTitle || r.datasheet
                    }, React.createElement("div", {
                        className: "w-5 h-5 shrink-0 bg-white/20 rounded-sm flex items-center justify-center text-[10px] font-bold"
                    }, (r.datasheetTitle || r.datasheet || '?').charAt(0)), React.createElement("span", {
                        className: `truncate ${!isSidebarOpen && 'hidden'}`
                    }, r.datasheetTitle || r.datasheet));
                }),
                React.createElement(React.Fragment, null,
                    React.createElement("div", { className: `mt-4 border-t border-white/10 ${!isSidebarOpen && 'hidden'}` }),
                    isSidebarOpen && React.createElement("div", { className: "px-4 py-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider whitespace-nowrap mt-2" }, "CRG Modules"),
                    React.createElement("button", {
                        onClick: () => setTab('state-crg'),
                        className: `w-full flex items-center gap-3 px-4 py-2 text-xs hover:bg-white/10 border-l-4 transition-all duration-200 ${tab === 'state-crg' ? 'border-accent bg-white/10' : 'border-transparent'} ${!isSidebarOpen && 'justify-center px-0'}`,
                        title: "State CRG"
                    }, React.createElement(Icon, { name: "users", className: "w-5 h-5 shrink-0" }), React.createElement("span", { className: `truncate ${!isSidebarOpen && 'hidden'}` }, "State CRG")),
                    React.createElement("button", {
                        onClick: () => setTab('district-crg'),
                        className: `w-full flex items-center gap-3 px-4 py-2 text-xs hover:bg-white/10 border-l-4 transition-all duration-200 ${tab === 'district-crg' ? 'border-accent bg-white/10' : 'border-transparent'} ${!isSidebarOpen && 'justify-center px-0'}`,
                        title: "District CRG"
                    }, React.createElement(Icon, { name: "users", className: "w-5 h-5 shrink-0" }), React.createElement("span", { className: `truncate ${!isSidebarOpen && 'hidden'}` }, "District CRG"))
                ),
                isAdmin && React.createElement(React.Fragment, null,
                    React.createElement("div", { className: `mt-4 border-t border-white/10 ${!isSidebarOpen && 'hidden'}` }),
                    isSidebarOpen && React.createElement("div", { className: "px-4 py-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider whitespace-nowrap mt-2" }, "Administration"),
                    React.createElement("button", {
                        onClick: () => setTab('users'),
                        className: `w-full flex items-center gap-3 px-4 py-2 text-xs hover:bg-white/10 border-l-4 transition-all duration-200 ${tab === 'users' ? 'border-accent bg-white/10' : 'border-transparent'} ${!isSidebarOpen && 'justify-center px-0'}`,
                        title: "User Management"
                    }, React.createElement(Icon, { name: "users", className: "w-5 h-5 shrink-0" }), " ", React.createElement("span", { className: `truncate ${!isSidebarOpen && 'hidden'}` }, "Users")),
                    React.createElement("button", {
                        onClick: () => setTab('dropdowns'),
                        className: `w-full flex items-center gap-3 px-4 py-2 text-xs hover:bg-white/10 border-l-4 transition-all duration-200 ${tab === 'dropdowns' ? 'border-accent bg-white/10' : 'border-transparent'} ${!isSidebarOpen && 'justify-center px-0'}`,
                        title: "Dropdowns"
                    }, React.createElement(Icon, { name: "settings", className: "w-5 h-5 shrink-0" }), " ", React.createElement("span", { className: `truncate ${!isSidebarOpen && 'hidden'}` }, "Dropdowns")),
                    React.createElement("button", {
                        onClick: () => setTab('forms'),
                        className: `w-full flex items-center gap-3 px-4 py-2 text-xs hover:bg-white/10 border-l-4 transition-all duration-200 ${tab === 'forms' ? 'border-accent bg-white/10' : 'border-transparent'} ${!isSidebarOpen && 'justify-center px-0'}`,
                        title: "Form Builder"
                    }, React.createElement(Icon, { name: "edit", className: "w-5 h-5 shrink-0" }), " ", React.createElement("span", { className: `truncate ${!isSidebarOpen && 'hidden'}` }, "Form Builder")),
                    React.createElement("button", {
                        onClick: () => setTab('deleted-logs'),
                        className: `w-full flex items-center gap-3 px-4 py-2 text-xs hover:bg-white/10 border-l-4 transition-all duration-200 ${tab === 'deleted-logs' ? 'border-accent bg-white/10' : 'border-transparent'} ${!isSidebarOpen && 'justify-center px-0'}`,
                        title: "Deleted Logs"
                    }, React.createElement(Icon, { name: "trash", className: "w-5 h-5 shrink-0" }), " ", React.createElement("span", { className: `truncate ${!isSidebarOpen && 'hidden'}` }, "Deleted Logs"))
                )
            ), React.createElement("div", {
                className: "p-4 border-t border-primary/50 bg-primary-dark"
            }, React.createElement("button", {
                onClick: logout,
                className: `flex items-center justify-center gap-2 w-full py-1.5 bg-danger/90 hover:bg-danger rounded text-xs font-medium transition shadow-lg ${!isSidebarOpen && 'px-0'}`,
                title: "Logout"
            }, React.createElement(Icon, {
                name: "logout",
                className: "w-4 h-4"
            }), " ", React.createElement("span", {
                className: `${!isSidebarOpen && 'hidden'}`
            }, "Logout")))), React.createElement("div", {
                className: "flex-1 overflow-hidden relative flex flex-col w-full"
            }, !isSidebarOpen && React.createElement("button", {
                onClick: () => setIsSidebarOpen(true),
                className: "md:hidden fixed top-3 left-3 z-[60] bg-primary text-white p-2 rounded-full shadow-lg"
            }, React.createElement(Icon, { name: "menu", className: "w-5 h-5" })), React.createElement("div", {
                className: "flex-1 overflow-y-auto"
            }, renderContent())));
        };

        class CacheManager {
            static set(key, value, ttlMinutes = 60 * 24) { // Default 24 hours
                const item = {
                    value,
                    expiry: Date.now() + ttlMinutes * 60 * 1000,
                };
                try {
                    localStorage.setItem(key, JSON.stringify(item));
                } catch (e) { }
            }

            static get(key) {
                const itemStr = localStorage.getItem(key);
                if (!itemStr) return null;
                try {
                    const item = JSON.parse(itemStr);
                    if (Date.now() > item.expiry) {
                        localStorage.removeItem(key);
                        return null;
                    }
                    return item.value;
                } catch (e) {
                    return null;
                }
            }

            static remove(key) {
                localStorage.removeItem(key);
            }
        }
        const App = () => {
            const [user, setUser] = useState(null);
            const [appData, setAppData] = useState(null);
            const [loading, setLoading] = useState(true);
            const login = async (u, p) => {
                const res = await server.getAppDataPayload(u, p);
                if (res.success) {
                    setUser(res.user);
                    setAppData(res);
                    // ENABLED FOR PERSISTENT LOGIN:
                    CacheManager.set('css_user', res.user, 60 * 24 * 30); // 30 days
                    CacheManager.set('css_app_data', res, 60 * 24 * 30); // 30 days
                } else throw new Error(res.error);
            };
            const logout = () => {
                setUser(null);
                setAppData(null);
                CacheManager.remove('css_user');
                CacheManager.remove('css_app_data');
            };
            useEffect(() => {
                const cachedUser = CacheManager.get('css_user');
                const cachedData = CacheManager.get('css_app_data');

                if (cachedUser) {
                    setUser(cachedUser);
                    if (cachedData) {
                        setAppData(cachedData);
                        // Background refresh if needed, for now just trust cache
                    } else {
                        // If user defined but data missing, we might want to re-fetch
                        // For now strict re-login is safer if data is gone
                    }
                }
                setLoading(false);
            }, []);
            if (loading) return React.createElement("div", {
                className: "h-screen w-screen flex items-center justify-center bg-background"
            }, React.createElement("div", {
                className: "loader h-12 w-12 rounded-full border-4 border-t-4 border-gray-300"
            }));
            return React.createElement(AuthContext.Provider, {
                value: {
                    user,
                    login,
                    logout,
                    appData
                }
            }, React.createElement(PWAInstallProvider, null,
                React.createElement(InstallBanner, null),
                React.createElement(ToastProvider, null, user ? React.createElement(MainLayout, null) : React.createElement(Login, null))
            ));
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App, null));
    </script>

    <!-- Performance Optimization Scripts -->
    <script>
    // Preload critical resources
    function preloadCriticalResources() {
      const resources = [
        'https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js',
        'https://cdn.tailwindcss.com'
      ];

      resources.forEach(url => {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.as = 'script';
        link.href = url;
        document.head.appendChild(link);
      });
    }

    // Initialize preloading
    preloadCriticalResources();
    </script>
    
</body>

</html>